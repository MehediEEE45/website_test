<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéõÔ∏è Device Control Panel - Energy Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#14b8a6',
                        'dark-bg': '#0a0a0a',
                        'card-bg': '#1a1a1a',
                        'border-color': '#2a2a2a'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/auth.js"></script>
    <script>
        // Permission guard - require controlpanel.manage permission
        if (!AUTH.getCurrentUser()) {
            window.location.href = 'login.html';
        } else if (!AUTH.hasPermission('controlpanel.manage')) {
            window.location.href = 'access-denied.html';
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #0f0f0f 100%);
            color: #f3f4f6;
            min-height: 100vh;
        }
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #2a2a2a;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .status-badge {
            display: flex;
            align-items: center;
            padding: 6px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #3a3a3a;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 500;
            color: #9ca3af;
            transition: all 0.3s;
        }
        .status-badge:hover {
            border-color: #4a4a4a;
            background: rgba(255,255,255,0.08);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        .status-dot.online { background: #10b981; box-shadow: 0 0 8px rgba(16,185,129,0.5); }
        .status-dot.offline { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.5); }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }
        .card {
            background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 100%);
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            transition: all 0.4s ease;
            overflow: hidden;
        }
        .card:hover {
            border-color: #3a3a3a;
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .card-body { padding: 24px; }
        .card-yellow .card-header { border-left: 4px solid #eab308; }
        .card-teal .card-header { border-left: 4px solid #14b8a6; }
        .card-orange .card-header { border-left: 4px solid #f97316; }
        .card-pink .card-header { border-left: 4px solid #ec4899; }
        .card-purple .card-header { border-left: 4px solid #a855f7; }
        .card-red .card-header { border-left: 4px solid #ef4444; }
        .card-blue .card-header { border-left: 4px solid #3b82f6; }
        .icon-box {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid #2a2a2a;
            border-radius: 14px;
            transition: all 0.3s ease;
        }
        .device-item:hover {
            background: rgba(255,255,255,0.04);
            border-color: #3a3a3a;
        }
        .device-item.master {
            background: linear-gradient(135deg, rgba(234,179,8,0.1) 0%, rgba(234,179,8,0.05) 100%);
            border-color: rgba(234,179,8,0.3);
        }
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #3a3a3a;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.on {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            box-shadow: 0 4px 12px rgba(20,184,166,0.3);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .toggle-switch.on::after {
            transform: translateX(24px);
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 200px;
        }
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #3a3a3a;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(20,184,166,0.4);
            transition: transform 0.2s;
        }
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(20, 184, 166, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(20, 184, 166, 0.4);
        }
        .btn-secondary {
            background: #2a2a2a;
            color: #f3f4f6;
        }
        .btn-secondary:hover { background: #3a3a3a; }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(239, 68, 68, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid #3a3a3a;
            color: #9ca3af;
        }
        .btn-outline:hover {
            border-color: #4a4a4a;
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .gradient-text {
            background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 50%, #0d9488 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .scene-card {
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .scene-card:hover {
            background: rgba(255,255,255,0.05);
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }
        .scene-card.active {
            background: linear-gradient(135deg, rgba(20,184,166,0.15) 0%, rgba(20,184,166,0.05) 100%);
            border-color: rgba(20,184,166,0.4);
        }
        .scene-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 28px;
        }
        @media (max-width: 768px) {
            .header .container { flex-direction: column; gap: 16px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container" style="max-width:1400px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:20px;">
                <a href="index.html" style="padding:10px;border-radius:10px;color:#9ca3af;text-decoration:none;transition:all 0.3s;display:flex;align-items:center;gap:8px;" onmouseover="this.style.background='rgba(255,255,255,0.05)';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#9ca3af'">
                    <i data-lucide="arrow-left" style="width:20px;height:20px;"></i>
                    <span style="font-size:14px;font-weight:500;">Back to Dashboard</span>
                </a>
            </div>
            <div style="display:flex;align-items:center;gap:16px;">
                <span style="font-size:36px;">üéõÔ∏è</span>
                <div>
                    <h1 style="font-size:24px;font-weight:800;" class="gradient-text">Device Control Panel</h1>
                    <p style="font-size:13px;color:#6b7280;">Manage all connected devices</p>
                </div>
            </div>
            <div class="status-badge">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">ESP32 Offline</span>
                <button id="set-esp-control" class="btn btn-outline" style="margin-left:12px;padding:6px 8px;font-size:12px;">Set IP</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main style="max-width:1400px;margin:0 auto;padding:32px 24px;">
        <!-- Quick Stats -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px;">
            <div style="background:linear-gradient(135deg,rgba(234,179,8,0.15),rgba(234,179,8,0.05));border:1px solid rgba(234,179,8,0.3);border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                    <i data-lucide="lightbulb" style="width:20px;height:20px;color:#eab308;"></i>
                    <span style="font-size:12px;color:#eab308;font-weight:600;text-transform:uppercase;">Lights</span>
                </div>
                <p style="font-size:32px;font-weight:800;">0/6</p>
                <p style="font-size:12px;color:#6b7280;">Active</p>
            </div>
            <div style="background:linear-gradient(135deg,rgba(20,184,166,0.15),rgba(20,184,166,0.05));border:1px solid rgba(20,184,166,0.3);border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                    <i data-lucide="fan" style="width:20px;height:20px;color:#14b8a6;"></i>
                    <span style="font-size:12px;color:#14b8a6;font-weight:600;text-transform:uppercase;">Fans</span>
                </div>
                <p style="font-size:32px;font-weight:800;">0/4</p>
                <p style="font-size:12px;color:#6b7280;">Running</p>
            </div>
            <div style="background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(249,115,22,0.05));border:1px solid rgba(249,115,22,0.3);border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                    <i data-lucide="cog" style="width:20px;height:20px;color:#f97316;"></i>
                    <span style="font-size:12px;color:#f97316;font-weight:600;text-transform:uppercase;">Motors</span>
                </div>
                <p style="font-size:32px;font-weight:800;">0/3</p>
                <p style="font-size:12px;color:#6b7280;">Running</p>
            </div>
            <div style="background:linear-gradient(135deg,rgba(236,72,153,0.15),rgba(236,72,153,0.05));border:1px solid rgba(236,72,153,0.3);border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                    <i data-lucide="plug" style="width:20px;height:20px;color:#ec4899;"></i>
                    <span style="font-size:12px;color:#ec4899;font-weight:600;text-transform:uppercase;">Outlets</span>
                </div>
                <p style="font-size:32px;font-weight:800;">0/4</p>
                <p style="font-size:12px;color:#6b7280;">Powered</p>
            </div>
        </div>

        <!-- Controls Grid -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:24px;margin-bottom:32px;">
            <!-- Lighting Control -->
            <div class="card card-yellow">
                <div class="card-header">
                    <div class="icon-box" style="background:rgba(234,179,8,0.15);">
                        <i data-lucide="lightbulb" style="width:24px;height:24px;color:#eab308;"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;">Lighting Control</h3>
                        <p style="font-size:12px;color:#6b7280;">6 devices connected</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px;">
                        <div class="device-item master">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="sun" style="width:18px;height:18px;color:#eab308;"></i>
                                <div>
                                    <p style="font-weight:600;">Master Switch</p>
                                    <p style="font-size:11px;color:#6b7280;">All lights</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="lamp" style="width:18px;height:18px;color:#9ca3af;"></i>
                                <span style="font-weight:500;">Living Room</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="lamp" style="width:18px;height:18px;color:#9ca3af;"></i>
                                <span style="font-weight:500;">Bedroom</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="lamp" style="width:18px;height:18px;color:#9ca3af;"></i>
                                <span style="font-weight:500;">Kitchen</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="lamp" style="width:18px;height:18px;color:#9ca3af;"></i>
                                <span style="font-weight:500;">Bathroom</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="lamp" style="width:18px;height:18px;color:#9ca3af;"></i>
                                <span style="font-weight:500;">Outdoor</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fan Control -->
            <div class="card card-teal">
                <div class="card-header">
                    <div class="icon-box" style="background:rgba(20,184,166,0.15);">
                        <i data-lucide="fan" style="width:24px;height:24px;color:#14b8a6;"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;">Fan Control</h3>
                        <p style="font-size:12px;color:#6b7280;">4 devices with speed control</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px;">
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;min-width:120px;">
                                <i data-lucide="wind" style="width:18px;height:18px;color:#14b8a6;"></i>
                                <span style="font-weight:500;">Living Room</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" id="fan1">
                                <span style="min-width:40px;text-align:right;font-weight:600;font-size:14px;" id="fan1Val">0%</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;min-width:120px;">
                                <i data-lucide="wind" style="width:18px;height:18px;color:#14b8a6;"></i>
                                <span style="font-weight:500;">Bedroom</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" id="fan2">
                                <span style="min-width:40px;text-align:right;font-weight:600;font-size:14px;" id="fan2Val">0%</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;min-width:120px;">
                                <i data-lucide="wind" style="width:18px;height:18px;color:#14b8a6;"></i>
                                <span style="font-weight:500;">Kitchen</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" id="fan3">
                                <span style="min-width:40px;text-align:right;font-weight:600;font-size:14px;" id="fan3Val">0%</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;min-width:120px;">
                                <i data-lucide="wind" style="width:18px;height:18px;color:#14b8a6;"></i>
                                <span style="font-weight:500;">Exhaust</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" class="slider" min="0" max="100" value="0" id="fan4">
                                <span style="min-width:40px;text-align:right;font-weight:600;font-size:14px;" id="fan4Val">0%</span>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motors & Pumps -->
            <div class="card card-orange">
                <div class="card-header">
                    <div class="icon-box" style="background:rgba(249,115,22,0.15);">
                        <i data-lucide="cog" style="width:24px;height:24px;color:#f97316;"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;">Motors & Pumps</h3>
                        <p style="font-size:12px;color:#6b7280;">3 devices connected</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px;">
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="droplets" style="width:18px;height:18px;color:#f97316;"></i>
                                <div>
                                    <p style="font-weight:500;">Water Pump</p>
                                    <p style="font-size:11px;color:#6b7280;">750W ‚Ä¢ Main tank</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="sprout" style="width:18px;height:18px;color:#f97316;"></i>
                                <div>
                                    <p style="font-weight:500;">Garden Pump</p>
                                    <p style="font-size:11px;color:#6b7280;">350W ‚Ä¢ Irrigation</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="rotate-cw" style="width:18px;height:18px;color:#f97316;"></i>
                                <div>
                                    <p style="font-weight:500;">Garage Motor</p>
                                    <p style="font-size:11px;color:#6b7280;">500W ‚Ä¢ Gate control</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Outlets -->
            <div class="card card-pink">
                <div class="card-header">
                    <div class="icon-box" style="background:rgba(236,72,153,0.15);">
                        <i data-lucide="plug" style="width:24px;height:24px;color:#ec4899;"></i>
                    </div>
                    <div>
                        <h3 style="font-size:18px;font-weight:700;">Smart Outlets</h3>
                        <p style="font-size:12px;color:#6b7280;">4 outlets available</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:grid;gap:12px;">
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="tv" style="width:18px;height:18px;color:#ec4899;"></i>
                                <div>
                                    <p style="font-weight:500;">Entertainment</p>
                                    <p style="font-size:11px;color:#6b7280;">TV, Console, Sound</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="monitor" style="width:18px;height:18px;color:#ec4899;"></i>
                                <div>
                                    <p style="font-weight:500;">Workstation</p>
                                    <p style="font-size:11px;color:#6b7280;">PC, Monitor, Peripherals</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="coffee" style="width:18px;height:18px;color:#ec4899;"></i>
                                <div>
                                    <p style="font-weight:500;">Kitchen Appliances</p>
                                    <p style="font-size:11px;color:#6b7280;">Coffee, Toaster, Kettle</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                        <div class="device-item">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <i data-lucide="plug-zap" style="width:18px;height:18px;color:#ec4899;"></i>
                                <div>
                                    <p style="font-weight:500;">EV Charger</p>
                                    <p style="font-size:11px;color:#6b7280;">7.4kW Level 2</p>
                                </div>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Scenes -->
        <div class="card card-purple" style="margin-bottom:32px;">
            <div class="card-header">
                <div class="icon-box" style="background:rgba(168,85,247,0.15);">
                    <i data-lucide="sparkles" style="width:24px;height:24px;color:#a855f7;"></i>
                </div>
                <div>
                    <h3 style="font-size:18px;font-weight:700;">Smart Scenes</h3>
                    <p style="font-size:12px;color:#6b7280;">One-tap presets for common scenarios</p>
                </div>
            </div>
            <div class="card-body">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;">
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(59,130,246,0.15);">üåÖ</div>
                        <p style="font-weight:600;margin-bottom:4px;">Morning</p>
                        <p style="font-size:11px;color:#6b7280;">Wake up routine</p>
                    </div>
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(245,158,11,0.15);">‚òÄÔ∏è</div>
                        <p style="font-weight:600;margin-bottom:4px;">Day Mode</p>
                        <p style="font-size:11px;color:#6b7280;">All lights off</p>
                    </div>
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(139,92,246,0.15);">üåô</div>
                        <p style="font-weight:600;margin-bottom:4px;">Night Mode</p>
                        <p style="font-size:11px;color:#6b7280;">Dim lights</p>
                    </div>
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(236,72,153,0.15);">üé¨</div>
                        <p style="font-weight:600;margin-bottom:4px;">Movie</p>
                        <p style="font-size:11px;color:#6b7280;">Entertainment on</p>
                    </div>
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(16,185,129,0.15);">üåø</div>
                        <p style="font-weight:600;margin-bottom:4px;">Eco Mode</p>
                        <p style="font-size:11px;color:#6b7280;">Power saving</p>
                    </div>
                    <div class="scene-card" onclick="this.classList.toggle('active')">
                        <div class="scene-icon" style="background:rgba(239,68,68,0.15);">üö™</div>
                        <p style="font-weight:600;margin-bottom:4px;">Away</p>
                        <p style="font-size:11px;color:#6b7280;">All off</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Controls -->
        <div class="card card-red">
            <div class="card-header">
                <div class="icon-box" style="background:rgba(239,68,68,0.15);">
                    <i data-lucide="shield-alert" style="width:24px;height:24px;color:#ef4444;"></i>
                </div>
                <div>
                    <h3 style="font-size:18px;font-weight:700;">Emergency Controls</h3>
                    <p style="font-size:12px;color:#6b7280;">Safety overrides and system controls</p>
                </div>
            </div>
            <div class="card-body">
                <div style="display:flex;flex-wrap:wrap;gap:16px;">
                    <button class="btn btn-danger" onclick="if(confirm('Turn OFF all devices?')) alert('All devices turned OFF')">
                        <i data-lucide="power-off" style="width:18px;height:18px;"></i>
                        All OFF
                    </button>
                    <button class="btn btn-primary" onclick="if(confirm('Turn ON all devices?')) alert('All devices turned ON')">
                        <i data-lucide="power" style="width:18px;height:18px;"></i>
                        All ON
                    </button>
                    <button class="btn btn-outline">
                        <i data-lucide="refresh-cw" style="width:18px;height:18px;"></i>
                        Reset System
                    </button>
                    <button class="btn btn-outline">
                        <i data-lucide="wifi-off" style="width:18px;height:18px;"></i>
                        Reconnect ESP32
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer style="text-align:center;padding:28px;color:#6b7280;font-size:14px;border-top:1px solid #2a2a2a;">
        <p>üéõÔ∏è Device Control Panel ‚Ä¢ Smart Home Automation</p>
    </footer>

    <script>
        lucide.createIcons();

        // Fan slider value displays
        document.querySelectorAll('.slider').forEach(slider => {
            const valSpan = document.getElementById(slider.id + 'Val');
            if (valSpan) {
                slider.addEventListener('input', function() {
                    valSpan.textContent = this.value + '%';
                });
            }
        });
    </script>
    <script src="js/data-saver.js"></script>
    <script>
        // Wire up ESP32 polling for control panel
        (function(){
            const deviceId = 'control_panel_1';
            const espIp = '192.168.0.108'; // default IP for control panel ESP32
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            let pollHandle = null;
            function startPoll() {
                const stored = localStorage.getItem('esp_ip_control_panel_1');
                const ipToUse = (stored && stored.trim()) || espIp;
                if (pollHandle && pollHandle.stop) pollHandle.stop();
                pollHandle = DATA.setAutoPoll(ipToUse, deviceId, 5000, { maxRecords: 500 });
            }

            // allow setting IP via small prompt
            const setBtn = document.getElementById('set-esp-control');
            if (setBtn) setBtn.addEventListener('click', () => {
                const v = prompt('Enter ESP32 IP for Control Panel', localStorage.getItem('esp_ip_control_panel_1') || espIp || '');
                if (v && v.trim()) {
                    localStorage.setItem('esp_ip_control_panel_1', v.trim());
                    alert('ESP IP saved for control panel.');
                    startPoll();
                }
            });

            window.addEventListener('device-data-saved', (e) => {
                if (e.detail && e.detail.deviceId === deviceId) {
                    const { res } = e.detail;

                    const last = DATA.getRecent(deviceId, 1)[0];
                    const now = Date.now();
                    const RECENT_MS = 15000;
                    let isOnline = false;

                    if (res && res.success) {
                        isOnline = true;
                    } else if (last) {
                        const age = now - new Date(last.timestamp).getTime();
                        if (age <= RECENT_MS) isOnline = true;
                    }

                    if (isOnline) {
                        statusDot.className = 'status-dot online';
                        statusText.textContent = 'ESP32 Online';
                    } else {
                        statusDot.className = 'status-dot offline';
                        statusText.textContent = 'ESP32 Offline';
                    }
                }
            });

            startPoll();
        })();
    </script>
</body>
</html>
