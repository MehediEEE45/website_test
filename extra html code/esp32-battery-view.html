<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Battery Live View</title>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0b0d;color:#e6e6e9;margin:0;padding:20px}
    .card{background:#111116;border:1px solid #222226;padding:18px;border-radius:10px;max-width:720px;margin:18px auto}
    h1{color:#a855f7;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .stat{background:#0e0e12;padding:12px;border-radius:8px;text-align:center}
    .label{font-size:12px;color:#9ca3af}
    .value{font-size:20px;font-weight:700;color:#ffffff}
    pre{background:#060607;color:#d1d5db;padding:8px;border-radius:6px;overflow:auto}
    .status{float:right;font-size:13px;padding:6px 10px;border-radius:8px}
    .online{background:rgba(16,185,129,0.12);color:#10b981}
    .offline{background:rgba(239,68,68,0.08);color:#ef4444}
    .center{max-width:880px;margin:12px auto}
    @media(max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h1>ESP32 Battery Live View</h1>
      <div id="connStatus" class="status offline">Disconnected</div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="stat">
        <div class="label">Voltage (V)</div>
        <div id="voltage" class="value">—</div>
      </div>
      <div class="stat">
        <div class="label">Current (A)</div>
        <div id="current" class="value">—</div>
      </div>
      <div class="stat">
        <div class="label">Power (W)</div>
        <div id="power" class="value">—</div>
      </div>
      <div class="stat">
        <div class="label">SoC (%)</div>
        <div id="soc" class="value">—</div>
      </div>
      <div class="stat">
        <div class="label">SoH (%)</div>
        <div id="soh" class="value">—</div>
      </div>
      <div class="stat">
        <div class="label">Uptime (s)</div>
        <div id="uptime" class="value">—</div>
      </div>
    </div>

    <div style="margin-top:16px">
      <div style="font-size:13px;color:#9ca3af;margin-bottom:6px">Raw payload</div>
      <pre id="raw">-</pre>
    </div>
  </div>

  <div class="center">
    <p style="color:#9ca3af;font-size:13px">This page subscribes to the <code>battery/data</code> topic (default) and displays latest values from the ESP32.</p>
  </div>

  <script src="https://unpkg.com/mqtt@5.3.4/dist/mqtt.min.js"></script>
  <script>
    // Broker defaults (match project HiveMQ config)
    const BROKER = 'wss://0d34f5789e1e4a669367abfe5bd45b15.s1.eu.hivemq.cloud:8884/mqtt';
    const USER = 'battery';
    const PASS = 'Batterybms80';
    const TOPIC = 'battery/data';

    const statusEl = document.getElementById('connStatus');
    const setStatus = (connected)=>{
      if(connected){ statusEl.textContent='Connected'; statusEl.className='status online'; }
      else { statusEl.textContent='Disconnected'; statusEl.className='status offline'; }
    };

    function show(obj){
      document.getElementById('raw').textContent = JSON.stringify(obj, null, 2);
      // attempt common key names published by main.cpp
      if(obj.bus_V !== undefined) document.getElementById('voltage').textContent = obj.bus_V.toFixed(2);
      else if(obj.voltage !== undefined) document.getElementById('voltage').textContent = parseFloat(obj.voltage).toFixed(2);
      if(obj.current_A !== undefined) document.getElementById('current').textContent = obj.current_A.toFixed(3);
      else if(obj.current !== undefined) document.getElementById('current').textContent = parseFloat(obj.current).toFixed(3);
      if(obj.power_W !== undefined) document.getElementById('power').textContent = obj.power_W.toFixed(3);
      else if(obj.power !== undefined) document.getElementById('power').textContent = parseFloat(obj.power).toFixed(3);
      if(obj.soc_percent !== undefined) document.getElementById('soc').textContent = parseFloat(obj.soc_percent).toFixed(1);
      else if(obj.soc !== undefined) document.getElementById('soc').textContent = parseFloat(obj.soc).toFixed(1);
      if(obj.soh_percent !== undefined) document.getElementById('soh').textContent = parseFloat(obj.soh_percent).toFixed(1);
      else if(obj.soh !== undefined) document.getElementById('soh').textContent = parseFloat(obj.soh).toFixed(1);
      if(obj.uptime_ms !== undefined) document.getElementById('uptime').textContent = Math.floor(obj.uptime_ms/1000);
      else if(obj.uptime !== undefined) document.getElementById('uptime').textContent = Math.floor(obj.uptime/1000);
    }

    // Connect
    const clientId = 'esp-view-' + Math.random().toString(16).slice(2,8);
    const client = mqtt.connect(BROKER, { clientId, username: USER, password: PASS, keepalive: 60, clean: true });

    client.on('connect', () => {
      setStatus(true);
      client.subscribe(TOPIC, { qos: 1 }, (err) => {
        if(err) console.warn('subscribe err', err);
      });
    });

    client.on('reconnect', ()=> setStatus(false));
    client.on('offline', ()=> setStatus(false));
    client.on('close', ()=> setStatus(false));
    client.on('error', (e)=>{ console.error('MQTT err', e); setStatus(false); });

    client.on('message', (topic, message) => {
      try{
        const text = message.toString();
        let obj = {};
        try { obj = JSON.parse(text); } catch { obj = {value: text}; }
        show(obj);
      } catch(e){ console.error(e); }
    });
  </script>
</body>
</html>
