<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Health Monitor - Real-time Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#a855f7',
                        'dark-bg': '#0a0a0a',
                        'card-bg': '#1a1a1a',
                        'border-color': '#2a2a2a'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/mqtt-client.js"></script>
    <script>
        // Permission guard - require battery.view permission
        if (!AUTH.getCurrentUser()) {
            window.location.href = 'login.html';
        } else if (!AUTH.hasPermission('battery.view')) {
            window.location.href = 'access-denied.html';
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #f3f4f6;
            min-height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 80px;
            height: 100vh;
            background: #141414;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            z-index: 100;
        }
        .sidebar-item {
            width: 56px;
            height: 56px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6b7280;
            font-size: 10px;
            font-weight: 500;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .sidebar-item.active {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }
        .sidebar-item span { margin-top: 4px; }
        .main-content {
            margin-left: 80px;
            min-height: 100vh;
        }
        .header {
            height: 64px;
            background: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-connecting { background: #f59e0b; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }
        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .icon-green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .icon-yellow { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .icon-pink { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .icon-orange { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .icon-purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .icon-cyan { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        .icon-teal { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .chart-container {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active {
            display: block;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary {
            background: #2a2a2a;
            color: #f3f4f6;
        }
        .btn-secondary:hover { background: #3a3a3a; }
        .btn-danger { background: #ef4444; color: white; }
        .input-field {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 10px 16px;
            color: #f3f4f6;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #a855f7;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
        }
        .data-table th {
            color: #9ca3af;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                padding: 8px 16px;
                position: fixed;
                bottom: 0;
                top: auto;
                border-right: none;
                border-top: 1px solid #2a2a2a;
            }
            .sidebar-item {
                width: 48px;
                height: 48px;
                margin: 0 4px;
            }
            .main-content {
                margin-left: 0;
                margin-bottom: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-item active" onclick="switchTab('realtime')">
            <i data-lucide="monitor" style="width:20px;height:20px;"></i>
            <span>Real-time</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('history')">
            <i data-lucide="history" style="width:20px;height:20px;"></i>
            <span>History</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('analytics')">
            <i data-lucide="bar-chart-3" style="width:20px;height:20px;"></i>
            <span>Analytics</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('reports')">
            <i data-lucide="file-text" style="width:20px;height:20px;"></i>
            <span>Reports</span>
        </div>
        <div style="flex:1;"></div>
        <div class="sidebar-item" onclick="switchTab('settings')">
            <i data-lucide="settings" style="width:20px;height:20px;"></i>
            <span>Settings</span>
        </div>
        <div class="sidebar-item" onclick="window.location.href='index.html'">
            <i data-lucide="log-in" style="width:20px;height:20px;"></i>
            <span>Login</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div style="display:flex;align-items:center;gap:16px;">
                <a href="index.html" style="padding:8px;border-radius:8px;color:#9ca3af;text-decoration:none;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <i data-lucide="arrow-left" style="width:20px;height:20px;"></i>
                </a>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div class="status-indicator status-offline" id="statusIndicator"></div>
                    <div>
                        <p style="font-size:14px;font-weight:500;color:#ef4444;" id="statusText">System Offline</p>
                        <p style="font-size:12px;color:#9ca3af;" id="statusSubtext">Cannot reach ESP32</p>
                    </div>
                </div>
            </div>
            <!-- MQTT Diagnostics -->
            <div style="margin-top:24px;display:grid;grid-template-columns:1fr;gap:16px;">
                <div class="stat-card">
                    <h3 style="font-size:16px;font-weight:600;margin-bottom:8px;">MQTT Diagnostics (live)</h3>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;">
                        <div style="flex:1;min-width:260px;">
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:8px;">Raw payload</p>
                            <pre id="diagRawPayload" style="background:#0f0f0f;border:1px solid #262626;padding:12px;border-radius:8px;color:#d1d5db;max-height:120px;overflow:auto;">-</pre>
                        </div>
                        <div style="width:320px;min-width:220px;">
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:8px;">Interpreted fields</p>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                <div style="font-size:13px;color:#9ca3af">Signed Current</div>
                                <div id="diagSigned">-</div>
                                <div style="font-size:13px;color:#9ca3af">Magnitude</div>
                                <div id="diagMag">-</div>
                                <div style="font-size:13px;color:#9ca3af">Direction</div>
                                <div id="diagInterpreted">-</div>
                                <div style="font-size:13px;color:#9ca3af">Source</div>
                                <div id="diagSource">-</div>
                            </div>
                            <div style="margin-top:8px;font-size:12px;color:#9ca3af;">Charge Status: <span id="chargeStatus">Idle</span></div>
                            <div style="margin-top:4px;font-size:12px;color:#9ca3af;">Current Dir Badge: <span id="currentDir">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:28px;">ðŸ”‹</span>
                <h1 style="font-size:20px;font-weight:700;color:#a855f7;">Battery Health Monitor</h1>
            </div>
            <button style="padding:8px;background:transparent;border:none;color:#9ca3af;cursor:pointer;" onclick="switchTab('settings')">
                <i data-lucide="settings" style="width:20px;height:20px;"></i>
            </button>
        </header>

        <!-- Real-time Tab -->
        <div id="tab-realtime" class="tab-content active">
            <!-- Stats Grid -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px;">
                <!-- Voltage -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-blue">
                            <i data-lucide="zap" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Voltage</p>
                            <p style="font-size:32px;font-weight:700;" id="voltage">0.00</p>
                            <p style="font-size:12px;color:#9ca3af;">Volts (V)</p>
                        </div>
                    </div>
                </div>
                <!-- Current -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-green">
                            <i data-lucide="activity" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Current</p>
                            <p style="font-size:32px;font-weight:700;" id="current">0.00</p>
                            <p style="font-size:12px;color:#9ca3af;">Amps (A)</p>
                        </div>
                    </div>
                </div>
                <!-- State of Charge -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-yellow">
                            <i data-lucide="percent" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">State of Charge</p>
                            <p style="font-size:32px;font-weight:700;" id="soc">0</p>
                            <p style="font-size:12px;color:#9ca3af;">% SoC</p>
                        </div>
                    </div>
                </div>
                <!-- State of Health -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-pink">
                            <i data-lucide="heart-pulse" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">State of Health</p>
                            <p style="font-size:32px;font-weight:700;" id="soh">0</p>
                            <p style="font-size:12px;color:#9ca3af;">% SoH</p>
                        </div>
                    </div>
                </div>
                <!-- Temperature -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-orange">
                            <i data-lucide="thermometer" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Temperature</p>
                            <p style="font-size:32px;font-weight:700;" id="temperature">0.0</p>
                            <p style="font-size:12px;color:#9ca3af;">Â°C</p>
                        </div>
                    </div>
                </div>
                <!-- Internal Resistance -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-purple">
                            <i data-lucide="git-branch" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Internal Resistance</p>
                            <p style="font-size:32px;font-weight:700;" id="resistance">0</p>
                            <p style="font-size:12px;color:#9ca3af;">mÎ©</p>
                        </div>
                    </div>
                </div>
                <!-- Cycle Count -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-teal">
                            <i data-lucide="refresh-cw" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Cycle Count</p>
                            <p style="font-size:32px;font-weight:700;" id="cycles">0</p>
                            <p style="font-size:12px;color:#9ca3af;">cycles</p>
                        </div>
                    </div>
                </div>
                <!-- Capacity -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-cyan">
                            <i data-lucide="battery-charging" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Capacity</p>
                            <p style="font-size:32px;font-weight:700;" id="capacity">0.0</p>
                            <p style="font-size:12px;color:#9ca3af;">Ah</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;">
                <div class="chart-container">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <i data-lucide="bar-chart" style="width:20px;height:20px;color:#a855f7;"></i>
                        Voltage & Current Trends
                    </h3>
                    <canvas id="vcChart" height="150"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <i data-lucide="activity" style="width:20px;height:20px;color:#a855f7;"></i>
                        State of Charge History
                    </h3>
                    <canvas id="socChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div class="stat-card" style="margin-bottom:24px;">
                <h2 style="font-size:20px;font-weight:600;margin-bottom:16px;">Historical Data</h2>
                <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
                    <button class="btn btn-primary">Today</button>
                    <button class="btn btn-secondary">This Week</button>
                    <button class="btn btn-secondary">This Month</button>
                    <button class="btn btn-secondary">This Year</button>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <input type="date" class="input-field" style="width:auto;">
                    <input type="date" class="input-field" style="width:auto;">
                    <button class="btn btn-primary">Load Range</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Max Voltage</p>
                    <p style="font-size:24px;font-weight:700;">0 V</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Min Voltage</p>
                    <p style="font-size:24px;font-weight:700;">0 V</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Avg Temperature</p>
                    <p style="font-size:24px;font-weight:700;">0 Â°C</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Data Points</p>
                    <p style="font-size:24px;font-weight:700;">0</p>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Battery History</h3>
                <canvas id="historyChart" height="100"></canvas>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="tab-analytics" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Battery Analytics</h2>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px;">
                <div style="background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(139,92,246,0.2));border:1px solid rgba(168,85,247,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#a855f7;font-weight:500;margin-bottom:8px;">Battery Efficiency</p>
                    <p style="font-size:32px;font-weight:700;" id="efficiency">0</p>
                    <p style="font-size:12px;color:#9ca3af;">%</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(20,184,166,0.2));border:1px solid rgba(34,197,94,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#22c55e;font-weight:500;margin-bottom:8px;">Estimated Lifespan</p>
                    <p style="font-size:32px;font-weight:700;" id="lifespan">0</p>
                    <p style="font-size:12px;color:#9ca3af;">years remaining</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(99,102,241,0.2));border:1px solid rgba(59,130,246,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#3b82f6;font-weight:500;margin-bottom:8px;">Total Energy Stored</p>
                    <p style="font-size:32px;font-weight:700;" id="totalEnergy">0</p>
                    <p style="font-size:12px;color:#9ca3af;">kWh</p>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Weekly Charge/Discharge Cycles</h3>
                <canvas id="weeklyChart" height="100"></canvas>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="tab-reports" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Battery Health Reports</h2>
            <div class="stat-card" style="margin-bottom:24px;">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Generate Report</h3>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <button class="btn btn-primary">Daily Report</button>
                    <button class="btn btn-secondary">Weekly Report</button>
                    <button class="btn btn-secondary">Monthly Report</button>
                    <button class="btn btn-secondary">Annual Report</button>
                </div>
            </div>
            <div class="stat-card">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Export Report</h3>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <button class="btn btn-primary">
                        <i data-lucide="download" style="width:16px;height:16px;margin-right:8px;"></i>
                        Download CSV
                    </button>
                    <button class="btn btn-secondary">
                        <i data-lucide="file-text" style="width:16px;height:16px;margin-right:8px;"></i>
                        Download TXT
                    </button>
                    <button class="btn btn-primary">
                        <i data-lucide="mail" style="width:16px;height:16px;margin-right:8px;"></i>
                        Email Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Settings</h2>
            <div style="max-width:600px;">
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:12px;">MQTT Protocol</h3>
                    <div style="font-size:13px;color:#9ca3af;line-height:1.5;margin-bottom:8px;">
                        <div>Subscribe to: <strong>energy/battery/&lt;deviceId&gt;/telemetry</strong></div>
                        <div>Payload (JSON): <code>{ voltage, current, current_signed, direction, power, soc, soh, temperature, resistance, capacity, cycles }</code></div>
                        <div style="margin-top:6px;">Notes: prefer <strong>direction</strong> or <strong>current_signed</strong> for charging state.</div>
                    </div>
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">ESP32 Configuration</h3>
                    <div style="margin-bottom:16px;">
                        <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">ESP32 IP Address</label>
                        <input type="text" class="input-field" id="esp32Ip" value="192.168.0.103" placeholder="192.168.0.103">
                        <p style="font-size:12px;color:#9ca3af;margin-top:4px;">Current: <span id="currentEspIp">192.168.0.103</span></p>
                    </div>
                    <button id="save-esp-battery" class="btn btn-primary">Update IP Address</button>
                </div>
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Alert Thresholds</h3>
                    <div style="display:grid;gap:16px;">
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">Low Voltage Alert (V)</label>
                            <input type="number" class="input-field" value="10.5" step="0.1">
                        </div>
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">High Temperature Alert (Â°C)</label>
                            <input type="number" class="input-field" value="45" step="1">
                        </div>
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">Low SoC Alert (%)</label>
                            <input type="number" class="input-field" value="20" step="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top:16px;">Save Thresholds</button>
                </div>
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Data Management</h3>
                    <button class="btn btn-danger">Clear All Data</button>
                    <p style="font-size:12px;color:#9ca3af;margin-top:8px;">This will delete all stored battery data from your browser.</p>
                </div>
                <div class="stat-card">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">System Information</h3>
                    <div style="font-size:14px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">Version:</span>
                            <span>1.0.0</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">ESP32 IP:</span>
                            <span>192.168.0.103</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">Last Updated:</span>
                            <span>--</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:#9ca3af;">Data Points Stored:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer style="text-align:center;padding:24px;color:#6b7280;font-size:14px;border-top:1px solid #2a2a2a;">
            Battery data monitoring system â€¢ Real-time analytics and reporting
        </footer>
    </div>

    <script>
        lucide.createIcons();

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
            lucide.createIcons();
        }

        // Initialize Charts
        const vcCtx = document.getElementById('vcChart').getContext('2d');
        new Chart(vcCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                    { label: 'Voltage (V)', data: [12.4, 12.3, 12.1, 12.6, 12.8, 12.5, 12.4], borderColor: '#3b82f6', tension: 0.4, fill: false },
                    { label: 'Current (A)', data: [0, 0.5, 2.1, -1.5, -0.8, 0.2, 0], borderColor: '#22c55e', tension: 0.4, fill: false }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#9ca3af' } } },
                scales: {
                    x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } },
                    y: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }
                }
            }
        });

        const socCtx = document.getElementById('socChart').getContext('2d');
        new Chart(socCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [{
                    label: 'SoC (%)',
                    data: [85, 80, 65, 75, 90, 88, 85],
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#9ca3af' } } },
                scales: {
                    x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } },
                    y: { beginAtZero: true, max: 100, ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }
                }
            }
        });

        const histCtx = document.getElementById('historyChart').getContext('2d');
        new Chart(histCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Voltage (V)', data: [], borderColor: '#a855f7', fill: true, backgroundColor: 'rgba(168,85,247,0.1)', tension: 0.4 }] },
            options: { responsive: true, plugins: { legend: { labels: { color: '#9ca3af' } } }, scales: { x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }, y: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } } } }
        });

        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    { label: 'Charge Cycles', data: [2, 1, 2, 1, 2, 1, 1], backgroundColor: 'rgba(168, 85, 247, 0.7)', borderColor: '#a855f7', borderWidth: 2, borderRadius: 4 },
                    { label: 'Discharge Cycles', data: [2, 1, 2, 1, 2, 1, 1], backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: '#22c55e', borderWidth: 2, borderRadius: 4 }
                ]
            },
            options: { responsive: true, plugins: { legend: { labels: { color: '#9ca3af' } } }, scales: { x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }, y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } } } }
        });
    </script>
    <script src="js/data-saver.js"></script>
    <script>
        // Wire up ESP32 polling and storage for battery monitor
        (function(){
            const deviceId = '1';
            const deviceKey = `battery_${deviceId}`;
            const ipInput = document.getElementById('esp32Ip');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusSubtext = document.getElementById('statusSubtext');

            let pollHandle = null;
            function startPoll() {
                const storedIp = localStorage.getItem(`esp_ip_${deviceKey}`);
                const ip = (storedIp && storedIp.trim()) || (ipInput && ipInput.value && ipInput.value.trim());
                if (!ip) {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'System Offline';
                    statusText.style.color = '#ef4444';
                    statusSubtext.textContent = 'No IP configured';
                    return;
                }
                if (pollHandle && pollHandle.stop) pollHandle.stop();
                pollHandle = DATA.setAutoPoll(ip, deviceKey, 6000, { maxRecords: 1000 });
            }

            // Save ESP IP to localStorage
            const saveBtn = document.getElementById('save-esp-battery');
            if (saveBtn) saveBtn.addEventListener('click', () => {
                const ip = ipInput.value && ipInput.value.trim();
                if (!ip) { alert('Please enter the ESP32 IP address first.'); return; }
                localStorage.setItem(`esp_ip_${deviceKey}`, ip);
                document.getElementById('currentEspIp').textContent = ip;
                startPoll();
                alert('ESP IP saved.');
            });

            window.addEventListener('device-data-saved', (e) => {
                if (e.detail && e.detail.deviceId === deviceKey) {
                    const { res } = e.detail;

                    const last = DATA.getRecent(deviceKey, 1)[0];
                    const now = Date.now();
                    const RECENT_MS = 18000;
                    let isOnline = false;

                    if (res && res.success) {
                        isOnline = true;
                    } else if (last) {
                        const age = now - new Date(last.timestamp).getTime();
                        if (age <= RECENT_MS) isOnline = true;
                    }

                    if (isOnline) {
                        statusIndicator.className = 'status-indicator status-online';
                        statusText.textContent = 'System Online';
                        statusText.style.color = '#10b981';
                        if (res && res.success) {
                            statusSubtext.textContent = `Last polled ${new Date().toLocaleTimeString()} (saved)`;
                        } else if (last) {
                            statusSubtext.textContent = `Showing last saved at ${new Date(last.timestamp).toLocaleTimeString()}`;
                        }
                        
                        // Update UI values from the most recent payload
                        if (last && last.payload) {
                            updateUIFromTelemetry(last.payload, 'http');
                        }
                    } else {
                        statusIndicator.className = 'status-indicator status-offline';
                        statusText.textContent = 'System Offline';
                        statusText.style.color = '#ef4444';
                        statusSubtext.textContent = `${res && res.error ? 'Cannot reach ESP32 â€” ' + res.error : 'Cannot reach ESP32 â€” No response'}`;
                    }
                }
            });

            startPoll();
            if (ipInput) ipInput.addEventListener('change', () => startPoll());

            // =====================================================
            // MQTT Integration for real-time battery telemetry
            // =====================================================
            (async function initMQTT() {
                const cfg = MQTT_CLIENT.loadConfig();
                if (!cfg.brokerUrl) return;

                try {
                    await MQTT_CLIENT.connect();
                    MQTT_CLIENT.subscribe('energy/battery/+/telemetry', (topic, payload) => {
                        console.log('[MQTT] Battery telemetry:', payload);
                        updateUIFromTelemetry(payload, 'mqtt');
                    });
                } catch (err) {
                    console.warn('[MQTT] Connection failed:', err.message);
                }
            })();

            window.addEventListener('mqtt-telemetry', (e) => {
                if (e.detail && e.detail.type === 'battery') {
                    updateUIFromTelemetry(e.detail.payload, 'mqtt');
                }
            });

            function updateUIFromTelemetry(payload, source) {
                if (!payload || typeof payload !== 'object') return;
                const rawEl = document.getElementById('diagRawPayload');
                try { if (rawEl) rawEl.textContent = JSON.stringify(payload, null, 2); } catch (e) { if (rawEl) rawEl.textContent = String(payload); }

                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'System Online';
                statusText.style.color = '#10b981';
                statusSubtext.textContent = `Live via ${source.toUpperCase()} â€¢ ${new Date().toLocaleTimeString()}`;

                // Update metric displays (use correct element IDs from the HTML)
                if (payload.voltage !== undefined) {
                    const el = document.getElementById('voltage');
                    if (el) el.textContent = parseFloat(payload.voltage).toFixed(2);
                }
                if (payload.current !== undefined) {
                    const el = document.getElementById('current');
                    if (el) el.textContent = parseFloat(payload.current).toFixed(2);
                }
                if (payload.power !== undefined) {
                    // Calculate capacity approximation from power if available
                    const capEl = document.getElementById('capacity');
                    if (capEl && payload.voltage > 0) {
                        const ah = (payload.power / payload.voltage);
                        capEl.textContent = ah.toFixed(1);
                    }
                }
                if (payload.soc !== undefined) {
                    const el = document.getElementById('soc');
                    if (el) el.textContent = parseFloat(payload.soc).toFixed(0);
                }
                if (payload.soh !== undefined) {
                    const el = document.getElementById('soh');
                    if (el) el.textContent = parseFloat(payload.soh).toFixed(0);
                }
                if (payload.temperature !== undefined) {
                    const el = document.getElementById('temperature');
                    if (el) el.textContent = parseFloat(payload.temperature).toFixed(1);
                }
                if (payload.resistance !== undefined) {
                    const el = document.getElementById('resistance');
                    if (el) el.textContent = parseInt(payload.resistance);
                }
                if (payload.capacity !== undefined) {
                    const el = document.getElementById('capacity');
                    if (el) el.textContent = parseFloat(payload.capacity).toFixed(1);
                }
                if (payload.cycles !== undefined) {
                    const el = document.getElementById('cycles');
                    if (el) el.textContent = parseInt(payload.cycles);
                }
            }
        })();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Health Monitor - Real-time Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#a855f7',
                        'dark-bg': '#0a0a0a',
                        'card-bg': '#1a1a1a',
                        'border-color': '#2a2a2a'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/mqtt-client.js"></script>
    <script>
        // Permission guard - require battery.view permission
        if (!AUTH.getCurrentUser()) {
            window.location.href = 'login.html';
        } else if (!AUTH.hasPermission('battery.view')) {
            window.location.href = 'access-denied.html';
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #f3f4f6;
            min-height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 80px;
            height: 100vh;
            background: #141414;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            z-index: 100;
        }
        .sidebar-item {
            width: 56px;
            height: 56px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6b7280;
            font-size: 10px;
            font-weight: 500;
        }
        .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .sidebar-item.active {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }
        .sidebar-item span { margin-top: 4px; }
        .main-content {
            margin-left: 80px;
            min-height: 100vh;
        }
        .header {
            height: 64px;
            background: #0a0a0a;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-connecting { background: #f59e0b; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }
        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .icon-green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .icon-yellow { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .icon-pink { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .icon-orange { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .icon-purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .icon-cyan { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        .icon-teal { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .chart-container {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active {
            display: block;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary {
            background: #2a2a2a;
            color: #f3f4f6;
        }
        .btn-secondary:hover { background: #3a3a3a; }
        .btn-danger { background: #ef4444; color: white; }
        .input-field {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 10px 16px;
            color: #f3f4f6;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #a855f7;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
        }
        .data-table th {
            color: #9ca3af;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
                padding: 8px 16px;
                position: fixed;
                bottom: 0;
                top: auto;
                border-right: none;
                border-top: 1px solid #2a2a2a;
            }
            .sidebar-item {
                width: 48px;
                height: 48px;
                margin: 0 4px;
            }
            .main-content {
                margin-left: 0;
                margin-bottom: 70px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-item active" onclick="switchTab('realtime')">
            <i data-lucide="monitor" style="width:20px;height:20px;"></i>
            <span>Real-time</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('history')">
            <i data-lucide="history" style="width:20px;height:20px;"></i>
            <span>History</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('analytics')">
            <i data-lucide="bar-chart-3" style="width:20px;height:20px;"></i>
            <span>Analytics</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('reports')">
            <i data-lucide="file-text" style="width:20px;height:20px;"></i>
            <span>Reports</span>
        </div>
        <div style="flex:1;"></div>
        <div class="sidebar-item" onclick="switchTab('settings')">
            <i data-lucide="settings" style="width:20px;height:20px;"></i>
            <span>Settings</span>
        </div>
        <div class="sidebar-item" onclick="window.location.href='index.html'">
            <i data-lucide="log-in" style="width:20px;height:20px;"></i>
            <span>Login</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div style="display:flex;align-items:center;gap:16px;">
                <a href="index.html" style="padding:8px;border-radius:8px;color:#9ca3af;text-decoration:none;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <i data-lucide="arrow-left" style="width:20px;height:20px;"></i>
                </a>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div class="status-indicator status-offline" id="statusIndicator"></div>
                    <div>
                        <p style="font-size:14px;font-weight:500;color:#ef4444;" id="statusText">System Offline</p>
                        <p style="font-size:12px;color:#9ca3af;" id="statusSubtext">Cannot reach ESP32</p>
                        <p id="chargeStatus" style="font-size:12px;font-weight:600;margin-top:4px;color:#9ca3af;">Idle</p>
                    </div>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:28px;">ðŸ”‹</span>
                <h1 style="font-size:20px;font-weight:700;color:#a855f7;">Battery Health Monitor</h1>
            </div>
            <button style="padding:8px;background:transparent;border:none;color:#9ca3af;cursor:pointer;" onclick="switchTab('settings')">
                <i data-lucide="settings" style="width:20px;height:20px;"></i>
            </button>
        </header>

        <!-- Real-time Tab -->
        <div id="tab-realtime" class="tab-content active">
            <!-- Stats Grid -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px;">
                <!-- Voltage -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-blue">
                            <i data-lucide="zap" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Voltage</p>
                            <p style="font-size:32px;font-weight:700;" id="voltage">0.00</p>
                            <p style="font-size:12px;color:#9ca3af;">Volts (V)</p>
                        </div>
                    </div>
                </div>
                <!-- Current -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                                <div class="icon-box icon-green">
                            <i data-lucide="activity" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Current</p>
                            <p style="font-size:32px;font-weight:700;display:flex;align-items:center;gap:10px;" id="currentWrap">
                                <span id="current">0.00</span>
                                <span id="currentDir" style="font-size:12px;font-weight:600;padding:4px 8px;border-radius:8px;color:#9ca3af;background:transparent;">Idle</span>
                            </p>
                            <p style="font-size:12px;color:#9ca3af;">Amps (A)</p>
                        </div>
                    </div>
                </div>
                <!-- State of Charge -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-yellow">
                            <i data-lucide="percent" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">State of Charge</p>
                            <p style="font-size:32px;font-weight:700;" id="soc">0</p>
                            <p style="font-size:12px;color:#9ca3af;">% SoC</p>
                        </div>
                    </div>
                </div>
                <!-- State of Health -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-pink">
                            <i data-lucide="heart-pulse" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">State of Health</p>
                            <p style="font-size:32px;font-weight:700;" id="soh">0</p>
                            <p style="font-size:12px;color:#9ca3af;">% SoH</p>
                        </div>
                    </div>
                </div>
                <!-- Temperature -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-orange">
                            <i data-lucide="thermometer" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Temperature</p>
                            <p style="font-size:32px;font-weight:700;" id="temperature">0.0</p>
                            <p style="font-size:12px;color:#9ca3af;">Â°C</p>
                        </div>
                    </div>
                </div>
                <!-- Internal Resistance -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-purple">
                            <i data-lucide="git-branch" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Internal Resistance</p>
                            <p style="font-size:32px;font-weight:700;" id="resistance">0</p>
                            <p style="font-size:12px;color:#9ca3af;">mÎ©</p>
                        </div>
                    </div>
                </div>
                <!-- Cycle Count -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-teal">
                            <i data-lucide="refresh-cw" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Cycle Count</p>
                            <p style="font-size:32px;font-weight:700;" id="cycles">0</p>
                            <p style="font-size:12px;color:#9ca3af;">cycles</p>
                        </div>
                    </div>
                </div>
                <!-- Capacity -->
                <div class="stat-card">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div class="icon-box icon-cyan">
                            <i data-lucide="battery-charging" style="width:24px;height:24px;"></i>
                        </div>
                        <div>
                            <p style="font-size:12px;color:#9ca3af;margin-bottom:4px;">Capacity</p>
                            <p style="font-size:32px;font-weight:700;" id="capacity">0.0</p>
                            <p style="font-size:12px;color:#9ca3af;">Ah</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;">
                <div class="chart-container">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <i data-lucide="bar-chart" style="width:20px;height:20px;color:#a855f7;"></i>
                        Voltage & Current Trends
                    </h3>
                    <canvas id="vcChart" height="150"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <i data-lucide="activity" style="width:20px;height:20px;color:#a855f7;"></i>
                        State of Charge History
                    </h3>
                    <canvas id="socChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div class="stat-card" style="margin-bottom:24px;">
                <h2 style="font-size:20px;font-weight:600;margin-bottom:16px;">Historical Data</h2>
                <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
                    <button class="btn btn-primary">Today</button>
                    <button class="btn btn-secondary">This Week</button>
                    <button class="btn btn-secondary">This Month</button>
                    <button class="btn btn-secondary">This Year</button>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <input type="date" class="input-field" style="width:auto;">
                    <input type="date" class="input-field" style="width:auto;">
                    <button class="btn btn-primary">Load Range</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Max Voltage</p>
                    <p style="font-size:24px;font-weight:700;">0 V</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Min Voltage</p>
                    <p style="font-size:24px;font-weight:700;">0 V</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Avg Temperature</p>
                    <p style="font-size:24px;font-weight:700;">0 Â°C</p>
                </div>
                <div class="stat-card">
                    <p style="font-size:12px;color:#9ca3af;">Data Points</p>
                    <p style="font-size:24px;font-weight:700;">0</p>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Battery History</h3>
                <canvas id="historyChart" height="100"></canvas>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="tab-analytics" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Battery Analytics</h2>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px;">
                <div style="background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(139,92,246,0.2));border:1px solid rgba(168,85,247,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#a855f7;font-weight:500;margin-bottom:8px;">Battery Efficiency</p>
                    <p style="font-size:32px;font-weight:700;" id="efficiency">0</p>
                    <p style="font-size:12px;color:#9ca3af;">%</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(20,184,166,0.2));border:1px solid rgba(34,197,94,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#22c55e;font-weight:500;margin-bottom:8px;">Estimated Lifespan</p>
                    <p style="font-size:32px;font-weight:700;" id="lifespan">0</p>
                    <p style="font-size:12px;color:#9ca3af;">years remaining</p>
                </div>
                <div style="background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(99,102,241,0.2));border:1px solid rgba(59,130,246,0.5);border-radius:16px;padding:24px;">
                    <p style="font-size:12px;color:#3b82f6;font-weight:500;margin-bottom:8px;">Total Energy Stored</p>
                    <p style="font-size:32px;font-weight:700;" id="totalEnergy">0</p>
                    <p style="font-size:12px;color:#9ca3af;">kWh</p>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Weekly Charge/Discharge Cycles</h3>
                <canvas id="weeklyChart" height="100"></canvas>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="tab-reports" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Battery Health Reports</h2>
            <div class="stat-card" style="margin-bottom:24px;">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Generate Report</h3>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <button class="btn btn-primary">Daily Report</button>
                    <button class="btn btn-secondary">Weekly Report</button>
                    <button class="btn btn-secondary">Monthly Report</button>
                    <button class="btn btn-secondary">Annual Report</button>
                </div>
            </div>
            <div class="stat-card">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Export Report</h3>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <button class="btn btn-primary">
                        <i data-lucide="download" style="width:16px;height:16px;margin-right:8px;"></i>
                        Download CSV
                    </button>
                    <button class="btn btn-secondary">
                        <i data-lucide="file-text" style="width:16px;height:16px;margin-right:8px;"></i>
                        Download TXT
                    </button>
                    <button class="btn btn-primary">
                        <i data-lucide="mail" style="width:16px;height:16px;margin-right:8px;"></i>
                        Email Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;">Settings</h2>
            <div style="max-width:600px;">
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">ESP32 Configuration</h3>
                    <div style="margin-bottom:16px;">
                        <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">ESP32 IP Address</label>
                        <input type="text" class="input-field" id="esp32Ip" value="192.168.0.103" placeholder="192.168.0.103">
                        <p style="font-size:12px;color:#9ca3af;margin-top:4px;">Current: <span id="currentEspIp">192.168.0.103</span></p>
                    </div>
                    <button id="save-esp-battery" class="btn btn-primary">Update IP Address</button>
                    <div style="margin-top:12px;">
                        <label style="font-size:14px;color:#9ca3af;display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="invertCurrentSign"> <span>Invert current sign (flip charging/discharging)</span>
                        </label>
                        <p style="font-size:12px;color:#9ca3af;margin-top:6px;">Use this if the dashboard shows Charging when the battery is actually discharging (or vice versa).</p>

                        <!-- Diagnostics -->
                        <div style="margin-top:10px;padding:10px;background:#0f1724;border-radius:8px;border:1px solid #1f2937;color:#9ca3af;font-size:13px;">
                            <div>Raw signed current: <span id="diagSigned">-</span> A</div>
                            <div>Magnitude (current): <span id="diagMag">-</span> A</div>
                            <div>Source: <span id="diagSource">-</span></div>
                            <div>Interpreted: <span id="diagInterpreted">Idle</span></div>
                        </div>
                    </div>
                </div>
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Alert Thresholds</h3>
                    <div style="display:grid;gap:16px;">
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">Low Voltage Alert (V)</label>
                            <input type="number" class="input-field" value="10.5" step="0.1">
                        </div>
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">High Temperature Alert (Â°C)</label>
                            <input type="number" class="input-field" value="45" step="1">
                        </div>
                        <div>
                            <label style="font-size:14px;color:#9ca3af;display:block;margin-bottom:8px;">Low SoC Alert (%)</label>
                            <input type="number" class="input-field" value="20" step="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top:16px;">Save Thresholds</button>
                </div>
                <div class="stat-card" style="margin-bottom:24px;">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Data Management</h3>
                    <button class="btn btn-danger">Clear All Data</button>
                    <p style="font-size:12px;color:#9ca3af;margin-top:8px;">This will delete all stored battery data from your browser.</p>
                </div>
                <div class="stat-card">
                    <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">System Information</h3>
                    <div style="font-size:14px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">Version:</span>
                            <span>1.0.0</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">ESP32 IP:</span>
                            <span>192.168.0.103</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#9ca3af;">Last Updated:</span>
                            <span>--</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:#9ca3af;">Data Points Stored:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer style="text-align:center;padding:24px;color:#6b7280;font-size:14px;border-top:1px solid #2a2a2a;">
            Battery data monitoring system â€¢ Real-time analytics and reporting
        </footer>
    </div>

    <script>
        lucide.createIcons();

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
            lucide.createIcons();
        }

        // Initialize Charts
        const vcCtx = document.getElementById('vcChart').getContext('2d');
        new Chart(vcCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                    { label: 'Voltage (V)', data: [12.4, 12.3, 12.1, 12.6, 12.8, 12.5, 12.4], borderColor: '#3b82f6', tension: 0.4, fill: false },
                    { label: 'Current (A)', data: [0, 0.5, 2.1, -1.5, -0.8, 0.2, 0], borderColor: '#22c55e', tension: 0.4, fill: false }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#9ca3af' } } },
                scales: {
                    x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } },
                    y: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }
                }
            }
        });

        const socCtx = document.getElementById('socChart').getContext('2d');
        new Chart(socCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [{
                    label: 'SoC (%)',
                    data: [85, 80, 65, 75, 90, 88, 85],
                    borderColor: '#a855f7',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#9ca3af' } } },
                scales: {
                    x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } },
                    y: { beginAtZero: true, max: 100, ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }
                }
            }
        });

        const histCtx = document.getElementById('historyChart').getContext('2d');
        new Chart(histCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Voltage (V)', data: [], borderColor: '#a855f7', fill: true, backgroundColor: 'rgba(168,85,247,0.1)', tension: 0.4 }] },
            options: { responsive: true, plugins: { legend: { labels: { color: '#9ca3af' } } }, scales: { x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }, y: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } } } }
        });

        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    { label: 'Charge Cycles', data: [2, 1, 2, 1, 2, 1, 1], backgroundColor: 'rgba(168, 85, 247, 0.7)', borderColor: '#a855f7', borderWidth: 2, borderRadius: 4 },
                    { label: 'Discharge Cycles', data: [2, 1, 2, 1, 2, 1, 1], backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: '#22c55e', borderWidth: 2, borderRadius: 4 }
                ]
            },
            options: { responsive: true, plugins: { legend: { labels: { color: '#9ca3af' } } }, scales: { x: { ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } }, y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: '#2a2a2a' } } } }
        });
    </script>
    <script src="js/data-saver.js"></script>
    <script>
        // Wire up ESP32 polling and storage for battery monitor
        (function(){
            const deviceId = 'battery_1';
            const ipInput = document.getElementById('esp32Ip');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusSubtext = document.getElementById('statusSubtext');

            let pollHandle = null;
            function startPoll() {
                const storedIp = localStorage.getItem('esp_ip_battery_1');
                const ip = (storedIp && storedIp.trim()) || (ipInput && ipInput.value && ipInput.value.trim());
                if (!ip) {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'System Offline';
                    statusText.style.color = '#ef4444';
                    statusSubtext.textContent = 'No IP configured';
                    return;
                }
                if (pollHandle && pollHandle.stop) pollHandle.stop();
                pollHandle = DATA.setAutoPoll(ip, deviceId, 6000, { maxRecords: 1000 });
            }

            // Save ESP IP to localStorage
            const saveBtn = document.getElementById('save-esp-battery');
            if (saveBtn) saveBtn.addEventListener('click', () => {
                const ip = ipInput.value && ipInput.value.trim();
                if (!ip) { alert('Please enter the ESP32 IP address first.'); return; }
                localStorage.setItem('esp_ip_battery_1', ip);
                document.getElementById('currentEspIp').textContent = ip;
                startPoll();
                alert('ESP IP saved.');
            });

            window.addEventListener('device-data-saved', (e) => {
                if (e.detail && e.detail.deviceId === deviceId) {
                    const { res } = e.detail;

                    const last = DATA.getRecent(deviceId, 1)[0];
                    const now = Date.now();
                    const RECENT_MS = 18000;
                    let isOnline = false;

                    if (res && res.success) {
                        isOnline = true;
                    } else if (last) {
                        const age = now - new Date(last.timestamp).getTime();
                        if (age <= RECENT_MS) isOnline = true;
                    }

                    if (isOnline) {
                        statusIndicator.className = 'status-indicator status-online';
                        statusText.textContent = 'System Online';
                        statusText.style.color = '#10b981';
                        if (res && res.success) {
                            statusSubtext.textContent = `Last polled ${new Date().toLocaleTimeString()} (saved)`;
                        } else if (last) {
                            statusSubtext.textContent = `Showing last saved at ${new Date(last.timestamp).toLocaleTimeString()}`;
                        }
                        
                        // Update UI values from the most recent payload
                        if (last && last.payload) {
                            updateUIFromTelemetry(last.payload, 'http');
                        }
                    } else {
                        statusIndicator.className = 'status-indicator status-offline';
                        statusText.textContent = 'System Offline';
                        statusText.style.color = '#ef4444';
                        statusSubtext.textContent = `${res && res.error ? 'Cannot reach ESP32 â€” ' + res.error : 'Cannot reach ESP32 â€” No response'}`;
                    }
                }
            });

            startPoll();
            if (ipInput) ipInput.addEventListener('change', () => startPoll());

            // Initialize invert current sign setting
            (function(){
                const cb = document.getElementById('invertCurrentSign');
                try {
                    if (cb) {
                        // Default to disabled so positive current displays as Charging
                        if (localStorage.getItem('invert_current_sign') === null) {
                            localStorage.setItem('invert_current_sign', '0');
                        }
                        cb.checked = localStorage.getItem('invert_current_sign') === '1';
                        cb.addEventListener('change', () => {
                            localStorage.setItem('invert_current_sign', cb.checked ? '1' : '0');
                            alert('Invert current sign ' + (cb.checked ? 'ENABLED' : 'DISABLED'));
                        });
                    }
                } catch (e) { console.warn('Error initializing invert setting', e); }
            })();

            // =====================================================
            // MQTT Integration for real-time battery telemetry
            // =====================================================
            (async function initMQTT() {
                const cfg = MQTT_CLIENT.loadConfig();
                if (!cfg.brokerUrl) return;

                try {
                    await MQTT_CLIENT.connect();
                    MQTT_CLIENT.subscribe('energy/battery/+/telemetry', (topic, payload) => {
                        console.log('[MQTT] Battery telemetry:', payload);
                        updateUIFromTelemetry(payload, 'mqtt');
                    });
                } catch (err) {
                    console.warn('[MQTT] Connection failed:', err.message);
                }
            })();

            window.addEventListener('mqtt-telemetry', (e) => {
                if (e.detail && e.detail.type === 'battery') {
                    updateUIFromTelemetry(e.detail.payload, 'mqtt');
                }
            });

            function updateUIFromTelemetry(payload, source) {
                if (!payload || typeof payload !== 'object') return;
                const rawEl = document.getElementById('diagRawPayload');
                try { if (rawEl) rawEl.textContent = JSON.stringify(payload, null, 2); } catch (e) { if (rawEl) rawEl.textContent = String(payload); }
                
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'System Online';
                statusText.style.color = '#10b981';
                statusSubtext.textContent = `Live via ${source.toUpperCase()} â€¢ ${new Date().toLocaleTimeString()}`;
                if (payload.direction) {
                    statusSubtext.textContent += ` â€¢ ${payload.direction.toUpperCase()}`;
                }

                // Determine charging state
                const chargeEl = document.getElementById('chargeStatus');
                let dirLabel = 'Idle';
                let dirColor = '#9ca3af';
                let currentSigned = 0;
                let sourceUsed = 'none';

                // PRIORITY 1: ESP32 sends explicit 'direction' field (already corrected by firmware invert logic).
                // Trust it directly â€” do NOT re-derive or apply dashboard invert.
                if (payload.direction) {
                    const d = String(payload.direction).toLowerCase();
                    if (d === 'charging') {
                        dirLabel = 'Charging'; dirColor = '#10b981';
                    } else if (d === 'discharging') {
                        dirLabel = 'Discharging'; dirColor = '#ef4444';
                    } else {
                        dirLabel = 'Idle'; dirColor = '#9ca3af';
                    }
                    currentSigned = (payload.current_signed !== undefined) ? parseFloat(payload.current_signed) : 0;
                    sourceUsed = 'device_direction';
                }
                // PRIORITY 2: No direction field but current_signed available (e.g. raw MQTT).
                // Apply dashboard invert toggle here since there's no firmware-level correction.
                else if (payload.current_signed !== undefined) {
                    currentSigned = parseFloat(payload.current_signed);
                    sourceUsed = 'current_signed';
                    try {
                        if (localStorage.getItem('invert_current_sign') === '1') currentSigned = -currentSigned;
                    } catch (e) { /* ignore */ }
                    if (currentSigned > 0.05) { dirLabel = 'Charging'; dirColor = '#10b981'; }
                    else if (currentSigned < -0.05) { dirLabel = 'Discharging'; dirColor = '#ef4444'; }
                }
                // PRIORITY 3: Only unsigned magnitude available â€” cannot determine direction.
                else if (payload.current !== undefined) {
                    sourceUsed = 'current_magnitude_only';
                }

                // Update diagnostics if present
                const diagSigned = document.getElementById('diagSigned');
                const diagMag = document.getElementById('diagMag');
                const diagSource = document.getElementById('diagSource');
                const diagInterpreted = document.getElementById('diagInterpreted');
                if (diagSigned) diagSigned.textContent = (payload.current_signed !== undefined) ? parseFloat(payload.current_signed).toFixed(3) : '-';
                if (diagMag) diagMag.textContent = (payload.current !== undefined) ? parseFloat(payload.current).toFixed(3) : '-';
                if (diagSource) diagSource.textContent = sourceUsed;
                if (diagInterpreted) diagInterpreted.textContent = dirLabel;

                if (chargeEl) {
                    chargeEl.textContent = dirLabel;
                    chargeEl.style.color = dirColor;
                }
                // Also update the small badge in the Current stat card
                const currentDirEl = document.getElementById('currentDir');
                if (currentDirEl) {
                    currentDirEl.textContent = dirLabel;
                    currentDirEl.style.color = dirColor;
                    if (dirLabel === 'Charging') {
                        currentDirEl.style.background = 'rgba(16,185,129,0.08)';
                    } else if (dirLabel === 'Discharging') {
                        currentDirEl.style.background = 'rgba(239,68,68,0.06)';
                    } else {
                        currentDirEl.style.background = 'transparent';
                    }
                }

                // Update metric displays (use correct element IDs from the HTML)
                const voltage = payload.voltage !== undefined ? parseFloat(payload.voltage) : null;
                if (voltage !== null) {
                    const el = document.getElementById('voltage');
                    if (el) el.textContent = voltage.toFixed(2);
                }
                
                // Current (show absolute value in UI but infer direction from signed value)
                // Current magnitude for display: prefer provided magnitude. Do not infer sign from magnitude alone.
                let currentVal = null;
                if (payload.current_signed !== undefined) {
                    currentVal = Math.abs(parseFloat(payload.current_signed));
                } else if (payload.current !== undefined) {
                    currentVal = Math.abs(parseFloat(payload.current));
                }
                if (currentVal !== null) {
                    const el = document.getElementById('current');
                    if (el) el.textContent = currentVal.toFixed(2);
                }
                
                // Power calculation
                const power = payload.power !== undefined ? parseFloat(payload.power) : null;
                if (power !== null) {
                    const el = document.getElementById('power');
                    if (el) el.textContent = power.toFixed(2);
                }
                
                // ==========================================
                // SOC Calculation (State of Charge)
                // ==========================================
                let soc = null;
                if (payload.soc !== undefined) {
                    // Use provided SOC if available
                    soc = parseFloat(payload.soc);
                } else if (voltage !== null) {
                    // Auto-detect battery type from voltage and apply appropriate SOC curve
                    if (voltage >= 6.0) {
                        // â”€â”€ 12V Lead-Acid pack (10.5Vâ€“12.7V) â”€â”€
                        if (voltage >= 12.7) { soc = 100; }
                        else if (voltage <= 10.5) { soc = 0; }
                        else {
                            if (voltage >= 12.4)      soc = 80 + ((voltage - 12.4) / 0.3) * 20;
                            else if (voltage >= 12.2) soc = 60 + ((voltage - 12.2) / 0.2) * 20;
                            else if (voltage >= 12.0) soc = 40 + ((voltage - 12.0) / 0.2) * 20;
                            else if (voltage >= 11.8) soc = 20 + ((voltage - 11.8) / 0.2) * 20;
                            else                      soc = ((voltage - 10.5) / 1.3) * 20;
                        }
                    } else if (voltage >= 2.5) {
                        // â”€â”€ Single Li-ion / LiPo cell (2.5Vâ€“4.2V) â”€â”€
                        if (voltage >= 4.20) { soc = 100; }
                        else if (voltage <= 2.50) { soc = 0; }
                        else {
                            if (voltage >= 4.05)      soc = 90 + ((voltage - 4.05) / 0.15) * 10;
                            else if (voltage >= 3.90) soc = 70 + ((voltage - 3.90) / 0.15) * 20;
                            else if (voltage >= 3.70) soc = 40 + ((voltage - 3.70) / 0.20) * 30;
                            else if (voltage >= 3.50) soc = 15 + ((voltage - 3.50) / 0.20) * 25;
                            else if (voltage >= 3.30) soc = 5  + ((voltage - 3.30) / 0.20) * 10;
                            else                      soc = ((voltage - 2.50) / 0.80) * 5;
                        }
                    } else {
                        soc = 0; // Below minimum recognizable cell voltage
                    }
                    soc = Math.max(0, Math.min(100, soc));
                }
                if (soc !== null) {
                    const el = document.getElementById('soc');
                    if (el) el.textContent = soc.toFixed(0);
                }
                
                // ==========================================
                // SOH Calculation (State of Health)
                // ==========================================
                let soh = null;
                const cycles = payload.cycles !== undefined ? parseInt(payload.cycles) : 0;
                const capacity = payload.capacity !== undefined ? parseFloat(payload.capacity) : null;
                const designCapacity = 100; // Assume 100Ah design capacity
                
                if (payload.soh !== undefined) {
                    // Use provided SOH if available
                    soh = parseFloat(payload.soh);
                } else if (capacity !== null && capacity > 0) {
                    // Calculate SOH from current capacity vs design capacity
                    soh = (capacity / designCapacity) * 100;
                    soh = Math.max(0, Math.min(100, soh));
                } else if (cycles > 0) {
                    // Estimate SOH from cycle count (typical lead-acid degradation)
                    // Assume 500 cycles = 80% health, 1000 cycles = 60% health
                    const maxCycles = 1500; // Typical lead-acid lifespan
                    const degradationRate = 40 / maxCycles; // Lose 40% over full lifespan
                    soh = 100 - (cycles * degradationRate);
                    soh = Math.max(50, Math.min(100, soh)); // SOH floor at 50%
                } else {
                    // Default to 100% if no data
                    soh = 100;
                }
                if (soh !== null) {
                    const el = document.getElementById('soh');
                    if (el) el.textContent = soh.toFixed(0);
                }
                
                // Temperature
                if (payload.temperature !== undefined) {
                    const el = document.getElementById('temperature');
                    if (el) el.textContent = parseFloat(payload.temperature).toFixed(1);
                }
                
                // Internal Resistance
                if (payload.resistance !== undefined) {
                    const el = document.getElementById('resistance');
                    if (el) el.textContent = parseInt(payload.resistance);
                }
                
                // Capacity
                if (capacity !== null) {
                    const el = document.getElementById('capacity');
                    if (el) el.textContent = capacity.toFixed(1);
                }
                
                // Cycle Count
                if (cycles > 0) {
                    const el = document.getElementById('cycles');
                    if (el) el.textContent = cycles;
                }
            }
        })();
    </script>
</body>
</html>
