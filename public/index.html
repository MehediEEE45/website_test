<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ Energy Monitoring Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#0a0a0a',
                        foreground: '#fafafa',
                        card: '#1a1a1a',
                        'card-foreground': '#fafafa',
                        muted: '#262626',
                        'muted-foreground': '#9ca3af',
                        border: '#2a2a2a',
                        primary: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/auth.js"></script>
    <script src="js/mqtt-client.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #0a0a0a 0%, #0f0f0f 100%);
            color: #fafafa;
            min-height: 100vh;
        }
        .hero-section {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(59, 130, 246, 0.05) 50%, rgba(168, 85, 247, 0.1) 100%);
            border-bottom: 1px solid #2a2a2a;
            padding: 80px 20px 60px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.1), transparent 70%);
            pointer-events: none;
        }
        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: #3a3a3a;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        .btn-outline {
            background: transparent;
            border: 1.5px solid #3a3a3a;
            color: #fafafa;
        }
        .btn-outline:hover {
            background: rgba(255,255,255,0.08);
            border-color: #4a4a4a;
        }
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gradient-color-1), var(--gradient-color-2));
        }
        .project-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-left: 4px solid var(--card-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .project-card:hover {
            border-color: var(--card-color);
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.5);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .section-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        @media (max-width: 768px) {
            .hero-section { padding: 60px 20px 40px; }
            .section-title { font-size: 20px; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav id="top-nav" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid #2a2a2a; padding: 12px 24px; display: none;">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 18px;">⚡</span>
                </div>
                <span style="font-weight: 700; font-size: 16px;">Energy Control Center</span>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <a id="mqtt-link" href="mqtt-settings.html" style="display: none; font-size: 13px; color: #9ca3af; text-decoration: none; padding: 8px 12px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#fafafa'" onmouseout="this.style.background='transparent'; this.style.color='#9ca3af'">
                    <i data-lucide="radio" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>
                    MQTT
                    <span id="mqtt-status-badge" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; margin-left: 6px;"></span>
                </a>
                <a id="admin-link" href="admin.html" style="display: none; font-size: 13px; color: #9ca3af; text-decoration: none; padding: 8px 12px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'; this.style.color='#fafafa'" onmouseout="this.style.background='transparent'; this.style.color='#9ca3af'">
                    <i data-lucide="shield" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>
                    Admin Panel
                </a>
                <div id="user-menu" style="display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="user" style="width: 16px; height: 16px; color: white;"></i>
                    </div>
                    <div>
                        <p id="user-name" style="font-size: 13px; font-weight: 600; line-height: 1.2;">User</p>
                        <p id="user-role" style="font-size: 11px; color: #9ca3af; line-height: 1.2;">Role</p>
                    </div>
                    <button onclick="handleLogout()" style="margin-left: 8px; padding: 6px 12px; background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'">
                        <i data-lucide="log-out" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div style="position: relative; z-index: 1;">
            <div style="display: inline-flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);">
                    <span style="font-size: 32px;">⚡</span>
                </div>
            </div>
            <h1 style="font-size: 48px; font-weight: 900; margin-bottom: 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                Energy Monitoring Control Center
            </h1>
            <p style="font-size: 20px; color: #9ca3af; max-width: 700px; margin: 0 auto 32px;">
                Centralized Dashboard for All Renewable Energy Projects
            </p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 16px; flex-wrap: wrap;">
                <button id="login-btn" onclick="window.location.href='login.html'" class="btn btn-primary">
                    <i data-lucide="log-in" style="width: 18px; height: 18px; margin-right: 8px;"></i>
                    Login to Access
                </button>
                <div id="system-status" class="badge" style="border: 1px solid rgba(239, 68, 68, 0.4); background: rgba(239, 68, 68, 0.15); color: #fca5a5;">
                    <span class="status-dot" style="background: #ef4444; margin-right: 8px;"></span>
                    Some Systems Offline
                </div>
            </div>
            <p id="welcome-msg" style="display: none; margin-top: 20px; font-size: 14px; color: #9ca3af;">
                Welcome back! You have access to the projects shown below.
            </p>
        </div>
    </section>

    <!-- Main Content -->
    <main style="max-width: 1400px; margin: 0 auto; padding: 48px 24px; display: flex; flex-direction: column; gap: 64px;">
        
        <!-- System Overview Section -->
        <section>
            <h2 class="section-title">
                <i data-lucide="activity" style="width: 28px; height: 28px; color: #f59e0b;"></i>
                System Overview
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
                <!-- Total Power -->
                <div class="stat-card" style="--gradient-color-1: #fbbf24; --gradient-color-2: #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(251, 191, 36, 0.15); border-radius: 12px;">
                            <i data-lucide="zap" style="width: 24px; height: 24px; color: #fbbf24;"></i>
                        </div>
                        <span style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total</span>
                    </div>
                    <div>
                        <p style="font-size: 36px; font-weight: 800; line-height: 1;">0.0</p>
                        <p style="font-size: 13px; color: #9ca3af; margin-top: 8px; font-weight: 500;">Total Power (kW)</p>
                    </div>
                </div>
                <!-- Total Energy -->
                <div class="stat-card" style="--gradient-color-1: #14b8a6; --gradient-color-2: #06b6d4;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(20, 184, 166, 0.15); border-radius: 12px;">
                            <i data-lucide="activity" style="width: 24px; height: 24px; color: #14b8a6;"></i>
                        </div>
                        <span style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Today</span>
                    </div>
                    <div>
                        <p style="font-size: 36px; font-weight: 800; line-height: 1;">0.0</p>
                        <p style="font-size: 13px; color: #9ca3af; margin-top: 8px; font-weight: 500;">Total Energy (kWh)</p>
                    </div>
                </div>
                <!-- Savings -->
                <div class="stat-card" style="--gradient-color-1: #22c55e; --gradient-color-2: #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(34, 197, 94, 0.15); border-radius: 12px;">
                            <i data-lucide="trending-up" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        </div>
                        <span style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Savings</span>
                    </div>
                    <div>
                        <p style="font-size: 36px; font-weight: 800; line-height: 1;">৳0</p>
                        <p style="font-size: 13px; color: #9ca3af; margin-top: 8px; font-weight: 500;">Today (BDT)</p>
                    </div>
                </div>
                <!-- CO2 Avoided -->
                <div class="stat-card" style="--gradient-color-1: #34d399; --gradient-color-2: #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(52, 211, 153, 0.15); border-radius: 12px;">
                            <i data-lucide="leaf" style="width: 24px; height: 24px; color: #34d399;"></i>
                        </div>
                        <span style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Impact</span>
                    </div>
                    <div>
                        <p style="font-size: 36px; font-weight: 800; line-height: 1;">0.0</p>
                        <p style="font-size: 13px; color: #9ca3af; margin-top: 8px; font-weight: 500;">CO₂ Avoided (kg)</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Active Projects Section -->
        <section>
            <h2 class="section-title">
                <i data-lucide="folder" style="width: 28px; height: 28px; color: #f59e0b;"></i>
                Active Projects
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px;">
                
                <!-- Device Control Panel -->
                <div id="card-control-panel" class="project-card" style="--card-color: #14b8a6; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 12px; background: rgba(20, 184, 166, 0.15); border-radius: 12px;">
                            <i data-lucide="cpu" style="width: 28px; height: 28px; color: #14b8a6;"></i>
                        </div>
                        <span class="badge" style="background: rgba(20, 184, 166, 0.2); color: #5eead4; border: 1px solid rgba(20, 184, 166, 0.3);">ACTIVE</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">Device Control Panel</h3>
                    <p style="font-size: 13px; color: #9ca3af; margin-bottom: 20px; line-height: 1.6;">Remotely control and automate devices (lights, fans, motors, outlets) with ESP32 integration.</p>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Status:</span>
                        <span id="card-control-status" style="font-size: 12px; color: #fca5a5; display: flex; align-items: center; gap: 6px; font-weight: 600;">
                            <span id="card-control-dot" class="status-dot" style="background: #ef4444;"></span>
                            Offline
                        </span>
                    </div>
                    <a href="control-panel.html" class="btn btn-primary" style="width: 100%; font-size: 14px;">
                        Open Control Panel
                        <i data-lucide="arrow-right" style="width: 18px; height: 18px; margin-left: 8px;"></i>
                    </a>
                </div>

                <!-- Solar Power Monitor -->
                <div id="card-solar" class="project-card" style="--card-color: #eab308; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 12px; background: rgba(234, 179, 8, 0.15); border-radius: 12px;">
                            <i data-lucide="sun" style="width: 28px; height: 28px; color: #eab308;"></i>
                        </div>
                        <span class="badge" style="background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3);">ACTIVE</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">Solar Power Monitor</h3>
                    <p style="font-size: 13px; color: #9ca3af; margin-bottom: 20px; line-height: 1.6;">Real-time solar panel monitoring and analytics</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Power:</span>
                            <span style="font-size: 12px; font-weight: 600;">0.0 W</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Energy Today:</span>
                            <span style="font-size: 12px; font-weight: 600;">0.0 kWh</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Status:</span>
                            <span id="card-solar-status" style="font-size: 12px; color: #fca5a5; display: flex; align-items: center; gap: 6px; font-weight: 600;">
                                <span id="card-solar-dot" class="status-dot" style="background: #ef4444;"></span>
                                Offline
                            </span>
                        </div>
                    </div>
                    <a href="solar-monitor.html" class="btn btn-primary" style="width: 100%; font-size: 14px;">
                        Open Dashboard
                        <i data-lucide="arrow-right" style="width: 18px; height: 18px; margin-left: 8px;"></i>
                    </a>
                </div>

                <!-- Wind Turbine Monitor -->
                <div id="card-wind" class="project-card" style="--card-color: #06b6d4; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 12px; background: rgba(6, 182, 212, 0.15); border-radius: 12px;">
                            <i data-lucide="wind" style="width: 28px; height: 28px; color: #06b6d4;"></i>
                        </div>
                        <span class="badge" style="background: rgba(6, 182, 212, 0.2); color: #67e8f9; border: 1px solid rgba(6, 182, 212, 0.3);">ACTIVE</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">Wind Turbine Monitor</h3>
                    <p style="font-size: 13px; color: #9ca3af; margin-bottom: 20px; line-height: 1.6;">Real-time wind turbine monitoring and analytics</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Power:</span>
                            <span style="font-size: 12px; font-weight: 600;">0.0 W</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Energy Today:</span>
                            <span style="font-size: 12px; font-weight: 600;">0.0 kWh</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Status:</span>
                            <span id="card-wind-status" style="font-size: 12px; color: #fca5a5; display: flex; align-items: center; gap: 6px; font-weight: 600;">
                                <span id="card-wind-dot" class="status-dot" style="background: #ef4444;"></span>
                                Offline
                            </span>
                        </div>
                    </div>
                    <a href="wind-monitor.html" class="btn btn-primary" style="width: 100%; font-size: 14px;">
                        Open Dashboard
                        <i data-lucide="arrow-right" style="width: 18px; height: 18px; margin-left: 8px;"></i>
                    </a>
                </div>

                <!-- Battery Health Monitor -->
                <div id="card-battery" class="project-card" style="--card-color: #a855f7; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 12px; background: rgba(168, 85, 247, 0.15); border-radius: 12px;">
                            <i data-lucide="battery" style="width: 28px; height: 28px; color: #a855f7;"></i>
                        </div>
                        <span class="badge" style="background: rgba(168, 85, 247, 0.2); color: #d8b4fe; border: 1px solid rgba(168, 85, 247, 0.3);">ACTIVE</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">Battery Health Monitor</h3>
                    <p style="font-size: 13px; color: #9ca3af; margin-bottom: 20px; line-height: 1.6;">Real-time battery health and analytics</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Voltage:</span>
                            <span style="font-size: 12px; font-weight: 600;">0.0 V</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">SoC:</span>
                            <span style="font-size: 12px; font-weight: 600;">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #9ca3af; font-weight: 500;">Status:</span>
                            <span id="card-battery-status" style="font-size: 12px; color: #fca5a5; display: flex; align-items: center; gap: 6px; font-weight: 600;">
                                <span id="card-battery-dot" class="status-dot" style="background: #ef4444;"></span>
                                Offline
                            </span>
                        </div>
                    </div>
                    <a href="battery-monitor.html" class="btn btn-primary" style="width: 100%; font-size: 14px;">
                        Open Dashboard
                        <i data-lucide="arrow-right" style="width: 18px; height: 18px; margin-left: 8px;"></i>
                    </a>
                </div>
            </div>
        </section>

        <!-- Upcoming Projects Section -->
        <section>
            <h2 class="section-title">
                <i data-lucide="calendar" style="width: 28px; height: 28px; color: #f59e0b;"></i>
                Upcoming Projects
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px;">
                <!-- Grid Integration -->
                <div class="card" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 10px; background: rgba(100, 116, 139, 0.1); border-radius: 10px;">
                            <i data-lucide="plug" style="width: 24px; height: 24px; color: #94a3b8;"></i>
                        </div>
                        <span class="badge" style="border: 1px solid #3a3a3a; color: #9ca3af; background: rgba(156, 163, 175, 0.1); font-family: monospace; font-size: 10px;">Q2 2026</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">Grid Integration</h3>
                    <p style="font-size: 12px; color: #9ca3af; line-height: 1.5;">Monitor grid connection and power export/import</p>
                </div>
                <!-- Hydro Monitor -->
                <div class="card" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 10px; background: rgba(100, 116, 139, 0.1); border-radius: 10px;">
                            <i data-lucide="droplets" style="width: 24px; height: 24px; color: #94a3b8;"></i>
                        </div>
                        <span class="badge" style="border: 1px solid #3a3a3a; color: #9ca3af; background: rgba(156, 163, 175, 0.1); font-family: monospace; font-size: 10px;">Q3 2026</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">Hydro Monitor</h3>
                    <p style="font-size: 12px; color: #9ca3af; line-height: 1.5;">Small hydroelectric generation monitoring</p>
                </div>
                <!-- Smart Meters -->
                <div class="card" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 10px; background: rgba(100, 116, 139, 0.1); border-radius: 10px;">
                            <i data-lucide="gauge" style="width: 24px; height: 24px; color: #94a3b8;"></i>
                        </div>
                        <span class="badge" style="border: 1px solid #3a3a3a; color: #9ca3af; background: rgba(156, 163, 175, 0.1); font-family: monospace; font-size: 10px;">Q3 2026</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">Smart Meters</h3>
                    <p style="font-size: 12px; color: #9ca3af; line-height: 1.5;">Individual appliance energy consumption tracking</p>
                </div>
                <!-- AI Optimization -->
                <div class="card" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="padding: 10px; background: rgba(100, 116, 139, 0.1); border-radius: 10px;">
                            <i data-lucide="brain" style="width: 24px; height: 24px; color: #94a3b8;"></i>
                        </div>
                        <span class="badge" style="border: 1px solid #3a3a3a; color: #9ca3af; background: rgba(156, 163, 175, 0.1); font-family: monospace; font-size: 10px;">Q4 2026</span>
                    </div>
                    <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 6px;">AI Optimization</h3>
                    <p style="font-size: 12px; color: #9ca3af; line-height: 1.5;">Machine learning-based energy optimization</p>
                </div>
            </div>
        </section>

        <!-- Quick Actions Section -->
        <section>
            <h2 class="section-title">
                <i data-lucide="zap" style="width: 28px; height: 28px; color: #f59e0b;"></i>
                Quick Actions
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <!-- Generate Report -->
                <div class="card" style="padding: 20px; cursor: pointer;" onmouseover="this.style.borderColor='rgba(245,158,11,0.5)'" onmouseout="this.style.borderColor='#2a2a2a'">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                            <i data-lucide="file-text" style="width: 24px; height: 24px; color: #f59e0b;"></i>
                        </div>
                        <div>
                            <h3 style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">Generate Combined Report</h3>
                            <p style="font-size: 12px; color: #9ca3af;">Export data from all systems</p>
                        </div>
                    </div>
                </div>
                <!-- System Health -->
                <div class="card" style="padding: 20px; cursor: pointer;" onmouseover="this.style.borderColor='rgba(245,158,11,0.5)'" onmouseout="this.style.borderColor='#2a2a2a'">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                            <i data-lucide="activity" style="width: 24px; height: 24px; color: #f59e0b;"></i>
                        </div>
                        <div>
                            <h3 style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">System Health Check</h3>
                            <p style="font-size: 12px; color: #9ca3af;">View all systems status</p>
                        </div>
                    </div>
                </div>
                <!-- Global Settings -->
                <div class="card" style="padding: 20px; cursor: pointer;" onmouseover="this.style.borderColor='rgba(245,158,11,0.5)'" onmouseout="this.style.borderColor='#2a2a2a'">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
                            <i data-lucide="settings" style="width: 24px; height: 24px; color: #f59e0b;"></i>
                        </div>
                        <div>
                            <h3 style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">Global Settings</h3>
                            <p style="font-size: 12px; color: #9ca3af;">Configure all systems</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer style="border-top: 1px solid #2a2a2a; padding: 32px 24px; background: #0a0a0a;">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;">
            <p style="font-size: 14px; color: #6b7280;">© 2026 Energy Monitoring Control Center • All rights reserved</p>
            <div style="display: flex; gap: 24px;">
                <a href="#" style="font-size: 14px; color: #9ca3af; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color='#9ca3af'">Documentation</a>
                <a href="#" style="font-size: 14px; color: #9ca3af; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color='#9ca3af'">API</a>
                <a href="#" style="font-size: 14px; color: #9ca3af; text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color='#9ca3af'">Support</a>
            </div>
        </div>
    </footer>

    <script>
        lucide.createIcons();
    </script>
    <script src="js/data-saver.js"></script>
    <script>
        // Initialize auth and update UI
        document.addEventListener('DOMContentLoaded', function() {
            AUTH.init();
            updateUIForAuth();
            updateCardStatuses();
            // periodic refresh in case data ages out
            setInterval(updateCardStatuses, 10000);
        });

        // Helper to set card state
        function setCardState(name, online, reason) {
            const statusEl = document.getElementById('card-' + name + '-status');
            if (!statusEl) return;
            if (online) {
                statusEl.innerHTML = `<span id="card-${name}-dot" class="status-dot" style="background:#22c55e;"></span> Online`;
                statusEl.style.color = '#86efac';
                statusEl.title = reason || '';
            } else {
                statusEl.innerHTML = `<span id="card-${name}-dot" class="status-dot" style="background:#ef4444;"></span> Offline`;
                statusEl.style.color = '#fca5a5';
                if (reason) statusEl.title = reason;
            }
        }

        // Check for recent telemetry (threshold ms)
        function isRecent(deviceId, thresholdMs = 20000) {
            const last = DATA.getRecent(deviceId, 1)[0];
            if (!last) return { recent: false, reason: 'No data' };
            const age = Date.now() - new Date(last.timestamp).getTime();
            return { recent: age <= thresholdMs, reason: `Last ${Math.round(age/1000)}s` };
        }

        // Map of devices to cards
        const DEVICE_MAP = [
            { name: 'control', id: 'control_panel_1' },
            { name: 'solar', id: 'solar_1' },
            { name: 'wind', id: 'wind_1' },
            { name: 'battery', id: 'battery_1' }
        ];

        async function updateCardStatuses() {
            DEVICE_MAP.forEach(async d => {
                const storedIp = localStorage.getItem('esp_ip_' + d.id);
                if (storedIp) {
                    try {
                        const probe = await DATA.probeEsp32(storedIp, 2500);
                        if (probe && probe.success) {
                            setCardState(d.name, true, `Reachable (${probe.url})`);
                            return;
                        } else {
                            const r = isRecent(d.id, 20000);
                            setCardState(d.name, r.recent, probe && probe.error ? probe.error : r.reason);
                            return;
                        }
                    } catch (err) {
                        const r = isRecent(d.id, 20000);
                        setCardState(d.name, r.recent, err.message || 'Probe error');
                        return;
                    }
                }
                // No stored IP - fallback to recency
                const r = isRecent(d.id, 20000);
                setCardState(d.name, r.recent, r.reason);
            });
        }

        // Listen for live saves
        window.addEventListener('device-data-saved', (e) => {
            if (!e.detail || !e.detail.deviceId) return;
            const d = DEVICE_MAP.find(x => x.id === e.detail.deviceId);
            if (!d) return;
            if (e.detail.res && e.detail.res.success) {
                setCardState(d.name, true, 'Live');
            } else {
                // try recency fallback
                const r = isRecent(d.id, 20000);
                setCardState(d.name, r.recent, e.detail.res && e.detail.res.error ? e.detail.res.error : r.reason);
            }
        });

        function updateUIForAuth() {
            const user = AUTH.getCurrentUser();
            const topNav = document.getElementById('top-nav');
            const loginBtn = document.getElementById('login-btn');
            const welcomeMsg = document.getElementById('welcome-msg');
            const adminLink = document.getElementById('admin-link');
            const mqttLink = document.getElementById('mqtt-link');
            
            // Project cards
            const cardControlPanel = document.getElementById('card-control-panel');
            const cardSolar = document.getElementById('card-solar');
            const cardWind = document.getElementById('card-wind');
            const cardBattery = document.getElementById('card-battery');

            if (user) {
                // User is logged in
                topNav.style.display = 'block';
                document.body.style.paddingTop = '70px';
                loginBtn.style.display = 'none';
                welcomeMsg.style.display = 'block';
                
                // Update user info in nav
                document.getElementById('user-name').textContent = user.name;
                
                // Get user's groups for role display
                const userGroups = AUTH.getUserGroups(user.id);
                const groupNames = userGroups.map(g => g.name).join(', ') || 'No Group';
                document.getElementById('user-role').textContent = groupNames;
                
                // Show admin link and MQTT link if user has admin permission
                if (AUTH.hasPermission('system.admin')) {
                    adminLink.style.display = 'block';
                    mqttLink.style.display = 'block';
                }
                
                // Show project cards based on permissions
                if (AUTH.hasPermission('controlpanel.manage') || AUTH.hasPermission('controlpanel.view')) {
                    cardControlPanel.style.display = 'block';
                }
                if (AUTH.hasPermission('solar.view')) {
                    cardSolar.style.display = 'block';
                }
                if (AUTH.hasPermission('wind.view')) {
                    cardWind.style.display = 'block';
                }
                if (AUTH.hasPermission('battery.view')) {
                    cardBattery.style.display = 'block';
                }
                
                // Update welcome message
                const permissions = AUTH.getUserPermissions(user.id);
                const permCount = permissions.length;
                welcomeMsg.innerHTML = `Welcome back, <strong>${user.name}</strong>! You have access to <strong>${permCount}</strong> permission${permCount !== 1 ? 's' : ''}.`;
                
                // Re-render icons after DOM changes
                lucide.createIcons();
            } else {
                // User is not logged in - show login prompt
                topNav.style.display = 'none';
                document.body.style.paddingTop = '0';
                loginBtn.style.display = 'inline-flex';
                welcomeMsg.style.display = 'none';
                
                // Hide all project cards
                cardControlPanel.style.display = 'none';
                cardSolar.style.display = 'none';
                cardWind.style.display = 'none';
                cardBattery.style.display = 'none';
            }
        }

        function handleLogout() {
            AUTH.logout();
            updateUIForAuth();
            // Show a brief notification
            alert('You have been logged out successfully.');
        }

        // =====================================================
        // MQTT Auto-connect and status indicator
        // =====================================================
        (async function initMQTT() {
            const mqttStatusBadge = document.getElementById('mqtt-status-badge');
            
            // Update MQTT status badge
            function updateMqttBadge(connected) {
                if (mqttStatusBadge) {
                    mqttStatusBadge.style.background = connected ? '#22c55e' : '#ef4444';
                    mqttStatusBadge.title = connected ? 'MQTT Connected' : 'MQTT Disconnected';
                }
            }

            // Listen for MQTT status changes
            MQTT_CLIENT.onStatus((status) => {
                updateMqttBadge(status === 'connected');
            });

            // Try to auto-connect if broker is configured
            const cfg = MQTT_CLIENT.loadConfig();
            if (cfg.brokerUrl) {
                try {
                    await MQTT_CLIENT.connect();
                    console.log('[MQTT] Auto-connected to broker');
                    
                    // Subscribe to all telemetry
                    MQTT_CLIENT.subscribeAll((topic, payload) => {
                        console.log('[MQTT] Telemetry:', topic, payload);
                    });
                } catch (err) {
                    console.warn('[MQTT] Auto-connect failed:', err.message);
                }
            }
        })();

        // Listen for MQTT telemetry to update card status
        window.addEventListener('mqtt-telemetry', (e) => {
            if (!e.detail) return;
            const { type, deviceId } = e.detail;
            
            // Map type to card
            const cardMap = {
                'solar': 'Solar Farm Alpha',
                'wind': 'Wind Turbine Beta',
                'battery': 'Battery Storage'
            };
            
            const cardName = cardMap[type];
            if (cardName) {
                setCardState(cardName, true, 'MQTT Live');
            }
        });
    </script>
</body>
</html>
