<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarGuard IoT Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald green
                        'secondary': '#10b981', // Emerald light
                        'dark-bg': '#1f2937', // Dark gray
                        'card-bg': '#374151', // Slightly lighter card bg
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Inter Font Import -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Icon Library (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Historical Data -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #333333;
            --accent-color: #FF9500;
        }

        /* Light Theme */
        body.theme-light {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
        }

        /* Dark Theme (Default) */
        body.theme-dark {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-card: #374151;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
        }

        /* Apply theme colors */
        body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Light theme specific overrides */
        body.theme-light .bg-dark-bg {
            background-color: var(--bg-primary) !important;
        }

        body.theme-light .bg-card-bg,
        body.theme-light .bg-gray-800,
        body.theme-light .bg-gray-700 {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }

        body.theme-light .text-white {
            color: var(--text-primary) !important;
        }

        body.theme-light .text-gray-400,
        body.theme-light .text-gray-300 {
            color: var(--text-secondary) !important;
        }

        body.theme-light .border-gray-700,
        body.theme-light .border-gray-600 {
            border-color: var(--border-color) !important;
        }

        body.theme-light input,
        body.theme-light select,
        body.theme-light textarea {
            background-color: #f7fafc !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        body.theme-light .tab-inactive {
            color: #718096 !important;
        }

        body.theme-light footer {
            color: #718096 !important;
            border-color: var(--border-color) !important;
        }

        /* Custom scrollbar for aesthetics */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: var(--bg-secondary); }
        body::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 20px; border: 2px solid var(--bg-secondary); }
        
        body.theme-light::-webkit-scrollbar-track { background: #e2e8f0; }
        body.theme-light::-webkit-scrollbar-thumb { background-color: var(--accent-color); border: 2px solid #e2e8f0; }

        .spinner { border-top-color: var(--accent-color); }
        .tab-active { border-bottom: 2px solid var(--accent-color); color: var(--accent-color); }
        .tab-inactive { color: var(--text-secondary); }

        /* Smooth transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Font size classes */
        body.font-small { font-size: 14px; }
        body.font-medium { font-size: 16px; }
        body.font-large { font-size: 18px; }

        /* Compact mode */
        body.compact-mode .p-6 { padding: 1rem !important; }
        body.compact-mode .gap-6 { gap: 1rem !important; }
        body.compact-mode .mb-6 { margin-bottom: 1rem !important; }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 90px;
            height: 100vh;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
            border-right: 1px solid #333;
        }
        
        .sidebar-item {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            text-decoration: none;
        }
        
        .sidebar-item:hover {
            background: #2a2a2a;
            color: #fff;
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #c17924 0%, #FF9500 100%);
            color: #fff;
        }
        
        .sidebar-item i {
            margin-bottom: 4px;
        }
        
        .sidebar-item span {
            font-size: 10px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .main-content {
            margin-left: 90px;
            padding: 0;
            min-height: 100vh;
        }
        
        /* Battery Circular Progress */
        .battery-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#FF9500 0% var(--battery-percent, 34%), #2a2a2a var(--battery-percent, 34%) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .battery-circle::before {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #1e1e1e;
        }
        
        .battery-icon {
            position: relative;
            z-index: 1;
            color: #FF9500;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .main-content {
                margin-left: 70px;
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100 font-sans min-h-screen theme-dark" style="padding: 0; margin: 0;">

    <!-- Left Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-item active" onclick="switchTab('dashboard')">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
            <span>Real-time</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('history')">
            <i data-lucide="history" class="w-6 h-6"></i>
            <span>History</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('control')">
            <i data-lucide="sliders" class="w-6 h-6"></i>
            <span>Control</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('alerts')">
            <i data-lucide="bell" class="w-6 h-6"></i>
            <span>Alerts</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('predictions')">
            <i data-lucide="brain" class="w-6 h-6"></i>
            <span>AI</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('reports')">
            <i data-lucide="file-text" class="w-6 h-6"></i>
            <span>Reports</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('windsolar')">
            <i data-lucide="wind" class="w-6 h-6"></i>
            <span>Wind</span>
        </div>
        <div class="sidebar-item" onclick="switchTab('solardata')">
            <i data-lucide="sun" class="w-6 h-6"></i>
            <span>Solar Data</span>
        </div>
        <div class="sidebar-item" style="margin-top: auto;" onclick="switchTab('settings')">
            <i data-lucide="settings" class="w-6 h-6"></i>
            <span>Settings</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="flex justify-between items-center px-8 py-6 border-b border-gray-800" style="background: #000;">
            <div id="header-status" class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span id="local-status" class="text-sm text-gray-400">Connecting...</span>
            </div>
            <h1 class="text-2xl font-bold text-white tracking-wide">Solar Monitor</h1>
            <button onclick="switchTab('settings')" class="text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </header>

    <!-- Cloud Settings Modal (Hidden by default) -->
    <div id="cloud-settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-card-bg rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-700">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i data-lucide="cloud" class="w-6 h-6 mr-2 text-blue-400"></i>
                        Cloud Database Settings
                    </h2>
                    <button onclick="toggleCloudSettings()" class="text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Firebase Configuration -->
                <div class="space-y-4">
                    <div class="bg-blue-900/20 border border-blue-600/50 p-4 rounded-lg">
                        <h3 class="text-white font-semibold mb-2 flex items-center">
                            <i data-lucide="info" class="w-4 h-4 mr-2 text-blue-400"></i>
                            Firebase Setup
                        </h3>
                        <p class="text-gray-300 text-sm mb-3">
                            Connect to Firebase for unlimited cloud storage, real-time sync across devices, and automatic backups.
                        </p>
                        <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm underline">
                            Get Firebase Config → console.firebase.google.com
                        </a>
                    </div>

                    <div>
                        <label class="text-gray-300 text-sm font-medium mb-2 block">API Key</label>
                        <input type="text" id="firebase-api-key" placeholder="AIzaSy..." class="w-full bg-gray-700 text-white rounded px-3 py-2 text-sm">
                    </div>

                    <div>
                        <label class="text-gray-300 text-sm font-medium mb-2 block">Auth Domain</label>
                        <input type="text" id="firebase-auth-domain" placeholder="your-project.firebaseapp.com" class="w-full bg-gray-700 text-white rounded px-3 py-2 text-sm">
                    </div>

                    <div>
                        <label class="text-gray-300 text-sm font-medium mb-2 block">Project ID</label>
                        <input type="text" id="firebase-project-id" placeholder="your-project-id" class="w-full bg-gray-700 text-white rounded px-3 py-2 text-sm">
                    </div>

                    <div>
                        <label class="text-gray-300 text-sm font-medium mb-2 block">Storage Bucket</label>
                        <input type="text" id="firebase-storage-bucket" placeholder="your-project.appspot.com" class="w-full bg-gray-700 text-white rounded px-3 py-2 text-sm">
                    </div>

                    <div>
                        <label class="text-gray-300 text-sm font-medium mb-2 block">App ID</label>
                        <input type="text" id="firebase-app-id" placeholder="1:123456789:web:..." class="w-full bg-gray-700 text-white rounded px-3 py-2 text-sm">
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-gray-600">
                        <div>
                            <label class="text-gray-300 font-medium">Enable Cloud Sync</label>
                            <p class="text-xs text-gray-500">Automatically sync data to Firebase</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="cloud-sync-toggle" class="sr-only peer" onchange="toggleCloudSync()">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>

                    <div class="pt-4">
                        <button onclick="testFirebaseConnection()" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i data-lucide="wifi" class="w-4 h-4 inline mr-2"></i>
                            Test Connection
                        </button>
                    </div>

                    <!-- Connection Status -->
                    <div id="firebase-connection-status" class="hidden mt-4 p-3 rounded-lg">
                        <p class="text-sm"></p>
                    </div>

                    <!-- Connect Button (shown after successful test) -->
                    <div id="firebase-connect-button" class="hidden pt-2">
                        <button onclick="connectToFirebase()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                            <i data-lucide="cloud-check" class="w-5 h-5 inline mr-2"></i>
                            Connect to Cloud
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Dashboard Tab Content -->
        <div id="content-dashboard" class="tab-content" style="padding: 2rem;">
            <!-- Main Grid Layout -->
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Column 1: Power & Energy Summary (Large Card) -->
                <section class="lg:col-span-2 space-y-6">

                    <!-- Real-Time Power Output -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-primary/50 transition duration-300 hover:shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-primary flex items-center">
                                <i data-lucide="power" class="w-6 h-6 mr-3 text-secondary"></i>
                                Live Power Generation
                            </h2>
                            <div class="flex items-center gap-3">
                                <!-- Cloud Status Badge -->
                                <div id="cloud-status-badge" class="flex items-center bg-gray-700 text-gray-400 px-3 py-1.5 rounded-lg font-medium text-xs cursor-pointer hover:bg-gray-600 transition-colors" onclick="toggleCloudSettings()">
                                    <i data-lucide="cloud-off" class="w-4 h-4 mr-1.5"></i>
                                    <span>Cloud: Off</span>
                                </div>
                                <span class="text-sm text-gray-400" id="last-updated">Initial check...</span>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-baseline space-y-4 sm:space-y-0 sm:space-x-8">
                            <p class="text-6xl font-bold text-white leading-none">
                                <span id="live-power">0.00</span>
                            </p>
                            <p class="text-3xl font-light text-primary mt-2 sm:mt-0">
                                kW
                            </p>
                        </div>
                        <div class="mt-6">
                            <div class="h-2 bg-gray-600 rounded-full">
                                <div id="power-indicator" class="h-2 bg-primary rounded-full transition-all duration-500" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Energy Totals -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Total Energy Today -->
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                            <div class="flex items-center mb-1 text-primary">
                                <i data-lucide="sun" class="w-5 h-5 mr-2"></i>
                                <span class="text-xs font-medium text-gray-400 uppercase">Today's Yield</span>
                            </div>
                            <p class="text-2xl font-bold text-white"><span id="energy-today">--</span> kWh</p>
                        </div>
                        <!-- Total Energy Month -->
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                            <div class="flex items-center mb-1 text-primary">
                                <i data-lucide="calendar" class="w-5 h-5 mr-2"></i>
                                <span class="text-xs font-medium text-gray-400 uppercase">Monthly Total</span>
                            </div>
                            <p class="text-2xl font-bold text-white"><span id="energy-month">450.8</span> kWh</p>
                        </div>
                        <!-- Total Savings -->
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                            <div class="flex items-center mb-1 text-primary">
                                <i data-lucide="banknote" class="w-5 h-5 mr-2"></i>
                                <span class="text-xs font-medium text-gray-400 uppercase">Estimated Savings</span>
                            </div>
                            <p class="text-2xl font-bold text-white"><span id="savings-total">৳11,400</span></p>
                        </div>
                        <!-- CO2 Reduction -->
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                            <div class="flex items-center mb-1 text-primary">
                                <i data-lucide="leaf" class="w-5 h-5 mr-2"></i>
                                <span class="text-xs font-medium text-gray-400 uppercase">CO2 Avoided</span>
                            </div>
                            <p class="text-2xl font-bold text-white"><span id="co2-avoided">320</span> kg</p>
                        </div>
                    </div>

                    <!-- Real-Time Voltage & Current Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-6">
                        <!-- Voltage Chart -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-yellow-600/50">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <i data-lucide="plug-zap" class="w-5 h-5 mr-2 text-yellow-400"></i>
                                Voltage Curve (Last 60s)
                            </h3>
                            <div style="height: 200px;">
                                <canvas id="voltage-chart"></canvas>
                            </div>
                        </div>

                        <!-- Current Chart -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-cyan-600/50">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <i data-lucide="activity" class="w-5 h-5 mr-2 text-cyan-400"></i>
                                Current Curve (Last 60s)
                            </h3>
                            <div style="height: 200px;">
                                <canvas id="current-chart"></canvas>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Column 2: Specific Metrics & Environmental Data -->
                <section class="lg:col-span-1 space-y-6">
                    
                    <!-- External Environment Status -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-blue-600/50">
                        <h2 class="text-xl font-semibold mb-2 text-white flex items-center">
                            <i data-lucide="globe" class="w-5 h-5 mr-3 text-blue-400"></i>
                            External Weather & Time
                        </h2>
                        <div class="mb-3">
                            <p class="text-sm text-gray-400 mb-2">
                                <span class="text-blue-300 font-medium">Location:</span> 
                                <span id="external-location">Sylhet, Bangladesh</span>
                            </p>
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="location-input" 
                                    placeholder="Enter city, country" 
                                    class="flex-1 px-3 py-2 bg-gray-700 text-white text-sm rounded-lg border border-gray-600 focus:border-primary focus:outline-none"
                                    value="Sylhet, Bangladesh"
                                />
                                <button 
                                    onclick="updateLocation()" 
                                    class="px-4 py-2 bg-primary hover:bg-primary/80 text-white text-sm font-medium rounded-lg transition-colors flex items-center">
                                    <i data-lucide="check" class="w-4 h-4 mr-1"></i>
                                    Update
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                            <div class="flex items-center text-gray-300">
                                <i data-lucide="clock" class="w-5 h-5 mr-3 text-blue-400"></i>
                                Current Time
                            </div>
                            <span id="external-time" class="text-xl font-bold text-blue-300">--:--</span>
                        </div>
                    </div>

                    <!-- Real-Time Electrical Metrics -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Electrical Metrics (Local)</h2>
                        <div class="space-y-4">
                            <!-- Voltage -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="plug-zap" class="w-5 h-5 mr-3 text-yellow-400"></i>
                                    Voltage (V)
                                </div>
                                <span id="metric-voltage" class="text-xl font-bold text-yellow-300">-- V</span>
                            </div>
                            <!-- Current -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="activity" class="w-5 h-5 mr-3 text-cyan-400"></i>
                                    Current (A)
                                </div>
                                <span id="metric-current" class="text-xl font-bold text-cyan-300">-- A</span>
                            </div>
                            <!-- Frequency -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="activity" class="w-5 h-5 mr-3 text-fuchsia-400"></i>
                                    Frequency (Hz)
                                </div>
                                <span id="metric-frequency" class="text-xl font-bold text-fuchsia-300">-- Hz</span>
                            </div>
                        </div>
                    </div>

                    <!-- Environmental Conditions -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Environmental Conditions (External)</h2>
                        <div class="space-y-4">
                            <!-- Temperature -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="thermometer" class="w-5 h-5 mr-3 text-red-400"></i>
                                    Temperature (°C)
                                </div>
                                <span id="env-temp" class="text-xl font-bold text-red-300">-- °C</span>
                            </div>
                            <!-- Humidity -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="cloud-rain" class="w-5 h-5 mr-3 text-blue-400"></i>
                                    Humidity (%)
                                </div>
                                <span id="env-humidity" class="text-xl font-bold text-blue-300">-- %</span>
                            </div>
                            <!-- Irradiance -->
                            <div class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg">
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="maximize" class="w-5 h-5 mr-3 text-orange-400"></i>
                                    Irradiance (W/m²)
                                </div>
                                <span id="env-irradiance" class="text-xl font-bold text-orange-300">-- W/m²</span>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- History Tab Content -->
        <div id="content-history" class="tab-content hidden" style="padding: 2rem;">
        <div class="space-y-6">
            <!-- Time Period Selector -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="clock" class="w-6 h-6 mr-3 text-primary"></i>
                    Select Time Period
                </h2>
                <div class="flex flex-wrap gap-3 mb-4">
                    <button onclick="loadHistory('1h')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="clock-3" class="w-4 h-4 inline mr-2"></i>1 Hour
                    </button>
                    <button onclick="loadHistory('2h')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="clock-4" class="w-4 h-4 inline mr-2"></i>2 Hours
                    </button>
                    <button onclick="loadHistory('12h')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="clock-9" class="w-4 h-4 inline mr-2"></i>12 Hours
                    </button>
                    <button onclick="loadHistory('24h')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar-clock" class="w-4 h-4 inline mr-2"></i>24 Hours
                    </button>
                    <button onclick="loadHistory('7d')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar-days" class="w-4 h-4 inline mr-2"></i>7 Days
                    </button>
                    <button onclick="loadHistory('30d')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar-range" class="w-4 h-4 inline mr-2"></i>30 Days
                    </button>
                    <button onclick="loadHistory('365d')" class="history-btn bg-gray-700 hover:bg-primary/20 text-gray-300 hover:text-primary px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>365 Days
                    </button>
                </div>
                
                <!-- Custom Date Range -->
                <div class="border-t border-gray-600 pt-4 mt-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-3 flex items-center">
                        <i data-lucide="calendar-range" class="w-4 h-4 mr-2 text-cyan-400"></i>
                        Custom Date Range
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Start Date & Time</label>
                            <input type="datetime-local" id="history-start-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none border border-gray-600">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">End Date & Time</label>
                            <input type="datetime-local" id="history-end-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none border border-gray-600">
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadHistoryByDateRange()" class="w-full bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center font-medium">
                                <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                                Apply Filter
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Select custom start and end dates to view specific time periods
                    </p>
                </div>
            </div>

            <!-- Power Generation Chart -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 mr-3 text-primary"></i>
                        Power Generation History
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="resetChartZoom('powerChart')" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1.5 rounded-lg transition-colors text-sm flex items-center" title="Reset Zoom">
                            <i data-lucide="maximize-2" class="w-4 h-4 mr-1"></i>
                            Reset Zoom
                        </button>
                    </div>
                </div>
                <div class="h-80">
                    <canvas id="powerChart"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    <i data-lucide="mouse-pointer-click" class="w-3 h-3 inline mr-1"></i>
                    Click and drag on the chart to zoom into specific timeframes
                </p>
            </div>

            <!-- Statistics Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                    <div class="flex items-center mb-1 text-primary">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                        <span class="text-xs font-medium text-gray-400 uppercase">Peak Power</span>
                    </div>
                    <p class="text-2xl font-bold text-white"><span id="hist-peak">--</span> kW</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                    <div class="flex items-center mb-1 text-primary">
                        <i data-lucide="activity" class="w-5 h-5 mr-2"></i>
                        <span class="text-xs font-medium text-gray-400 uppercase">Average Power</span>
                    </div>
                    <p class="text-2xl font-bold text-white"><span id="hist-avg">--</span> kW</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                    <div class="flex items-center mb-1 text-primary">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                        <span class="text-xs font-medium text-gray-400 uppercase">Total Energy</span>
                    </div>
                    <p class="text-2xl font-bold text-white"><span id="hist-total">--</span> kWh</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700">
                    <div class="flex items-center mb-1 text-primary">
                        <i data-lucide="database" class="w-5 h-5 mr-2"></i>
                        <span class="text-xs font-medium text-gray-400 uppercase">Data Points</span>
                    </div>
                    <p class="text-2xl font-bold text-white"><span id="hist-count">--</span></p>
                </div>
            </div>

            <!-- Auto-CSV Export Settings -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="file-down" class="w-6 h-6 mr-3 text-primary"></i>
                    Auto CSV Export
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Enable/Disable Toggle -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <label class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center">
                                <i data-lucide="power" class="w-5 h-5 mr-3 text-green-400"></i>
                                <div>
                                    <p class="text-white font-medium">Auto Export</p>
                                    <p class="text-xs text-gray-400" id="auto-csv-status">Disabled</p>
                                </div>
                            </div>
                            <input type="checkbox" id="autoCSVEnabled" class="sr-only peer" onchange="toggleAutoCSV(this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[26px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>

                    <!-- Export Interval -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-400 mb-2 flex items-center">
                            <i data-lucide="clock" class="w-4 h-4 mr-2 text-cyan-400"></i>
                            Export Interval
                        </label>
                        <select id="csvExportInterval" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary focus:outline-none" onchange="saveAutoCSVSettings()">
                            <option value="300000">Every 5 Minutes</option>
                            <option value="600000">Every 10 Minutes</option>
                            <option value="1800000">Every 30 Minutes</option>
                            <option value="3600000" selected>Every Hour</option>
                            <option value="21600000">Every 6 Hours</option>
                            <option value="43200000">Every 12 Hours</option>
                            <option value="86400000">Every Day</option>
                        </select>
                    </div>

                    <!-- Last Export Time -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="flex items-center mb-1">
                            <i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-yellow-400"></i>
                            <span class="text-sm font-medium text-gray-400">Last Export</span>
                        </div>
                        <p class="text-white font-medium text-sm mt-2" id="lastCSVExport">Never</p>
                        <p class="text-xs text-gray-400 mt-1" id="nextCSVExport">Next: --</p>
                    </div>

                    <!-- Export Stats -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="flex items-center mb-1">
                            <i data-lucide="file-check" class="w-4 h-4 mr-2 text-purple-400"></i>
                            <span class="text-sm font-medium text-gray-400">Total Exports</span>
                        </div>
                        <p class="text-2xl font-bold text-white mt-2" id="totalCSVExports">0</p>
                        <p class="text-xs text-gray-400 mt-1"><span id="csvDataPoints">0</span> data points logged</p>
                    </div>
                </div>

                <!-- Export Now Button -->
                <div class="mt-4 flex gap-3">
                    <button onclick="exportCSVNow()" class="bg-primary hover:bg-primary/80 text-white px-6 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        Export Now
                    </button>
                    <button onclick="previewCSV()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                        <i data-lucide="eye" class="w-4 h-4 mr-2"></i>
                        Preview CSV
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i data-lucide="table" class="w-6 h-6 mr-3 text-primary"></i>
                        Recent Data Points
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="downloadCSV()" class="bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                            CSV
                        </button>
                        <button onclick="downloadJSON()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-4 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-json" class="w-4 h-4 mr-2"></i>
                            JSON
                        </button>
                        <button onclick="downloadPDF()" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                            PDF
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3">Time</th>
                                <th class="px-4 py-3">Power (kW)</th>
                                <th class="px-4 py-3">Voltage (V)</th>
                                <th class="px-4 py-3">Current (A)</th>
                                <th class="px-4 py-3">Frequency (Hz)</th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="text-gray-300">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Select a time period to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Tab Content -->
        <div id="content-control" class="tab-content hidden" style="padding: 2rem;">
        <div class="space-y-6">
            <!-- Control Panel Header -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-white mb-2 flex items-center">
                    <i data-lucide="power" class="w-6 h-6 mr-3 text-primary"></i>
                    Device Control Panel
                </h2>
                <p class="text-sm text-gray-400">Control connected devices remotely via ESP32</p>
                <div class="mt-4 flex items-center" id="control-status">
                    <div class="w-3 h-3 rounded-full bg-gray-500 mr-2" id="control-indicator"></div>
                    <span class="text-sm text-gray-400" id="control-status-text">Checking connection...</span>
                </div>
            </div>

            <!-- Lighting Controls -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-yellow-600/50">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="lightbulb" class="w-5 h-5 mr-3 text-yellow-400"></i>
                    Lighting
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Light 1 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-3 text-yellow-400"></i>
                            <div>
                                <p class="text-white font-medium">Main Light</p>
                                <p class="text-xs text-gray-400">Living Room</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="light1" class="sr-only peer" onchange="controlDevice('light1', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <!-- Light 2 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-3 text-yellow-400"></i>
                            <div>
                                <p class="text-white font-medium">LED Strip</p>
                                <p class="text-xs text-gray-400">Garden</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="light2" class="sr-only peer" onchange="controlDevice('light2', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <!-- Light 3 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-3 text-yellow-400"></i>
                            <div>
                                <p class="text-white font-medium">Porch Light</p>
                                <p class="text-xs text-gray-400">Entrance</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="light3" class="sr-only peer" onchange="controlDevice('light3', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <!-- All Lights -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between border border-yellow-500/30">
                        <div class="flex items-center">
                            <i data-lucide="zap" class="w-5 h-5 mr-3 text-yellow-400"></i>
                            <div>
                                <p class="text-white font-medium">All Lights</p>
                                <p class="text-xs text-gray-400">Master Control</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="allLights" class="sr-only peer" onchange="controlDevice('allLights', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Fan Controls -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-cyan-600/50">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="wind" class="w-5 h-5 mr-3 text-cyan-400"></i>
                    Fans
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Fan 1 with Speed Control -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i data-lucide="fan" class="w-5 h-5 mr-3 text-cyan-400"></i>
                                <div>
                                    <p class="text-white font-medium">Ceiling Fan</p>
                                    <p class="text-xs text-gray-400">Living Room</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="fan1" class="sr-only peer" onchange="controlDevice('fan1', this.checked)">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="mt-2">
                            <label class="text-xs text-gray-400">Speed: <span id="fan1-speed-value">50</span>%</label>
                            <input type="range" id="fan1-speed" min="0" max="100" value="50" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-cyan-500" oninput="controlFanSpeed('fan1', this.value)">
                        </div>
                    </div>
                    <!-- Fan 2 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i data-lucide="fan" class="w-5 h-5 mr-3 text-cyan-400"></i>
                                <div>
                                    <p class="text-white font-medium">Exhaust Fan</p>
                                    <p class="text-xs text-gray-400">Kitchen</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="fan2" class="sr-only peer" onchange="controlDevice('fan2', this.checked)">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="mt-2">
                            <label class="text-xs text-gray-400">Speed: <span id="fan2-speed-value">50</span>%</label>
                            <input type="range" id="fan2-speed" min="0" max="100" value="50" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-cyan-500" oninput="controlFanSpeed('fan2', this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motor & Pump Controls -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-orange-600/50">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="settings" class="w-5 h-5 mr-3 text-orange-400"></i>
                    Motors & Pumps
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Water Pump -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="droplet" class="w-5 h-5 mr-3 text-blue-400"></i>
                            <div>
                                <p class="text-white font-medium">Water Pump</p>
                                <p class="text-xs text-gray-400">Garden Irrigation</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="pump1" class="sr-only peer" onchange="controlDevice('pump1', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <!-- Motor 1 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="cog" class="w-5 h-5 mr-3 text-orange-400"></i>
                            <div>
                                <p class="text-white font-medium">Motor 1</p>
                                <p class="text-xs text-gray-400">Gate Opener</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="motor1" class="sr-only peer" onchange="controlDevice('motor1', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Outlets & Misc -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="plug" class="w-5 h-5 mr-3 text-green-400"></i>
                    Outlets & Others
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Outlet 1 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="plug-zap" class="w-5 h-5 mr-3 text-green-400"></i>
                            <div>
                                <p class="text-white font-medium">Smart Outlet 1</p>
                                <p class="text-xs text-gray-400">Living Room</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="outlet1" class="sr-only peer" onchange="controlDevice('outlet1', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <!-- Outlet 2 -->
                    <div class="bg-gray-700/50 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="plug-zap" class="w-5 h-5 mr-3 text-green-400"></i>
                            <div>
                                <p class="text-white font-medium">Smart Outlet 2</p>
                                <p class="text-xs text-gray-400">Bedroom</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="outlet2" class="sr-only peer" onchange="controlDevice('outlet2', this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Device Scheduling & Automation -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="calendar-clock" class="w-5 h-5 mr-3 text-purple-400"></i>
                    Device Scheduling & Automation
                </h3>

                <!-- Add New Schedule Form -->
                <div class="bg-gray-700/50 p-4 rounded-lg mb-4">
                    <h4 class="text-white font-medium mb-3">Create New Schedule</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Device</label>
                            <select id="schedule-device" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm">
                                <option value="light1">Living Room Light</option>
                                <option value="light2">Bedroom Light</option>
                                <option value="light3">Kitchen Light</option>
                                <option value="fan1">Ceiling Fan 1</option>
                                <option value="fan2">Ceiling Fan 2</option>
                                <option value="motor1">Water Pump</option>
                                <option value="motor2">Garage Door</option>
                                <option value="outlet1">Smart Outlet 1</option>
                                <option value="outlet2">Smart Outlet 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Mode</label>
                            <select id="schedule-mode" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm" onchange="toggleScheduleMode()">
                                <option value="single">Single Action</option>
                                <option value="duration">Start & Stop Time</option>
                            </select>
                        </div>
                        <div id="single-time-container">
                            <label class="text-xs text-gray-400 mb-1 block">Time</label>
                            <input type="time" id="schedule-time" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm">
                        </div>
                        <div id="start-time-container" class="hidden">
                            <label class="text-xs text-gray-400 mb-1 block">Start Time (ON)</label>
                            <input type="time" id="schedule-start-time" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm">
                        </div>
                        <div id="stop-time-container" class="hidden">
                            <label class="text-xs text-gray-400 mb-1 block">Stop Time (OFF)</label>
                            <input type="time" id="schedule-stop-time" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm">
                        </div>
                        <div id="action-container">
                            <label class="text-xs text-gray-400 mb-1 block">Action</label>
                            <select id="schedule-action" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm">
                                <option value="on">Turn ON</option>
                                <option value="off">Turn OFF</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Repeat</label>
                            <select id="schedule-repeat" class="w-full bg-gray-600 text-white rounded px-3 py-2 text-sm" onchange="toggleCustomDays()">
                                <option value="once">Once</option>
                                <option value="daily">Daily</option>
                                <option value="weekdays">Weekdays</option>
                                <option value="weekends">Weekends</option>
                                <option value="custom">Custom Days</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Days Selection (hidden by default) -->
                    <div id="custom-days-selector" class="hidden mt-3">
                        <label class="text-xs text-gray-400 mb-2 block">Select Days</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="0" class="schedule-day">
                                <span class="text-white">Sun</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="1" class="schedule-day">
                                <span class="text-white">Mon</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="2" class="schedule-day">
                                <span class="text-white">Tue</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="3" class="schedule-day">
                                <span class="text-white">Wed</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="4" class="schedule-day">
                                <span class="text-white">Thu</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="5" class="schedule-day">
                                <span class="text-white">Fri</span>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-600 px-3 py-1 rounded text-sm cursor-pointer hover:bg-gray-500">
                                <input type="checkbox" value="6" class="schedule-day">
                                <span class="text-white">Sat</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="addSchedule()" class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Add Schedule
                    </button>
                </div>

                <!-- Active Schedules List -->
                <div>
                    <h4 class="text-white font-medium mb-3 flex items-center justify-between">
                        <span>Active Schedules</span>
                        <span id="schedule-count" class="text-xs bg-purple-600 px-2 py-1 rounded">0</span>
                    </h4>
                    <div id="schedules-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-4">No schedules created yet</p>
                    </div>
                </div>
            </div>

            <!-- Smart Scenes -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-3 text-yellow-400"></i>
                    Smart Scenes
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Morning Scene -->
                    <button onclick="activateScene('morning')" class="bg-gradient-to-br from-orange-600/20 to-yellow-600/20 hover:from-orange-600/30 hover:to-yellow-600/30 border border-orange-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="sunrise" class="w-5 h-5 mr-2 text-orange-400"></i>
                            <span class="text-white font-semibold">Morning</span>
                        </div>
                        <p class="text-xs text-gray-300">All lights ON, fans OFF</p>
                    </button>

                    <!-- Work Scene -->
                    <button onclick="activateScene('work')" class="bg-gradient-to-br from-blue-600/20 to-cyan-600/20 hover:from-blue-600/30 hover:to-cyan-600/30 border border-blue-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="briefcase" class="w-5 h-5 mr-2 text-blue-400"></i>
                            <span class="text-white font-semibold">Work Mode</span>
                        </div>
                        <p class="text-xs text-gray-300">Office lights ON, fan at 50%</p>
                    </button>

                    <!-- Evening Scene -->
                    <button onclick="activateScene('evening')" class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 hover:from-purple-600/30 hover:to-pink-600/30 border border-purple-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="sunset" class="w-5 h-5 mr-2 text-purple-400"></i>
                            <span class="text-white font-semibold">Evening</span>
                        </div>
                        <p class="text-xs text-gray-300">Living room lights ON, dim</p>
                    </button>

                    <!-- Sleep Scene -->
                    <button onclick="activateScene('sleep')" class="bg-gradient-to-br from-indigo-600/20 to-blue-900/20 hover:from-indigo-600/30 hover:to-blue-900/30 border border-indigo-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="moon" class="w-5 h-5 mr-2 text-indigo-400"></i>
                            <span class="text-white font-semibold">Sleep Mode</span>
                        </div>
                        <p class="text-xs text-gray-300">All lights OFF, fans at 30%</p>
                    </button>

                    <!-- Away Scene -->
                    <button onclick="activateScene('away')" class="bg-gradient-to-br from-gray-600/20 to-gray-800/20 hover:from-gray-600/30 hover:to-gray-800/30 border border-gray-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="log-out" class="w-5 h-5 mr-2 text-gray-400"></i>
                            <span class="text-white font-semibold">Away Mode</span>
                        </div>
                        <p class="text-xs text-gray-300">All devices OFF, save energy</p>
                    </button>

                    <!-- Party Scene -->
                    <button onclick="activateScene('party')" class="bg-gradient-to-br from-pink-600/20 to-red-600/20 hover:from-pink-600/30 hover:to-red-600/30 border border-pink-600/50 p-4 rounded-lg transition-all text-left">
                        <div class="flex items-center mb-2">
                            <i data-lucide="music" class="w-5 h-5 mr-2 text-pink-400"></i>
                            <span class="text-white font-semibold">Party Mode</span>
                        </div>
                        <p class="text-xs text-gray-300">All lights ON, fans at 70%</p>
                    </button>
                </div>
            </div>

            <!-- Emergency Controls -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-red-600/50">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-3 text-red-400"></i>
                    Emergency Controls
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="emergencyShutdown()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="power-off" class="w-5 h-5 mr-2"></i>
                        Emergency Shutdown All
                    </button>
                    <button onclick="resetDevices()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                        Reset All Devices
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Tab Content -->
        <div id="content-alerts" class="tab-content hidden" style="padding: 2rem;">
        <div class="space-y-6">
            <!-- Alert Configuration -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="settings" class="w-6 h-6 mr-3 text-primary"></i>
                    Alert Configuration
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Voltage Alert -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-300 font-medium flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-2 text-yellow-400"></i>
                                Low Voltage Alert
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-voltage-alert" class="sr-only peer" onchange="saveAlertSettings()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <input type="number" id="voltage-threshold" value="200" step="10" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary outline-none" onchange="saveAlertSettings()">
                        <p class="text-xs text-gray-400">Alert when voltage drops below this value (V)</p>
                    </div>

                    <!-- Current Alert -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-300 font-medium flex items-center">
                                <i data-lucide="activity" class="w-4 h-4 mr-2 text-cyan-400"></i>
                                Overcurrent Alert
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-current-alert" class="sr-only peer" onchange="saveAlertSettings()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <input type="number" id="current-threshold" value="10" step="0.5" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary outline-none" onchange="saveAlertSettings()">
                        <p class="text-xs text-gray-400">Alert when current exceeds this value (A)</p>
                    </div>

                    <!-- Power Outage Alert -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-300 font-medium flex items-center">
                                <i data-lucide="power-off" class="w-4 h-4 mr-2 text-red-400"></i>
                                Power Outage Alert
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-outage-alert" class="sr-only peer" checked onchange="saveAlertSettings()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <p class="text-sm text-gray-400">Alert when ESP8266 connection is lost</p>
                    </div>

                    <!-- Email Notifications -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-300 font-medium flex items-center">
                                <i data-lucide="mail" class="w-4 h-4 mr-2 text-blue-400"></i>
                                Email Notifications
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-email-alert" class="sr-only peer" onchange="saveAlertSettings()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <input type="email" id="alert-email" placeholder="your@email.com" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary outline-none" onchange="saveAlertSettings()">
                        <p class="text-xs text-gray-400">Receive email alerts (requires EmailJS setup)</p>
                    </div>

                    <!-- WhatsApp Notifications -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-gray-300 font-medium flex items-center">
                                <i data-lucide="message-circle" class="w-4 h-4 mr-2 text-green-400"></i>
                                WhatsApp Alerts
                            </label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-whatsapp-alert" class="sr-only peer" onchange="saveAlertSettings()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <input type="tel" id="alert-whatsapp" placeholder="+880 1XXX-XXXXXX" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary outline-none" onchange="saveAlertSettings()">
                        <p class="text-xs text-gray-400">WhatsApp number with country code (e.g., +8801234567890)</p>
                    </div>
                </div>

                <!-- Sound Alert -->
                <div class="mt-6 flex items-center justify-between p-4 bg-gray-700/30 rounded-lg">
                    <label class="text-gray-300 font-medium flex items-center">
                        <i data-lucide="volume-2" class="w-4 h-4 mr-2 text-green-400"></i>
                        Sound Alerts
                    </label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="enable-sound-alert" class="sr-only peer" checked onchange="saveAlertSettings()">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                </div>
            </div>

            <!-- Active Alerts -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-red-600/50">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="bell-ring" class="w-6 h-6 mr-3 text-red-400"></i>
                    Active Alerts
                </h2>
                <div id="active-alerts" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No active alerts</p>
                </div>
            </div>

            <!-- Alert History -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i data-lucide="history" class="w-6 h-6 mr-3 text-primary"></i>
                        Alert History
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="downloadAlertsCSV()" class="bg-green-600/20 hover:bg-green-600/30 text-green-400 px-3 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i>
                            CSV
                        </button>
                        <button onclick="downloadAlertsTXT()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-3 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-text" class="w-4 h-4 mr-1"></i>
                            TXT
                        </button>
                        <button onclick="downloadAlertsPDF()" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-2 rounded-lg transition-colors text-sm font-medium flex items-center">
                            <i data-lucide="file-type" class="w-4 h-4 mr-1"></i>
                            PDF
                        </button>
                        <button onclick="clearAlertHistory()" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-2 rounded-lg transition-colors text-sm font-medium">
                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>Clear
                        </button>
                    </div>
                </div>
                <div id="alert-history" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center py-8">No alert history</p>
                </div>
            </div>

            <!-- Daily Report -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="file-text" class="w-6 h-6 mr-3 text-primary"></i>
                    Daily Energy Report
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-3">Report Schedule</h3>
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="daily-report" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary" onchange="saveAlertSettings()">
                                <span class="text-gray-300">Daily Report (9:00 AM)</span>
                            </label>
                            <label class="flex items-center space-x-3">
                                <input type="checkbox" id="weekly-report" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary" onchange="saveAlertSettings()">
                                <span class="text-gray-300">Weekly Report (Every Monday)</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-400 mb-3">Generate Report Now</h3>
                        <div class="space-y-2">
                            <button onclick="generateDailyReport('csv')" class="w-full bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2.5 rounded-lg transition-colors font-medium flex items-center justify-center">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                                Download as CSV
                            </button>
                            <button onclick="generateDailyReport('pdf')" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2.5 rounded-lg transition-colors font-medium flex items-center justify-center">
                                <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                                Download as PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Predictions Tab Content -->
        <div id="content-predictions" class="tab-content hidden" style="padding: 2rem;">
        <div class="space-y-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <i data-lucide="brain" class="w-6 h-6 mr-2 text-pink-400"></i>
                    AI-Powered Predictions & Analytics
                </h2>
                <p class="text-gray-400">Smart insights and forecasts based on your energy consumption patterns</p>
            </div>

            <!-- Usage Forecast -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-3 text-blue-400"></i>
                    Usage Forecast
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="text-gray-400 text-sm mb-1">Tomorrow's Predicted Usage</div>
                        <div class="text-2xl font-bold text-blue-400" id="forecast-tomorrow">--</div>
                        <div class="text-xs text-gray-500 mt-1" id="forecast-tomorrow-change">Calculating...</div>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="text-gray-400 text-sm mb-1">Next 7 Days Average</div>
                        <div class="text-2xl font-bold text-cyan-400" id="forecast-week">--</div>
                        <div class="text-xs text-gray-500 mt-1" id="forecast-week-change">Calculating...</div>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <div class="text-gray-400 text-sm mb-1">Next Month Estimate</div>
                        <div class="text-2xl font-bold text-purple-400" id="forecast-month">--</div>
                        <div class="text-xs text-gray-500 mt-1" id="forecast-month-change">Calculating...</div>
                    </div>
                </div>
                <canvas id="forecast-chart" class="w-full" height="80"></canvas>
            </div>

            <!-- Cost Prediction -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="dollar-sign" class="w-6 h-6 mr-3 text-green-400"></i>
                    Cost Prediction
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-green-600/20 to-emerald-600/20 border border-green-600/50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-gray-300 text-sm">Tomorrow's Cost</div>
                            <i data-lucide="calendar-days" class="w-4 h-4 text-green-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="cost-tomorrow">৳--</div>
                        <div class="text-xs text-gray-400 mt-1">Based on predicted usage</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-600/20 to-orange-600/20 border border-yellow-600/50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-gray-300 text-sm">This Week</div>
                            <i data-lucide="calendar-range" class="w-4 h-4 text-yellow-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="cost-week">৳--</div>
                        <div class="text-xs text-gray-400 mt-1">7-day projection</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-600/20 to-pink-600/20 border border-red-600/50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-gray-300 text-sm">This Month</div>
                            <i data-lucide="calendar" class="w-4 h-4 text-red-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="cost-month">৳--</div>
                        <div class="text-xs text-gray-400 mt-1">30-day projection</div>
                    </div>
                </div>
            </div>

            <!-- Anomaly Detection -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="activity" class="w-6 h-6 mr-3 text-orange-400"></i>
                    Anomaly Detection
                </h3>
                <div id="anomaly-container" class="space-y-3">
                    <div class="bg-gray-700/30 p-4 rounded-lg text-center">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto text-gray-500 mb-2"></i>
                        <p class="text-gray-400">Analyzing consumption patterns...</p>
                    </div>
                </div>
            </div>

            <!-- Smart Tips -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="lightbulb" class="w-6 h-6 mr-3 text-yellow-400"></i>
                    Smart Energy Tips
                </h3>
                <div id="smart-tips-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700/30 p-4 rounded-lg text-center">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto text-gray-500 mb-2"></i>
                        <p class="text-gray-400">Generating recommendations...</p>
                    </div>
                </div>
            </div>

            <!-- Analysis Summary -->
            <div class="bg-gradient-to-br from-pink-600/20 to-purple-600/20 border border-pink-600/50 p-6 rounded-xl">
                <div class="flex items-start">
                    <i data-lucide="sparkles" class="w-6 h-6 mr-3 text-pink-400 flex-shrink-0 mt-1"></i>
                    <div>
                        <h4 class="text-white font-semibold mb-2">How AI Predictions Work</h4>
                        <p class="text-gray-300 text-sm">Our AI analyzes your historical consumption patterns using machine learning algorithms. It identifies trends, detects anomalies, and generates personalized recommendations to help you save energy and reduce costs. The more data collected, the more accurate the predictions become.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab Content -->
        <div id="content-reports" class="tab-content hidden" style="padding: 2rem;">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <i data-lucide="file-text" class="w-6 h-6 mr-2 text-primary"></i>
                    System Reports & Analytics
                </h2>
                <p class="text-gray-400">Comprehensive performance reports and insights</p>
            </div>

            <!-- Report Period Selector -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-white font-semibold mb-4 flex items-center">
                    <i data-lucide="calendar" class="w-5 h-5 mr-2 text-cyan-400"></i>
                    Report Period
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <button onclick="generateReport('today')" class="bg-gray-700 hover:bg-primary/20 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="sunrise" class="w-4 h-4 mr-2"></i>
                        Today
                    </button>
                    <button onclick="generateReport('week')" class="bg-gray-700 hover:bg-primary/20 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="calendar-days" class="w-4 h-4 mr-2"></i>
                        This Week
                    </button>
                    <button onclick="generateReport('month')" class="bg-gray-700 hover:bg-primary/20 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                        This Month
                    </button>
                    <button onclick="generateReport('year')" class="bg-gray-700 hover:bg-primary/20 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="calendar-range" class="w-4 h-4 mr-2"></i>
                        This Year
                    </button>
                </div>
                
                <!-- Custom Date Range -->
                <div class="border-t border-gray-600 pt-4 mt-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-3 flex items-center">
                        <i data-lucide="calendar-search" class="w-4 h-4 mr-2 text-purple-400"></i>
                        Custom Report Period
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Start Date</label>
                            <input type="date" id="report-start-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none border border-gray-600">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">End Date</label>
                            <input type="date" id="report-end-date" class="w-full bg-gray-700 text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:outline-none border border-gray-600">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateReportByDateRange()" class="w-full bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center font-medium">
                                <i data-lucide="file-bar-chart" class="w-4 h-4 mr-2"></i>
                                Generate Report
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Generate custom reports for any date range
                    </p>
                </div>
            </div>

            <!-- Performance Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-600/20 to-blue-700/20 border border-blue-600/50 p-6 rounded-xl">
                    <div class="flex items-center mb-2">
                        <i data-lucide="zap" class="w-6 h-6 mr-2 text-blue-400"></i>
                        <span class="text-sm text-gray-400 uppercase">Total Energy</span>
                    </div>
                    <p class="text-3xl font-bold text-white"><span id="report-total-energy">--</span> kWh</p>
                    <p class="text-xs text-gray-400 mt-1" id="report-energy-period">Loading...</p>
                </div>

                <div class="bg-gradient-to-br from-green-600/20 to-green-700/20 border border-green-600/50 p-6 rounded-xl">
                    <div class="flex items-center mb-2">
                        <i data-lucide="trending-up" class="w-6 h-6 mr-2 text-green-400"></i>
                        <span class="text-sm text-gray-400 uppercase">Peak Power</span>
                    </div>
                    <p class="text-3xl font-bold text-white"><span id="report-peak-power">--</span> kW</p>
                    <p class="text-xs text-gray-400 mt-1" id="report-peak-time">Loading...</p>
                </div>

                <div class="bg-gradient-to-br from-purple-600/20 to-purple-700/20 border border-purple-600/50 p-6 rounded-xl">
                    <div class="flex items-center mb-2">
                        <i data-lucide="dollar-sign" class="w-6 h-6 mr-2 text-purple-400"></i>
                        <span class="text-sm text-gray-400 uppercase">Cost Saved</span>
                    </div>
                    <p class="text-3xl font-bold text-white">৳<span id="report-cost-saved">--</span></p>
                    <p class="text-xs text-gray-400 mt-1" id="report-savings-info">Loading...</p>
                </div>

                <div class="bg-gradient-to-br from-orange-600/20 to-orange-700/20 border border-orange-600/50 p-6 rounded-xl">
                    <div class="flex items-center mb-2">
                        <i data-lucide="activity" class="w-6 h-6 mr-2 text-orange-400"></i>
                        <span class="text-sm text-gray-400 uppercase">System Health</span>
                    </div>
                    <p class="text-3xl font-bold text-white"><span id="report-health-score">--</span>%</p>
                    <p class="text-xs text-gray-400 mt-1" id="report-health-status">Loading...</p>
                </div>
            </div>

            <!-- Detailed Report Sections -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Performance Analysis -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-cyan-400"></i>
                        Performance Analysis
                    </h3>
                    <div class="space-y-3" id="performance-analysis">
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Average Generation</span>
                            <span class="text-white font-semibold"><span id="report-avg-power">--</span> kW</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Peak Hours</span>
                            <span class="text-white font-semibold" id="report-peak-hours">--</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Total Runtime</span>
                            <span class="text-white font-semibold" id="report-runtime">-- hours</span>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span class="text-gray-400">Efficiency Rating</span>
                            <span class="text-white font-semibold" id="report-efficiency">--%</span>
                        </div>
                    </div>
                </div>

                <!-- Environmental Impact -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i data-lucide="leaf" class="w-5 h-5 mr-2 text-green-400"></i>
                        Environmental Impact
                    </h3>
                    <div class="space-y-3" id="environmental-impact">
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">CO₂ Avoided</span>
                            <span class="text-white font-semibold"><span id="report-co2-avoided">--</span> kg</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Trees Equivalent</span>
                            <span class="text-white font-semibold"><span id="report-trees-equiv">--</span> trees</span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-gray-700">
                            <span class="text-gray-400">Cars Off Road</span>
                            <span class="text-white font-semibold"><span id="report-cars-equiv">--</span> days</span>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span class="text-gray-400">Green Energy %</span>
                            <span class="text-white font-semibold" id="report-green-percent">--%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="mt-6 bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="download" class="w-5 h-5 mr-2 text-blue-400"></i>
                    Export Report
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button onclick="downloadReportsCSV()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-2"></i>
                        Download CSV
                    </button>
                    <button onclick="downloadReportsTXT()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                        Download TXT
                    </button>
                    <button onclick="downloadReportsPDF()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="file-type" class="w-4 h-4 mr-2"></i>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wind Solar Tab Content -->
    <div id="content-windsolar" class="tab-content hidden" style="padding: 2rem;">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-white mb-2">Wind Turbine Performance Data</h2>
                <p class="text-gray-400">Comprehensive wind turbine performance metrics across different wind speeds</p>
            </div>

            <!-- Performance Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-cyan-600/20 to-blue-600/20 border border-cyan-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Max Wind Speed</span>
                        <i data-lucide="wind" class="w-5 h-5 text-cyan-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">5.5 <span class="text-lg text-gray-400">m/s</span></div>
                </div>

                <div class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 border border-purple-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Max RPM (No Load)</span>
                        <i data-lucide="gauge" class="w-5 h-5 text-purple-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">109 <span class="text-lg text-gray-400">RPM</span></div>
                </div>

                <div class="bg-gradient-to-br from-orange-600/20 to-red-600/20 border border-orange-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Max Voltage (No Load)</span>
                        <i data-lucide="zap" class="w-5 h-5 text-orange-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">22.6 <span class="text-lg text-gray-400">V</span></div>
                </div>

                <div class="bg-gradient-to-br from-green-600/20 to-emerald-600/20 border border-green-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Max Power (Load)</span>
                        <i data-lucide="battery-charging" class="w-5 h-5 text-green-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">0.38 <span class="text-lg text-gray-400">W</span></div>
                </div>
            </div>

            <!-- Performance Data Table -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="table" class="w-5 h-5 text-cyan-400"></i>
                    Wind Turbine Performance Datasheet
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="px-4 py-3 text-gray-400 font-semibold" rowspan="2">Wind Speed<br><span class="text-xs">(m/s)</span></th>
                                <th class="px-4 py-3 text-center text-purple-400 font-semibold border-l border-gray-700" colspan="2">RPM</th>
                                <th class="px-4 py-3 text-center text-orange-400 font-semibold border-l border-gray-700" colspan="2">Voltage (V)</th>
                                <th class="px-4 py-3 text-center text-blue-400 font-semibold border-l border-gray-700" colspan="2">Current (mA)</th>
                                <th class="px-4 py-3 text-center text-green-400 font-semibold border-l border-gray-700" colspan="2">Power (Watt)</th>
                            </tr>
                            <tr class="border-b border-gray-700">
                                <th class="px-4 py-2 text-center text-gray-400 text-sm border-l border-gray-700">No Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm">Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm border-l border-gray-700">No Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm">Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm border-l border-gray-700">No Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm">Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm border-l border-gray-700">No Load</th>
                                <th class="px-4 py-2 text-center text-gray-400 text-sm">Load</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">5.5</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">109</td>
                                <td class="px-4 py-3 text-center text-gray-300">66</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">22.6</td>
                                <td class="px-4 py-3 text-center text-gray-300">8.6</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-gray-300">44</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">0.38</td>
                            </tr>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">4.5</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">85.6</td>
                                <td class="px-4 py-3 text-center text-gray-300">55</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">21.5</td>
                                <td class="px-4 py-3 text-center text-gray-300">8.16</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-gray-300">19</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">0.15</td>
                            </tr>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">3.5</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">68</td>
                                <td class="px-4 py-3 text-center text-gray-300">52.5</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">13.5</td>
                                <td class="px-4 py-3 text-center text-gray-300">7.90</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-gray-300">9</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">0.07</td>
                            </tr>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">3.0</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">52.5</td>
                                <td class="px-4 py-3 text-center text-gray-300">46</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">10.5</td>
                                <td class="px-4 py-3 text-center text-gray-300">7.70</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-gray-300">3</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">0.03</td>
                            </tr>
                            <tr class="hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">2.5</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">35</td>
                                <td class="px-4 py-3 text-center text-gray-300">30</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">7</td>
                                <td class="px-4 py-3 text-center text-gray-300">6.50</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-gray-300">1</td>
                                <td class="px-4 py-3 text-center text-gray-300 border-l border-gray-700">0</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">0.006</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Download Options -->
                <div class="mt-4 flex gap-3">
                    <button onclick="downloadWindData('csv')" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download CSV
                    </button>
                    <button onclick="downloadWindData('txt')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Download TXT
                    </button>
                    <button onclick="downloadWindData('pdf')" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="file" class="w-4 h-4"></i>
                        Download PDF
                    </button>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <!-- Chart 1 with Selector -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-5 h-5 text-green-400"></i>
                            <span id="chart1-title">Power Output vs Wind Speed</span>
                        </h3>
                        <select id="chart1-selector" onchange="updateWindChart(1)" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="power">Power (Load)</option>
                            <option value="voltage">Voltage</option>
                            <option value="current">Current</option>
                            <option value="rpm">RPM</option>
                        </select>
                    </div>
                    <div class="h-80">
                        <canvas id="wind-chart-1"></canvas>
                    </div>
                </div>

                <!-- Chart 2 with Selector -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5 text-purple-400"></i>
                            <span id="chart2-title">RPM vs Wind Speed</span>
                        </h3>
                        <select id="chart2-selector" onchange="updateWindChart(2)" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="rpm">RPM</option>
                            <option value="power">Power (Load)</option>
                            <option value="voltage">Voltage</option>
                            <option value="current">Current</option>
                        </select>
                    </div>
                    <div class="h-80">
                        <canvas id="wind-chart-2"></canvas>
                    </div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="bg-gradient-to-br from-cyan-600/20 to-blue-600/20 border border-cyan-600/50 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400"></i>
                    Key Insights
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start gap-3">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Optimal Performance</p>
                            <p class="text-gray-400 text-sm">Peak power output of 0.38W achieved at 5.5 m/s wind speed</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-orange-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Load Impact</p>
                            <p class="text-gray-400 text-sm">Under load, RPM drops to 60% and voltage to 38% of no-load values</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="zap" class="w-5 h-5 text-yellow-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Cut-in Speed</p>
                            <p class="text-gray-400 text-sm">Turbine starts generating measurable power at 2.5 m/s (0.006W)</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Linear Growth</p>
                            <p class="text-gray-400 text-sm">Power output scales proportionally with wind speed increase</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Solar Data Tab Content -->
    <div id="content-solardata" class="tab-content hidden" style="padding: 2rem;">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-white mb-2">Solar Panel Performance Data</h2>
                <p class="text-gray-400">Field measurements of solar panel performance under varying conditions</p>
            </div>

            <!-- Performance Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-yellow-600/20 to-orange-600/20 border border-yellow-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Peak Power</span>
                        <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">31.2 <span class="text-lg text-gray-400">W</span></div>
                </div>

                <div class="bg-gradient-to-br from-blue-600/20 to-cyan-600/20 border border-blue-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Peak Irradiance</span>
                        <i data-lucide="sun" class="w-5 h-5 text-blue-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">232 <span class="text-lg text-gray-400">W/m²</span></div>
                </div>

                <div class="bg-gradient-to-br from-orange-600/20 to-red-600/20 border border-orange-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Max Temperature</span>
                        <i data-lucide="thermometer" class="w-5 h-5 text-orange-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">39.2 <span class="text-lg text-gray-400">°C</span></div>
                </div>

                <div class="bg-gradient-to-br from-green-600/20 to-emerald-600/20 border border-green-600/50 p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Avg Voltage</span>
                        <i data-lucide="battery-charging" class="w-5 h-5 text-green-400"></i>
                    </div>
                    <div class="text-3xl font-bold text-white">23.1 <span class="text-lg text-gray-400">V</span></div>
                </div>
            </div>

            <!-- Performance Data Table -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="table" class="w-5 h-5 text-cyan-400"></i>
                    Solar Panel Measurement Data
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="px-4 py-3 text-gray-400 font-semibold">SI No</th>
                                <th class="px-4 py-3 text-gray-400 font-semibold">Time</th>
                                <th class="px-4 py-3 text-center text-blue-400 font-semibold">Forecast<br>Irradiance<br><span class="text-xs">(W/m²)</span></th>
                                <th class="px-4 py-3 text-center text-cyan-400 font-semibold">Measured<br>Irradiance<br><span class="text-xs">(W/m²)</span></th>
                                <th class="px-4 py-3 text-center text-orange-400 font-semibold">No Load<br>Voltage<br><span class="text-xs">(V)</span></th>
                                <th class="px-4 py-3 text-center text-yellow-400 font-semibold">Load<br>Current<br><span class="text-xs">(A)</span></th>
                                <th class="px-4 py-3 text-center text-green-400 font-semibold">Load<br>Power<br><span class="text-xs">(W)</span></th>
                                <th class="px-4 py-3 text-center text-red-400 font-semibold">Temperature<br><span class="text-xs">(°C)</span></th>
                                <th class="px-4 py-3 text-center text-purple-400 font-semibold">Humidity<br><span class="text-xs">(%)</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">1</td>
                                <td class="px-4 py-3 text-gray-300">1:53 PM</td>
                                <td class="px-4 py-3 text-center text-gray-300">545</td>
                                <td class="px-4 py-3 text-center text-gray-300">232</td>
                                <td class="px-4 py-3 text-center text-gray-300">23.5</td>
                                <td class="px-4 py-3 text-center text-gray-300">2.4</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">31.2</td>
                                <td class="px-4 py-3 text-center text-gray-300">39.2</td>
                                <td class="px-4 py-3 text-center text-gray-300">29</td>
                            </tr>
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">2</td>
                                <td class="px-4 py-3 text-gray-300">3:05 PM</td>
                                <td class="px-4 py-3 text-center text-gray-300">364</td>
                                <td class="px-4 py-3 text-center text-gray-300">182</td>
                                <td class="px-4 py-3 text-center text-gray-300">23.0</td>
                                <td class="px-4 py-3 text-center text-gray-300">1.7</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">22.1</td>
                                <td class="px-4 py-3 text-center text-gray-300">35.6</td>
                                <td class="px-4 py-3 text-center text-gray-300">34</td>
                            </tr>
                            <tr class="hover:bg-gray-800/50 transition-colors">
                                <td class="px-4 py-3 text-white font-bold">3</td>
                                <td class="px-4 py-3 text-gray-300">3:55 PM</td>
                                <td class="px-4 py-3 text-center text-gray-300">152</td>
                                <td class="px-4 py-3 text-center text-gray-300">91</td>
                                <td class="px-4 py-3 text-center text-gray-300">22.8</td>
                                <td class="px-4 py-3 text-center text-gray-300">0.5</td>
                                <td class="px-4 py-3 text-center text-green-400 font-bold">6.14</td>
                                <td class="px-4 py-3 text-center text-gray-300">31.2</td>
                                <td class="px-4 py-3 text-center text-gray-300">47</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Download Options -->
                <div class="mt-4 flex gap-3">
                    <button onclick="downloadSolarData('csv')" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download CSV
                    </button>
                    <button onclick="downloadSolarData('txt')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Download TXT
                    </button>
                    <button onclick="downloadSolarData('pdf')" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="file" class="w-4 h-4"></i>
                        Download PDF
                    </button>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <!-- Power vs Irradiance Chart -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-green-400"></i>
                        Power Output vs Measured Irradiance
                    </h3>
                    <div class="h-80">
                        <canvas id="solar-power-chart"></canvas>
                    </div>
                </div>

                <!-- Temperature & Humidity Chart -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="thermometer" class="w-5 h-5 text-orange-400"></i>
                        Temperature & Humidity Over Time
                    </h3>
                    <div class="h-80">
                        <canvas id="solar-temp-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="bg-gradient-to-br from-yellow-600/20 to-orange-600/20 border border-yellow-600/50 p-6 rounded-xl">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400"></i>
                    Key Insights
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start gap-3">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Peak Performance</p>
                            <p class="text-gray-400 text-sm">Maximum power output of 31.2W at 1:53 PM with 232 W/m² irradiance</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-orange-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Efficiency Decline</p>
                            <p class="text-gray-400 text-sm">Power drops to 6.14W by 3:55 PM as irradiance decreases to 91 W/m²</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="thermometer" class="w-5 h-5 text-red-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Temperature Impact</p>
                            <p class="text-gray-400 text-sm">Higher temperatures (39.2°C) observed during peak irradiance periods</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i data-lucide="droplet" class="w-5 h-5 text-blue-400 mt-1"></i>
                        <div>
                            <p class="text-white font-semibold">Humidity Correlation</p>
                            <p class="text-gray-400 text-sm">Humidity increases from 29% to 47% as temperature decreases</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Tab Content -->
        <div id="content-settings" class="tab-content hidden" style="padding: 2rem;">
        <div class="max-w-4xl mx-auto">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-white mb-2 flex items-center">
                    <i data-lucide="settings" class="w-6 h-6 mr-2 text-primary"></i>
                    Dashboard Settings
                </h2>
                <p class="text-gray-400">Customize your dashboard appearance and preferences</p>
            </div>

            <!-- Theme Settings -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="palette" class="w-5 h-5 mr-2 text-purple-400"></i>
                    Theme & Appearance
                </h3>

                <!-- Theme Mode Selector -->
                <div class="mb-6">
                    <label class="text-gray-300 font-medium mb-3 block">Theme Mode</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setTheme('light')" id="theme-light-btn" class="theme-option bg-gray-700 hover:bg-gray-600 text-white py-4 px-4 rounded-lg transition-all border-2 border-transparent">
                            <i data-lucide="sun" class="w-6 h-6 mx-auto mb-2"></i>
                            <p class="text-sm font-medium">Light</p>
                        </button>
                        <button onclick="setTheme('dark')" id="theme-dark-btn" class="theme-option bg-gray-700 hover:bg-gray-600 text-white py-4 px-4 rounded-lg transition-all border-2 border-primary">
                            <i data-lucide="moon" class="w-6 h-6 mx-auto mb-2"></i>
                            <p class="text-sm font-medium">Dark</p>
                        </button>
                        <button onclick="setTheme('auto')" id="theme-auto-btn" class="theme-option bg-gray-700 hover:bg-gray-600 text-white py-4 px-4 rounded-lg transition-all border-2 border-transparent">
                            <i data-lucide="monitor" class="w-6 h-6 mx-auto mb-2"></i>
                            <p class="text-sm font-medium">Auto</p>
                        </button>
                    </div>
                </div>

                <!-- Accent Color Picker -->
                <div class="mb-6">
                    <label class="text-gray-300 font-medium mb-3 block">Accent Color</label>
                    <div class="grid grid-cols-6 gap-3">
                        <button onclick="setAccentColor('cyan')" class="accent-color-btn w-full aspect-square rounded-lg bg-cyan-500 hover:scale-110 transition-transform" title="Cyan (Default)"></button>
                        <button onclick="setAccentColor('blue')" class="accent-color-btn w-full aspect-square rounded-lg bg-blue-500 hover:scale-110 transition-transform" title="Blue"></button>
                        <button onclick="setAccentColor('purple')" class="accent-color-btn w-full aspect-square rounded-lg bg-purple-500 hover:scale-110 transition-transform" title="Purple"></button>
                        <button onclick="setAccentColor('pink')" class="accent-color-btn w-full aspect-square rounded-lg bg-pink-500 hover:scale-110 transition-transform" title="Pink"></button>
                        <button onclick="setAccentColor('green')" class="accent-color-btn w-full aspect-square rounded-lg bg-green-500 hover:scale-110 transition-transform" title="Green"></button>
                        <button onclick="setAccentColor('orange')" class="accent-color-btn w-full aspect-square rounded-lg bg-orange-500 hover:scale-110 transition-transform" title="Orange"></button>
                    </div>
                </div>

                <!-- Background Color Picker -->
                <div class="mb-6">
                    <label class="text-gray-300 font-medium mb-3 block">Background Color (Dark Theme)</label>
                    <div class="grid grid-cols-6 gap-3">
                        <button onclick="setBackgroundColor('default')" class="bg-color-btn w-full aspect-square rounded-lg bg-gray-900 hover:scale-110 transition-transform border-2 border-primary" title="Default Dark"></button>
                        <button onclick="setBackgroundColor('blue')" class="bg-color-btn w-full aspect-square rounded-lg bg-blue-950 hover:scale-110 transition-transform border-2 border-transparent" title="Dark Blue"></button>
                        <button onclick="setBackgroundColor('purple')" class="bg-color-btn w-full aspect-square rounded-lg bg-purple-950 hover:scale-110 transition-transform border-2 border-transparent" title="Dark Purple"></button>
                        <button onclick="setBackgroundColor('green')" class="bg-color-btn w-full aspect-square rounded-lg bg-green-950 hover:scale-110 transition-transform border-2 border-transparent" title="Dark Green"></button>
                        <button onclick="setBackgroundColor('slate')" class="bg-color-btn w-full aspect-square rounded-lg bg-slate-900 hover:scale-110 transition-transform border-2 border-transparent" title="Slate"></button>
                        <button onclick="setBackgroundColor('neutral')" class="bg-color-btn w-full aspect-square rounded-lg bg-neutral-900 hover:scale-110 transition-transform border-2 border-transparent" title="Neutral"></button>
                    </div>
                </div>

                <!-- Font Size -->
                <div>
                    <label class="text-gray-300 font-medium mb-3 block">Font Size</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setFontSize('small')" id="font-small-btn" class="font-size-btn bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition-all border-2 border-transparent">
                            <p class="text-xs">Small</p>
                        </button>
                        <button onclick="setFontSize('medium')" id="font-medium-btn" class="font-size-btn bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition-all border-2 border-primary">
                            <p class="text-sm">Medium</p>
                        </button>
                        <button onclick="setFontSize('large')" id="font-large-btn" class="font-size-btn bg-gray-700 hover:bg-gray-600 text-white py-3 px-4 rounded-lg transition-all border-2 border-transparent">
                            <p class="text-base">Large</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Display Settings -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 mb-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="layout" class="w-5 h-5 mr-2 text-blue-400"></i>
                    Display Settings
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-gray-300 font-medium">Show Animations</label>
                            <p class="text-xs text-gray-500">Enable smooth transitions and effects</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="animations-toggle" class="sr-only peer" checked onchange="toggleAnimations(this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-gray-300 font-medium">Compact Mode</label>
                            <p class="text-xs text-gray-500">Reduce spacing for more content</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="compact-toggle" class="sr-only peer" onchange="toggleCompactMode(this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-gray-300 font-medium">24-Hour Time Format</label>
                            <p class="text-xs text-gray-500">Use 24-hour clock instead of AM/PM</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="time24-toggle" class="sr-only peer" checked onchange="toggle24HourTime(this.checked)">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                    <i data-lucide="database" class="w-5 h-5 mr-2 text-orange-400"></i>
                    Data Management
                </h3>
                <div class="space-y-3">
                    <button onclick="clearLocalData()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                        Clear Local Data
                    </button>
                    <button onclick="resetSettings()" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>
                        Reset All Settings
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-3">⚠️ Warning: These actions cannot be undone</p>
            </div>
        </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 pt-4 border-t border-gray-700 text-center text-gray-500 text-sm px-8">
            <p>Electrical data sourced from local ESP32. Environmental data sourced from external online API.</p>
        </footer>
    </div>

    <script>
        // --- Configuration (MUST BE AT TOP) ---
        // 🚨 IMPORTANT: Update this with the actual IP address of your ESP8266
        const ESP32_IP_ADDRESS = '192.168.0.105'; 
        const LOCAL_API_URL = `http://${ESP32_IP_ADDRESS}/data`; 
        const CONTROL_API_URL = `http://${ESP32_IP_ADDRESS}/control`;
        
        // 🚨 IMPORTANT: Update this to your solar array's location for accurate weather
        // Location can be changed from the dashboard
        let EXTERNAL_LOCATION = localStorage.getItem('weatherLocation') || 'Sylhet, Bangladesh';
        let cityTimeZone = 'Asia/Dhaka'; // Default timezone for Sylhet, Bangladesh
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Update sidebar item styles
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Highlight active sidebar item based on tab name
            const tabIndex = {
                'dashboard': 1,
                'history': 2,
                'control': 3,
                'alerts': 4,
                'predictions': 5,
                'reports': 6,
                'windsolar': 7,
                'solardata': 8,
                'settings': 9
            };
            
            if (tabIndex[tabName]) {
                document.querySelector(`.sidebar-item:nth-child(${tabIndex[tabName]})`).classList.add('active');
            }
            
            // Initialize wind solar charts if switching to that tab
            if (tabName === 'windsolar') {
                setTimeout(initWindSolarCharts, 100);
            }
            
            // Initialize solar data charts if switching to that tab
            if (tabName === 'solardata') {
                setTimeout(initSolarDataCharts, 100);
            }
            
            // Reinitialize icons
            lucide.createIcons();
        }

        // Historical Data Storage
        let historicalData = [];
        let powerChart = null;

        // Real-Time Charts for Voltage and Current
        let voltageChart = null;
        let currentChart = null;
        let voltageData = [];
        let currentData = [];
        const MAX_REALTIME_POINTS = 12; // 60 seconds at 5-second intervals

        // Save data to localStorage
        function saveDataPoint(data) {
            const dataPoint = {
                timestamp: new Date().toISOString(),
                power: data.power || 0,
                voltage: data.voltage || 0,
                current: data.current || 0,
                frequency: data.frequency || 0,
                energy: data.energy_today || 0
            };
            
            // Get existing data from localStorage
            let stored = localStorage.getItem('solarData');
            let dataArray = stored ? JSON.parse(stored) : [];
            
            // Add new data point
            dataArray.push(dataPoint);
            
            // Keep only last 365 days of data (assuming 5-second intervals, ~6.3M points max)
            const maxPoints = 365 * 24 * 60 * 12; // 365 days at 5-second intervals
            if (dataArray.length > maxPoints) {
                dataArray = dataArray.slice(-maxPoints);
            }
            
            // Save back to localStorage
            try {
                localStorage.setItem('solarData', JSON.stringify(dataArray));
            } catch (e) {
                console.warn('localStorage full, removing old data');
                // If storage full, keep only recent data
                dataArray = dataArray.slice(-Math.floor(maxPoints / 2));
                localStorage.setItem('solarData', JSON.stringify(dataArray));
            }
        }

        // Load historical data for specified time period
        function loadHistory(period) {
            const stored = localStorage.getItem('solarData');
            if (!stored) {
                alert('No historical data available yet. Data is being collected from your ESP32.');
                return;
            }
            
            const allData = JSON.parse(stored);
            const now = new Date();
            let cutoffTime;
            
            // Calculate cutoff time based on period
            switch(period) {
                case '1h': cutoffTime = new Date(now - 1 * 60 * 60 * 1000); break;
                case '2h': cutoffTime = new Date(now - 2 * 60 * 60 * 1000); break;
                case '12h': cutoffTime = new Date(now - 12 * 60 * 60 * 1000); break;
                case '24h': cutoffTime = new Date(now - 24 * 60 * 60 * 1000); break;
                case '7d': cutoffTime = new Date(now - 7 * 24 * 60 * 60 * 1000); break;
                case '30d': cutoffTime = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
                case '365d': cutoffTime = new Date(now - 365 * 24 * 60 * 60 * 1000); break;
            }
            
            // Filter data for the selected period
            const filteredData = allData.filter(d => new Date(d.timestamp) >= cutoffTime);
            
            if (filteredData.length === 0) {
                alert('No data available for this time period yet.');
                return;
            }
            
            // Update statistics
            const powers = filteredData.map(d => d.power);
            const peak = Math.max(...powers);
            const avg = powers.reduce((a, b) => a + b, 0) / powers.length;
            const totalEnergy = filteredData.length > 0 ? filteredData[filteredData.length - 1].energy : 0;
            
            document.getElementById('hist-peak').textContent = peak.toFixed(2);
            document.getElementById('hist-avg').textContent = avg.toFixed(2);
            document.getElementById('hist-total').textContent = totalEnergy.toFixed(2);
            document.getElementById('hist-count').textContent = filteredData.length;
            
            // Update chart
            displayChart(filteredData, period);
            
            // Update table (show last 20 entries)
            displayTable(filteredData.slice(-20).reverse());
        }

        // Display chart with historical data
        function displayChart(data, period) {
            const ctx = document.getElementById('powerChart');
            
            // Destroy existing chart if present
            if (powerChart) {
                powerChart.destroy();
            }
            
            // Prepare data for chart
            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                if (period === '1h' || period === '2h') {
                    return date.toLocaleTimeString();
                } else if (period === '12h' || period === '24h') {
                    return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString();
                }
            });
            
            const powerValues = data.map(d => d.power);
            
            // Create new chart
            powerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Power (kW)',
                        data: powerValues,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e5e7eb' }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(5, 150, 105, 0.2)',
                                    borderColor: 'rgba(5, 150, 105, 0.8)',
                                    borderWidth: 2
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
            
            // Store data for export
            window.powerChartData = data;
        }

        // Initialize Real-Time Charts
        function initRealtimeCharts() {
            const voltageCtx = document.getElementById('voltage-chart');
            const currentCtx = document.getElementById('current-chart');
            
            if (!voltageCtx || !currentCtx) return;

            // Voltage Chart
            voltageChart = new Chart(voltageCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Voltage (V)',
                        data: [],
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    },
                    animation: { duration: 300 }
                }
            });

            // Current Chart
            currentChart = new Chart(currentCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Current (A)',
                        data: [],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    },
                    animation: { duration: 300 }
                }
            });
        }

        // Update Real-Time Charts
        function updateRealtimeCharts(voltage, current) {
            const timestamp = new Date().toLocaleTimeString();
            
            // Add new data points
            voltageData.push(voltage);
            currentData.push(current);
            
            // Keep only last MAX_REALTIME_POINTS
            if (voltageData.length > MAX_REALTIME_POINTS) {
                voltageData.shift();
                currentData.shift();
            }
            
            // Update charts if they exist
            if (voltageChart) {
                voltageChart.data.labels = voltageData.map((_, i) => `${i * 5}s`);
                voltageChart.data.datasets[0].data = voltageData;
                voltageChart.update('none');
            }
            
            if (currentChart) {
                currentChart.data.labels = currentData.map((_, i) => `${i * 5}s`);
                currentChart.data.datasets[0].data = currentData;
                currentChart.update('none');
            }
        }

        // Display data in table
        let currentHistoryData = []; // Store current filtered data for export
        
        function displayTable(data) {
            currentHistoryData = data; // Save for export
            const tbody = document.getElementById('history-table');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700/30';
                row.innerHTML = `
                    <td class="px-4 py-3">${new Date(d.timestamp).toLocaleString()}</td>
                    <td class="px-4 py-3 text-primary font-semibold">${d.power.toFixed(2)}</td>
                    <td class="px-4 py-3">${d.voltage.toFixed(1)}</td>
                    <td class="px-4 py-3">${d.current.toFixed(1)}</td>
                    <td class="px-4 py-3">${d.frequency.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // === DOWNLOAD FUNCTIONS ===
        
        // Download as CSV
        function downloadCSV() {
            if (currentHistoryData.length === 0) {
                alert('No data to export. Please select a time period first.');
                return;
            }
            
            // Create CSV content
            let csv = 'Timestamp,Power (kW),Voltage (V),Current (A),Frequency (Hz),Energy (kWh)\n';
            currentHistoryData.forEach(d => {
                const timestamp = new Date(d.timestamp).toLocaleString();
                csv += `"${timestamp}",${d.power},${d.voltage},${d.current},${d.frequency},${d.energy || 0}\n`;
            });
            
            // Download
            downloadFile(csv, 'power-monitor-data.csv', 'text/csv');
        }

        // Download as JSON
        function downloadJSON() {
            if (currentHistoryData.length === 0) {
                alert('No data to export. Please select a time period first.');
                return;
            }
            
            const json = JSON.stringify(currentHistoryData, null, 2);
            downloadFile(json, 'power-monitor-data.json', 'application/json');
        }

        // Download as PDF
        function downloadPDF() {
            if (currentHistoryData.length === 0) {
                alert('No data to export. Please select a time period first.');
                return;
            }
            
            // Create simple text-based PDF content
            let content = 'SolarGrid Power Monitor - Historical Data\n';
            content += '=========================================\n\n';
            content += `Generated: ${new Date().toLocaleString()}\n`;
            content += `Location: ${EXTERNAL_LOCATION}\n`;
            content += `Total Records: ${currentHistoryData.length}\n\n`;
            
            // Summary statistics
            const powers = currentHistoryData.map(d => d.power);
            const peak = Math.max(...powers);
            const avg = powers.reduce((a, b) => a + b, 0) / powers.length;
            
            content += 'SUMMARY STATISTICS:\n';
            content += '-'.repeat(50) + '\n';
            content += `Peak Power: ${peak.toFixed(2)} kW\n`;
            content += `Average Power: ${avg.toFixed(2)} kW\n`;
            content += `Total Energy: ${currentHistoryData[currentHistoryData.length - 1].energy.toFixed(2)} kWh\n\n`;
            
            content += 'DETAILED DATA:\n';
            content += '-'.repeat(50) + '\n';
            content += 'Timestamp                  | Power  | Voltage | Current | Freq\n';
            content += '-'.repeat(50) + '\n';
            
            currentHistoryData.forEach(d => {
                const time = new Date(d.timestamp).toLocaleString();
                content += `${time.padEnd(26)} | ${d.power.toFixed(2).padEnd(6)} | ${d.voltage.toFixed(1).padEnd(7)} | ${d.current.toFixed(1).padEnd(7)} | ${d.frequency.toFixed(1)}\n`;
            });
            
            downloadFile(content, 'power-monitor-report.txt', 'text/plain');
            alert('PDF export saved as text file. For proper PDF, use browser Print → Save as PDF on this page.');
        }

        // Helper function to trigger download
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- 3. DEVICE CONTROL FUNCTIONS ---
        
        // Control individual device
        async function controlDevice(deviceId, state) {
            const statusText = document.getElementById('control-status-text');
            const indicator = document.getElementById('control-indicator');
            
            try {
                const response = await fetch(CONTROL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: deviceId, state: state ? 'on' : 'off' }),
                    signal: AbortSignal.timeout(3000)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`Device ${deviceId} ${state ? 'ON' : 'OFF'}:`, result);
                
                // Update status
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2 animate-pulse';
                statusText.textContent = `${deviceId} turned ${state ? 'ON' : 'OFF'}`;
                
                // Reset status after 2 seconds
                setTimeout(() => {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    statusText.textContent = 'Connected';
                }, 2000);
                
            } catch (error) {
                console.error(`Error controlling ${deviceId}:`, error);
                indicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'Connection error';
                
                // Revert toggle state
                document.getElementById(deviceId).checked = !state;
            }
        }

        // Control fan speed
        async function controlFanSpeed(fanId, speed) {
            document.getElementById(`${fanId}-speed-value`).textContent = speed;
            
            try {
                const response = await fetch(CONTROL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: fanId, action: 'speed', value: parseInt(speed) }),
                    signal: AbortSignal.timeout(3000)
                });
                
                if (response.ok) {
                    console.log(`${fanId} speed set to ${speed}%`);
                }
            } catch (error) {
                console.error(`Error setting ${fanId} speed:`, error);
            }
        }

        // Emergency shutdown all devices
        async function emergencyShutdown() {
            if (!confirm('Are you sure you want to shut down ALL devices?')) {
                return;
            }
            
            const statusText = document.getElementById('control-status-text');
            const indicator = document.getElementById('control-indicator');
            
            try {
                const response = await fetch(CONTROL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'emergency_shutdown' }),
                    signal: AbortSignal.timeout(3000)
                });
                
                if (response.ok) {
                    // Turn off all toggles
                    document.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
                        toggle.checked = false;
                    });
                    
                    indicator.className = 'w-3 h-3 rounded-full bg-orange-500 mr-2 animate-pulse';
                    statusText.textContent = 'Emergency shutdown executed';
                    alert('All devices have been shut down.');
                }
            } catch (error) {
                console.error('Emergency shutdown error:', error);
                alert('Emergency shutdown failed. Check connection.');
            }
        }

        // Reset all devices
        async function resetDevices() {
            if (!confirm('Reset all devices to default state?')) {
                return;
            }
            
            const statusText = document.getElementById('control-status-text');
            const indicator = document.getElementById('control-indicator');
            
            try {
                const response = await fetch(CONTROL_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset_all' }),
                    signal: AbortSignal.timeout(3000)
                });
                
                if (response.ok) {
                    indicator.className = 'w-3 h-3 rounded-full bg-blue-500 mr-2 animate-pulse';
                    statusText.textContent = 'Devices reset successfully';
                    alert('All devices have been reset.');
                    
                    // Reload device states
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('Reset failed. Check connection.');
            }
        }

        // Check control connection on load
        async function checkControlConnection() {
            const indicator = document.getElementById('control-indicator');
            const statusText = document.getElementById('control-status-text');
            
            try {
                const response = await fetch(`http://${ESP32_IP_ADDRESS}/status`, {
                    signal: AbortSignal.timeout(2000)
                });
                
                if (response.ok) {
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    statusText.textContent = 'Connected - Ready to control';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'Disconnected - Check ESP32';
            }
        }

        // Check connection when Control tab is opened
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'control') {
                checkControlConnection();
            }
        };

        // Timezone mapping for common cities (can be extended)
        const cityTimezones = {
            'sylhet': 'Asia/Dhaka',
            'dhaka': 'Asia/Dhaka',
            'bangladesh': 'Asia/Dhaka',
            'chittagong': 'Asia/Dhaka',
            'new york': 'America/New_York',
            'london': 'Europe/London',
            'tokyo': 'Asia/Tokyo',
            'dubai': 'Asia/Dubai',
            'singapore': 'Asia/Singapore',
            'paris': 'Europe/Paris',
            'sydney': 'Australia/Sydney',
            'los angeles': 'America/Los_Angeles',
            'chicago': 'America/Chicago',
            'mumbai': 'Asia/Kolkata',
            'delhi': 'Asia/Kolkata',
            'india': 'Asia/Kolkata',
            'karachi': 'Asia/Karachi',
            'pakistan': 'Asia/Karachi'
        };
        
        // Get timezone from location string
        function getTimezoneFromLocation(location) {
            const lowerLocation = location.toLowerCase();
            for (const [key, timezone] of Object.entries(cityTimezones)) {
                if (lowerLocation.includes(key)) {
                    return timezone;
                }
            }
            return 'Asia/Dhaka'; // Default fallback
        }
        
        // Update city time display
        function updateCityTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: cityTimeZone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('external-time').textContent = timeString;
            } catch (error) {
                // Fallback to local time if timezone is invalid
                document.getElementById('external-time').textContent = new Date().toLocaleTimeString();
            }
        } 
        
        const MAX_POWER = 5.0; // Max possible power output in kW for the indicator bar

        // Weather API Configuration
        // Option 1: OpenMeteo (Free, no API key needed) - ACTIVE
        // Option 2: Gemini API (requires API key from https://aistudio.google.com/app/apikey)
        const USE_OPENMETEO = true; // Set to false to use Gemini instead
        const apiKey = ""; // Only needed if USE_OPENMETEO = false
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility function for updating system status display
        function setLocalStatus(statusText, isOnline) {
            const statusElement = document.getElementById('local-status');
            if (!statusElement) return;
            
            statusElement.textContent = statusText;
            
            // Update header status indicator
            const headerStatus = document.getElementById('header-status');
            if (headerStatus) {
                const statusDot = headerStatus.querySelector('.w-2.h-2');
                if (statusDot) {
                    if (isOnline) {
                        statusDot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                    } else {
                        statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                    }
                }
            }
        }

        // --- 1. LOCAL DATA FETCH (ESP8266) ---
        // Expects: { power: float, voltage: float, current: float, frequency: float, energy_today: float }
        async function fetchLocalData() {
            try {
                console.log("Attempting to fetch from:", LOCAL_API_URL);
                // Use a short timeout for the local network call
                const response = await fetch(LOCAL_API_URL, { 
                    signal: AbortSignal.timeout(4000),
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("✅ Local Data received:", data);
                console.log("  Power:", data.power, "kW");
                console.log("  Voltage:", data.voltage, "V");
                console.log("  Current:", data.current, "A");
                console.log("  Frequency:", data.frequency, "Hz");
                console.log("  Energy Today:", data.energy_today, "kWh");

                // Save to historical data
                saveDataPoint(data);

                // Check for alerts
                checkAlerts(data);
                lastDataTime = Date.now(); // Update for outage detection

                // 1. Update Core Power
                const livePower = data.power || 0.00;
                document.getElementById('live-power').textContent = livePower.toFixed(2);
                setLocalStatus("Local System Online", true);

                // 2. Update Electrical Metrics
                document.getElementById('metric-voltage').textContent = (data.voltage ? data.voltage.toFixed(1) : '--') + ' V';
                document.getElementById('metric-current').textContent = (data.current ? data.current.toFixed(1) : '--') + ' A';
                document.getElementById('metric-frequency').textContent = (data.frequency ? data.frequency.toFixed(1) : '--') + ' Hz';
                
                // Update real-time charts
                updateRealtimeCharts(data.voltage || 0, data.current || 0);
                
                // Update new UI displays
                if (document.getElementById('metric-voltage-display')) {
                    document.getElementById('metric-voltage-display').textContent = data.voltage ? data.voltage.toFixed(2) : '0.00';
                }
                if (document.getElementById('metric-current-display')) {
                    document.getElementById('metric-current-display').textContent = data.current ? data.current.toFixed(2) : '0.00';
                }
                if (document.getElementById('live-power-display')) {
                    document.getElementById('live-power-display').textContent = livePower.toFixed(2);
                }
                
                // Update battery level (simulate from power data)
                if (document.getElementById('battery-level')) {
                    const batteryPercent = Math.min(100, (livePower / MAX_POWER) * 100);
                    document.getElementById('battery-level').textContent = batteryPercent.toFixed(1);
                    const batteryCircle = document.querySelector('.battery-circle');
                    if (batteryCircle) {
                        batteryCircle.style.setProperty('--battery-percent', batteryPercent + '%');
                    }
                }

                // 3. Update Totals (Today's Yield)
                document.getElementById('energy-today').textContent = (data.energy_today ? data.energy_today.toFixed(1) : '--');
                
                // 4. Update Power Indicator Bar
                const powerPercentage = Math.min(100, (livePower / MAX_POWER) * 100);
                document.getElementById('power-indicator').style.width = `${powerPercentage}%`;

                // 5. Update Last Updated Timestamp
                document.getElementById('last-updated').textContent = `Local update: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error("❌ Could not fetch data from ESP8266:", error);
                console.error("Error details:", error.message);
                console.error("Trying to connect to:", LOCAL_API_URL);
                setLocalStatus("Local Connection Error", false);
                document.getElementById('last-updated').textContent = `Local fetch failed: ${new Date().toLocaleTimeString()}`;
            }
        }

        // --- 2. EXTERNAL DATA FETCH (GEMINI API) ---

        // Helper to extract numeric weather values from text
        function extractWeatherValue(text, regex) {
            const match = text.match(regex);
            if (match && match[1]) {
                return parseFloat(match[1].trim());
            }
            return null;
        }

        async function fetchExternalWeather() {
            // Don't overwrite time - it's updated separately by updateCityTime()
            document.getElementById('external-location').textContent = EXTERNAL_LOCATION;
            
            if (USE_OPENMETEO) {
                // Use OpenMeteo API (free, no API key required)
                await fetchWeatherOpenMeteo();
            } else {
                // Use Gemini API (requires API key)
                await fetchWeatherGemini();
            }
        }

        // Fetch weather using OpenMeteo API (Free, no authentication)
        async function fetchWeatherOpenMeteo() {
            try {
                // Get coordinates for the location using geocoding
                const geocodeUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(EXTERNAL_LOCATION)}&count=1&language=en&format=json`;
                
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();
                
                if (!geocodeData.results || geocodeData.results.length === 0) {
                    throw new Error('Location not found');
                }
                
                const { latitude, longitude } = geocodeData.results[0];
                
                // Get weather data
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`;
                
                const weatherResponse = await fetch(weatherUrl);
                const weatherData = await weatherResponse.json();
                
                const tempC = weatherData.current.temperature_2m;
                const humidity = weatherData.current.relative_humidity_2m;
                
                // Update Environmental Metrics
                document.getElementById('env-temp').textContent = `${tempC.toFixed(1)} °C`;
                document.getElementById('env-humidity').textContent = `${humidity.toFixed(0)} %`;
                
                // Calculate irradiance based on weather
                const tempFactor = Math.max(0, Math.min(1, (tempC - 10) / 30));
                const humidityFactor = Math.max(0, Math.min(1, (100 - humidity) / 80));
                const maxIrradiance = 1000;
                const irradiance = maxIrradiance * tempFactor * humidityFactor * 0.8;
                
                document.getElementById('env-irradiance').textContent = `${Math.round(irradiance)} W/m²`;
                
                console.log('✅ Weather data updated for:', EXTERNAL_LOCATION);
                
            } catch (error) {
                console.error('Could not fetch weather from OpenMeteo:', error);
                document.getElementById('env-temp').textContent = '-- °C';
                document.getElementById('env-humidity').textContent = '-- %';
                document.getElementById('env-irradiance').textContent = '-- W/m²';
            }
        }

        // Fetch weather using Gemini API (Requires API key)
        async function fetchWeatherGemini() {
            const systemPrompt = "Provide the current time, temperature in Celsius, and humidity for the requested location. Respond concisely in a single sentence without preamble or extra explanation.";
            const userQuery = `Current weather (temp in C and humidity percentage) and time for ${EXTERNAL_LOCATION}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                let response;
                let attempts = 0;
                const maxAttempts = 3;
                let delay = 1000;

                while (attempts < maxAttempts) {
                    attempts++;
                    try {
                        response = await fetch(geminiApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break;
                    } catch (e) {
                        // Exponential backoff logic for retries
                        if (attempts < maxAttempts) {
                            console.warn(`External API request failed. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; 
                        } else {
                            throw e;
                        }
                    }
                }

                if (!response.ok) throw new Error(`External API call failed after ${maxAttempts} retries. Status: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                console.log("External Data Text:", text);

                // Extract Temp and Humidity (using regex to pull numbers)
                const tempC = extractWeatherValue(text, /(\d+\.?\d*)\s*°C/i);
                const humidity = extractWeatherValue(text, /(\d+)\s*%/i);
                
                // --- Update Environmental Metrics ---
                document.getElementById('env-temp').textContent = tempC !== null ? `${tempC.toFixed(1)} °C` : '-- °C';
                document.getElementById('env-humidity').textContent = humidity !== null ? `${humidity.toFixed(0)} %` : '-- %';
                
                // Update new UI temperature display
                if (document.getElementById('env-temp-display')) {
                    document.getElementById('env-temp-display').textContent = tempC !== null ? tempC.toFixed(1) : '--';
                }

                // Update Time - try to get city time from API response or use timezone offset
                updateCityTime();

                // --- Derive Irradiance (W/m²) based on External Data ---
                // Simple Heuristic: Higher temp and lower humidity suggests clearer skies and better irradiance.
                let irradiance = 0;
                if (tempC !== null && humidity !== null) {
                    // Normalize temperature (10-40C range mapped to 0-1)
                    const tempFactor = Math.max(0, Math.min(1, (tempC - 10) / 30));
                    // Normalize humidity (100-20% mapped to 0-1, low humidity is good for sunlight)
                    const humidityFactor = Math.max(0, Math.min(1, (100 - humidity) / 80));
                    
                    // Estimate peak irradiance at 1000 W/m²
                    const maxIrradiance = 1000; 
                    irradiance = maxIrradiance * tempFactor * humidityFactor * 0.8; 

                    document.getElementById('env-irradiance').textContent = `${Math.round(irradiance)} W/m²`;
                } else {
                     document.getElementById('env-irradiance').textContent = '-- W/m²';
                }

            } catch (error) {
                console.error("Could not fetch external weather data:", error);
                document.getElementById('external-time').textContent = 'External API Error';
                // Clear weather data if API fails
                document.getElementById('env-temp').textContent = '-- °C';
                document.getElementById('env-humidity').textContent = '-- %';
                document.getElementById('env-irradiance').textContent = '-- W/m²';
            }
        }

        // Update location from user input
        function updateLocation() {
            const locationInput = document.getElementById('location-input');
            const newLocation = locationInput.value.trim();
            
            if (!newLocation) {
                alert('Please enter a valid location');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('weatherLocation', newLocation);
            EXTERNAL_LOCATION = newLocation;
            
            // Update timezone for the new location
            cityTimeZone = getTimezoneFromLocation(newLocation);
            localStorage.setItem('cityTimeZone', cityTimeZone);
            
            // Update display
            document.getElementById('external-location').textContent = newLocation;
            
            // Update time immediately
            updateCityTime();
            
            // Fetch new weather data immediately
            fetchExternalWeather();
            
            // Show success feedback
            const updateBtn = event.target.closest('button');
            const originalHTML = updateBtn.innerHTML;
            updateBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>Updated!';
            updateBtn.classList.add('bg-green-600');
            updateBtn.classList.remove('bg-primary');
            lucide.createIcons();
            
            setTimeout(() => {
                updateBtn.innerHTML = originalHTML;
                updateBtn.classList.remove('bg-green-600');
                updateBtn.classList.add('bg-primary');
                lucide.createIcons();
            }, 2000);
        }

        // Initialize location input on page load
        document.getElementById('location-input').value = EXTERNAL_LOCATION;
        document.getElementById('external-location').textContent = EXTERNAL_LOCATION;
        
        // Load saved timezone or detect from location
        cityTimeZone = localStorage.getItem('cityTimeZone') || getTimezoneFromLocation(EXTERNAL_LOCATION);
        
        // Start live time updates every second
        updateCityTime();
        setInterval(updateCityTime, 1000);

        // --- Execution Loop ---
        
        // Test connection immediately on page load
        console.log("=== ESP8266 Connection Test ===");
        console.log("IP Address:", ESP32_IP_ADDRESS);
        console.log("API URL:", LOCAL_API_URL);
        console.log("Attempting first connection...");
        
        // Initialize real-time charts
        initRealtimeCharts();
        
        // Fetch local data (electrical) more frequently (every 5 seconds)
        fetchLocalData();
        setInterval(fetchLocalData, 5000); 
        
        // Fetch external data (weather) less frequently (every 60 seconds)
        fetchExternalWeather();
        setInterval(fetchExternalWeather, 60000); 

        // === ALERT SYSTEM ===
        
        // Alert settings
        let alertSettings = {
            voltage: { enabled: false, threshold: 200 },
            current: { enabled: false, threshold: 10 },
            outage: { enabled: true },
            email: { enabled: false, address: '' },
            whatsapp: { enabled: false, number: '' },
            sound: { enabled: true },
            dailyReport: false,
            weeklyReport: false
        };

        // Active alerts
        let activeAlerts = [];
        let alertHistory = [];

        // Load alert settings
        function loadAlertSettings() {
            const saved = localStorage.getItem('alertSettings');
            if (saved) {
                alertSettings = JSON.parse(saved);
                
                // Update UI
                document.getElementById('enable-voltage-alert').checked = alertSettings.voltage.enabled;
                document.getElementById('voltage-threshold').value = alertSettings.voltage.threshold;
                document.getElementById('enable-current-alert').checked = alertSettings.current.enabled;
                document.getElementById('current-threshold').value = alertSettings.current.threshold;
                document.getElementById('enable-outage-alert').checked = alertSettings.outage.enabled;
                document.getElementById('enable-email-alert').checked = alertSettings.email.enabled;
                document.getElementById('alert-email').value = alertSettings.email.address;
                document.getElementById('enable-whatsapp-alert').checked = alertSettings.whatsapp.enabled;
                document.getElementById('alert-whatsapp').value = alertSettings.whatsapp.number;
                document.getElementById('enable-sound-alert').checked = alertSettings.sound.enabled;
                document.getElementById('daily-report').checked = alertSettings.dailyReport;
                document.getElementById('weekly-report').checked = alertSettings.weeklyReport;
            }

            // Load alert history
            const history = localStorage.getItem('alertHistory');
            if (history) {
                alertHistory = JSON.parse(history);
                displayAlertHistory();
            }
        }

        // Save alert settings
        function saveAlertSettings() {
            alertSettings = {
                voltage: {
                    enabled: document.getElementById('enable-voltage-alert').checked,
                    threshold: parseFloat(document.getElementById('voltage-threshold').value)
                },
                current: {
                    enabled: document.getElementById('enable-current-alert').checked,
                    threshold: parseFloat(document.getElementById('current-threshold').value)
                },
                outage: {
                    enabled: document.getElementById('enable-outage-alert').checked
                },
                email: {
                    enabled: document.getElementById('enable-email-alert').checked,
                    address: document.getElementById('alert-email').value
                },
                whatsapp: {
                    enabled: document.getElementById('enable-whatsapp-alert').checked,
                    number: document.getElementById('alert-whatsapp').value
                },
                sound: {
                    enabled: document.getElementById('enable-sound-alert').checked
                },
                dailyReport: document.getElementById('daily-report').checked,
                weeklyReport: document.getElementById('weekly-report').checked
            };

            localStorage.setItem('alertSettings', JSON.stringify(alertSettings));
        }

        // Check for alerts
        function checkAlerts(data) {
            const newAlerts = [];

            // Low voltage alert
            if (alertSettings.voltage.enabled && data.voltage < alertSettings.voltage.threshold) {
                newAlerts.push({
                    type: 'voltage',
                    level: 'warning',
                    message: `Low Voltage: ${data.voltage.toFixed(1)}V (Threshold: ${alertSettings.voltage.threshold}V)`,
                    value: data.voltage
                });
            }

            // Overcurrent alert
            if (alertSettings.current.enabled && data.current > alertSettings.current.threshold) {
                newAlerts.push({
                    type: 'current',
                    level: 'danger',
                    message: `Overcurrent: ${data.current.toFixed(1)}A (Threshold: ${alertSettings.current.threshold}A)`,
                    value: data.current
                });
            }

            // Process new alerts
            newAlerts.forEach(alert => {
                // Check if alert already exists
                const exists = activeAlerts.find(a => a.type === alert.type);
                if (!exists) {
                    alert.timestamp = Date.now();
                    activeAlerts.push(alert);
                    logAlert(alert);
                    showNotification(alert);
                }
            });

            // Remove resolved alerts
            activeAlerts = activeAlerts.filter(alert => {
                if (alert.type === 'voltage' && data.voltage >= alertSettings.voltage.threshold) {
                    logAlert({...alert, message: 'Voltage restored to normal', level: 'success'});
                    return false;
                }
                if (alert.type === 'current' && data.current <= alertSettings.current.threshold) {
                    logAlert({...alert, message: 'Current back to normal', level: 'success'});
                    return false;
                }
                return true;
            });

            updateActiveAlerts();
        }

        // Show notification
        function showNotification(alert) {
            // Play sound if enabled
            if (alertSettings.sound.enabled) {
                playAlertSound(alert.level);
            }

            // Browser notification
            if (Notification.permission === 'granted') {
                new Notification('SolarGrid Alert', {
                    body: alert.message,
                    icon: '⚡',
                    tag: alert.type
                });
            }

            // Send email if enabled
            if (alertSettings.email.enabled && alertSettings.email.address) {
                sendEmailAlert(alert);
            }

            // Send WhatsApp if enabled
            if (alertSettings.whatsapp.enabled && alertSettings.whatsapp.number) {
                sendWhatsAppAlert(alert);
            }
        }

        // Play alert sound
        function playAlertSound(level) {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            oscillator.frequency.value = level === 'danger' ? 800 : 600;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
            
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.5);
        }

        // Log alert to history
        function logAlert(alert) {
            alertHistory.unshift({
                ...alert,
                timestamp: alert.timestamp || Date.now()
            });

            // Keep only last 100 alerts
            if (alertHistory.length > 100) {
                alertHistory = alertHistory.slice(0, 100);
            }

            localStorage.setItem('alertHistory', JSON.stringify(alertHistory));
            displayAlertHistory();
        }

        // Update active alerts display
        function updateActiveAlerts() {
            const container = document.getElementById('active-alerts');
            const badge = document.getElementById('alert-badge');

            if (activeAlerts.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-400 text-center py-8">No active alerts</p>';
                if (badge) badge.classList.add('hidden');
            } else {
                if (badge) {
                    badge.classList.remove('hidden');
                    badge.textContent = activeAlerts.length;
                }
                
                if (container) {
                    container.innerHTML = activeAlerts.map(alert => `
                    <div class="p-4 rounded-lg border ${alert.level === 'danger' ? 'bg-red-900/20 border-red-600' : 'bg-yellow-900/20 border-yellow-600'}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-2 ${alert.level === 'danger' ? 'text-red-400' : 'text-yellow-400'}"></i>
                                    <span class="font-semibold ${alert.level === 'danger' ? 'text-red-400' : 'text-yellow-400'}">${alert.message}</span>
                                </div>
                                <p class="text-sm text-gray-400 ml-7">${new Date(alert.timestamp).toLocaleString()}</p>
                            </div>
                            <button onclick="dismissAlert('${alert.type}')" class="text-gray-400 hover:text-white">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    `).join('');
                    lucide.createIcons();
                }
            }
        }

        // Display alert history
        function displayAlertHistory() {
            const container = document.getElementById('alert-history');
            
            if (alertHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No alert history</p>';
            } else {
                container.innerHTML = alertHistory.map(alert => `
                    <div class="p-3 rounded-lg bg-gray-700/30 border border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <span class="text-gray-300">${alert.message}</span>
                                <p class="text-xs text-gray-500 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${
                                alert.level === 'danger' ? 'bg-red-900/30 text-red-400' :
                                alert.level === 'success' ? 'bg-green-900/30 text-green-400' :
                                'bg-yellow-900/30 text-yellow-400'
                            }">${alert.level}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Dismiss alert
        function dismissAlert(type) {
            activeAlerts = activeAlerts.filter(a => a.type !== type);
            updateActiveAlerts();
        }

        // Clear alert history
        function clearAlertHistory() {
            if (confirm('Clear all alert history?')) {
                alertHistory = [];
                localStorage.removeItem('alertHistory');
                displayAlertHistory();
            }
        }

        // Send email alert (requires EmailJS setup)
        function sendEmailAlert(alert) {
            console.log('Email alert would be sent:', alert);
            // To enable email, setup EmailJS: https://www.emailjs.com/
            // Then use: emailjs.send(serviceID, templateID, {message: alert.message});
        }

        // Send WhatsApp alert
        function sendWhatsAppAlert(alert) {
            const phone = alertSettings.whatsapp.number.replace(/[^0-9+]/g, ''); // Clean phone number
            
            // Create alert message
            const message = `🔔 *SolarGrid Alert*\n\n` +
                          `*Type:* ${alert.type.toUpperCase()}\n` +
                          `*Level:* ${alert.level.toUpperCase()}\n` +
                          `*Message:* ${alert.message}\n` +
                          `*Time:* ${new Date(alert.timestamp).toLocaleString()}\n\n` +
                          `Please check your dashboard for more details.`;
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // Create WhatsApp link (wa.me format)
            const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
            
            // Open WhatsApp in new tab
            window.open(whatsappUrl, '_blank');
            
            console.log('WhatsApp alert sent to:', phone);
        }

        // Generate daily report
        function generateDailyReport(format = 'csv') {
            const today = new Date().toLocaleDateString();
            const stored = localStorage.getItem('solarData');
            
            if (!stored) {
                alert('No data available for report');
                return;
            }

            const data = JSON.parse(stored);
            const todayData = data.filter(d => {
                const date = new Date(d.timestamp).toLocaleDateString();
                return date === today;
            });

            if (todayData.length === 0) {
                alert('No data collected today yet');
                return;
            }

            // Calculate statistics
            const powers = todayData.map(d => d.power);
            const peak = Math.max(...powers);
            const avg = powers.reduce((a, b) => a + b, 0) / powers.length;
            const totalEnergy = todayData[todayData.length - 1].energy || 0;

            // Alert summary
            const todayAlerts = alertHistory.filter(a => {
                const date = new Date(a.timestamp).toLocaleDateString();
                return date === today;
            });

            if (format === 'csv') {
                generateCSVReport(todayData, peak, avg, totalEnergy, todayAlerts);
            } else if (format === 'pdf') {
                generatePDFReport(todayData, peak, avg, totalEnergy, todayAlerts);
            }
        }

        // Generate CSV report
        function generateCSVReport(todayData, peak, avg, totalEnergy, todayAlerts) {
            const today = new Date().toLocaleDateString();
            
            // Report metadata
            let csv = 'SOLARGRID DAILY ENERGY REPORT\n';
            csv += `Date,${today}\n`;
            csv += `Location,${EXTERNAL_LOCATION}\n`;
            csv += `Generated,${new Date().toLocaleString()}\n`;
            csv += '\n';
            
            // Performance Summary
            csv += 'PERFORMANCE SUMMARY\n';
            csv += 'Metric,Value,Unit\n';
            csv += `Peak Power,${peak.toFixed(2)},kW\n`;
            csv += `Average Power,${avg.toFixed(2)},kW\n`;
            csv += `Total Energy,${totalEnergy.toFixed(2)},kWh\n`;
            csv += `Data Points,${todayData.length},readings\n`;
            csv += '\n';
            
            // Financial Impact
            csv += 'FINANCIAL IMPACT\n';
            csv += 'Category,Amount,Currency\n';
            csv += `Energy Savings,${(totalEnergy * 8).toFixed(0)},BDT\n`;
            csv += `Monthly Projection,${(totalEnergy * 8 * 30).toFixed(0)},BDT\n`;
            csv += `Annual Projection,${(totalEnergy * 8 * 365).toFixed(0)},BDT\n`;
            csv += '\n';
            
            // Environmental Impact
            csv += 'ENVIRONMENTAL IMPACT\n';
            csv += 'Metric,Value,Unit\n';
            csv += `CO2 Avoided,${(totalEnergy * 0.85).toFixed(2)},kg\n`;
            csv += `Trees Equivalent,${(totalEnergy * 0.02).toFixed(1)},trees\n`;
            csv += '\n';
            
            // Alert Summary
            csv += 'ALERT SUMMARY\n';
            csv += 'Type,Count\n';
            csv += `Total Alerts,${todayAlerts.length}\n`;
            csv += `Critical,${todayAlerts.filter(a => a.level === 'danger').length}\n`;
            csv += `Warnings,${todayAlerts.filter(a => a.level === 'warning').length}\n`;
            csv += `Success,${todayAlerts.filter(a => a.level === 'success').length}\n`;
            csv += '\n';
            
            // Detailed Data
            csv += 'DETAILED POWER DATA\n';
            csv += 'Timestamp,Power (kW),Voltage (V),Current (A),Frequency (Hz),Energy (kWh)\n';
            todayData.forEach(d => {
                const timestamp = new Date(d.timestamp).toLocaleString();
                csv += `"${timestamp}",${d.power.toFixed(3)},${d.voltage.toFixed(2)},${d.current.toFixed(2)},${d.frequency.toFixed(1)},${(d.energy || 0).toFixed(3)}\n`;
            });
            
            // Alert Details
            if (todayAlerts.length > 0) {
                csv += '\nALERT DETAILS\n';
                csv += 'Timestamp,Type,Level,Message\n';
                todayAlerts.forEach(a => {
                    const timestamp = new Date(a.timestamp).toLocaleString();
                    csv += `"${timestamp}",${a.type},${a.level},"${a.message}"\n`;
                });
            }
            
            downloadFile(csv, `daily-report-${today.replace(/\//g, '-')}.csv`, 'text/csv');
        }

        // Generate PDF-style text report
        function generatePDFReport(todayData, peak, avg, totalEnergy, todayAlerts) {
            const today = new Date().toLocaleDateString();
            
            let report = '';
            report += '╔═══════════════════════════════════════════════════════════════╗\n';
            report += '║         SOLARGRID DAILY ENERGY REPORT                         ║\n';
            report += '╚═══════════════════════════════════════════════════════════════╝\n\n';
            
            report += `📅 Date: ${today}\n`;
            report += `📍 Location: ${EXTERNAL_LOCATION}\n`;
            report += `⏰ Generated: ${new Date().toLocaleString()}\n`;
            report += `${'-'.repeat(65)}\n\n`;
            
            // Performance Summary
            report += '⚡ PERFORMANCE SUMMARY\n';
            report += '─'.repeat(65) + '\n';
            report += `   Peak Power:        ${peak.toFixed(2)} kW\n`;
            report += `   Average Power:     ${avg.toFixed(2)} kW\n`;
            report += `   Total Energy:      ${totalEnergy.toFixed(2)} kWh\n`;
            report += `   Data Points:       ${todayData.length} readings\n`;
            report += `   Uptime:            ${((todayData.length * 5) / 60).toFixed(1)} minutes\n\n`;
            
            // Financial Impact
            report += '💰 FINANCIAL IMPACT\n';
            report += '─'.repeat(65) + '\n';
            report += `   Today's Savings:   ৳${(totalEnergy * 8).toFixed(0)} BDT\n`;
            report += `   Monthly Estimate:  ৳${(totalEnergy * 8 * 30).toFixed(0)} BDT\n`;
            report += `   Annual Estimate:   ৳${(totalEnergy * 8 * 365).toFixed(0)} BDT\n`;
            report += `   Rate per kWh:      ৳8.00 BDT\n\n`;
            
            // Environmental Impact
            report += '🌱 ENVIRONMENTAL IMPACT\n';
            report += '─'.repeat(65) + '\n';
            report += `   CO₂ Avoided:       ${(totalEnergy * 0.85).toFixed(2)} kg\n`;
            report += `   Trees Equivalent:  ${(totalEnergy * 0.02).toFixed(1)} trees\n`;
            report += `   Coal Not Burned:   ${(totalEnergy * 0.5).toFixed(2)} kg\n`;
            report += `   Cars Off Road:     ${(totalEnergy * 0.001).toFixed(2)} days\n\n`;
            
            // Alert Summary
            report += '🔔 ALERT SUMMARY\n';
            report += '─'.repeat(65) + '\n';
            report += `   Total Alerts:      ${todayAlerts.length}\n`;
            report += `   ⚠️  Critical:        ${todayAlerts.filter(a => a.level === 'danger').length}\n`;
            report += `   ⚡ Warnings:        ${todayAlerts.filter(a => a.level === 'warning').length}\n`;
            report += `   ✅ Resolved:        ${todayAlerts.filter(a => a.level === 'success').length}\n\n`;
            
            // Hourly Breakdown
            report += '📊 HOURLY BREAKDOWN\n';
            report += '─'.repeat(65) + '\n';
            const hourlyData = {};
            todayData.forEach(d => {
                const hour = new Date(d.timestamp).getHours();
                if (!hourlyData[hour]) hourlyData[hour] = { total: 0, count: 0 };
                hourlyData[hour].total += d.power;
                hourlyData[hour].count++;
            });
            
            for (let hour = 0; hour < 24; hour++) {
                if (hourlyData[hour]) {
                    const avgPower = hourlyData[hour].total / hourlyData[hour].count;
                    const bar = '█'.repeat(Math.round(avgPower * 20));
                    report += `   ${String(hour).padStart(2, '0')}:00  ${bar} ${avgPower.toFixed(2)} kW\n`;
                }
            }
            report += '\n';
            
            // Recent Alerts
            if (todayAlerts.length > 0) {
                report += '⚠️  RECENT ALERTS\n';
                report += '─'.repeat(65) + '\n';
                todayAlerts.slice(0, 10).forEach(a => {
                    const time = new Date(a.timestamp).toLocaleTimeString();
                    const icon = a.level === 'danger' ? '🔴' : a.level === 'warning' ? '🟡' : '🟢';
                    report += `   ${icon} ${time} - ${a.message}\n`;
                });
                report += '\n';
            }
            
            // Footer
            report += '─'.repeat(65) + '\n';
            report += 'Generated by SolarGrid Monitoring Dashboard\n';
            report += 'For detailed data analysis, export as CSV format\n';
            report += '═'.repeat(65) + '\n';
            
            downloadFile(report, `daily-report-${today.replace(/\//g, '-')}.txt`, 'text/plain');
            alert('PDF-style report downloaded as text file.\n\nFor proper PDF, use your browser\'s Print → Save as PDF feature.');
        }

        // Check for connection outage
        let lastDataTime = Date.now();
        setInterval(() => {
            const timeSinceData = Date.now() - lastDataTime;
            if (timeSinceData > 15000 && alertSettings.outage.enabled) { // 15 seconds
                const outageAlert = activeAlerts.find(a => a.type === 'outage');
                if (!outageAlert) {
                    const alert = {
                        type: 'outage',
                        level: 'danger',
                        message: 'ESP8266 Connection Lost',
                        timestamp: Date.now()
                    };
                    activeAlerts.push(alert);
                    logAlert(alert);
                    showNotification(alert);
                    updateActiveAlerts();
                }
            } else {
                // Remove outage alert if connection restored
                const outageIndex = activeAlerts.findIndex(a => a.type === 'outage');
                if (outageIndex !== -1) {
                    logAlert({
                        type: 'outage',
                        message: 'ESP8266 Connection Restored',
                        level: 'success',
                        timestamp: Date.now()
                    });
                    activeAlerts.splice(outageIndex, 1);
                    updateActiveAlerts();
                }
            }
        }, 5000);

        // Request notification permission
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize alerts
        loadAlertSettings();

        // ==================== DEVICE SCHEDULING & AUTOMATION ====================

        // Schedules storage
        let deviceSchedules = [];

        // Device name mapping
        const deviceNames = {
            'light1': 'Living Room Light',
            'light2': 'Bedroom Light',
            'light3': 'Kitchen Light',
            'fan1': 'Ceiling Fan 1',
            'fan2': 'Ceiling Fan 2',
            'motor1': 'Water Pump',
            'motor2': 'Garage Door',
            'outlet1': 'Smart Outlet 1',
            'outlet2': 'Smart Outlet 2'
        };

        // Load schedules from localStorage
        function loadSchedules() {
            const saved = localStorage.getItem('deviceSchedules');
            if (saved) {
                deviceSchedules = JSON.parse(saved);
                displaySchedules();
            }
        }

        // Save schedules to localStorage
        function saveSchedules() {
            localStorage.setItem('deviceSchedules', JSON.stringify(deviceSchedules));
            displaySchedules();
        }

        // Toggle schedule mode (single action vs start/stop)
        function toggleScheduleMode() {
            const mode = document.getElementById('schedule-mode').value;
            const singleTime = document.getElementById('single-time-container');
            const startTime = document.getElementById('start-time-container');
            const stopTime = document.getElementById('stop-time-container');
            const actionContainer = document.getElementById('action-container');

            if (mode === 'duration') {
                // Show start/stop times, hide single time and action
                singleTime.classList.add('hidden');
                startTime.classList.remove('hidden');
                stopTime.classList.remove('hidden');
                actionContainer.classList.add('hidden');
            } else {
                // Show single time and action, hide start/stop
                singleTime.classList.remove('hidden');
                startTime.classList.add('hidden');
                stopTime.classList.add('hidden');
                actionContainer.classList.remove('hidden');
            }
        }

        // Toggle custom days selector
        function toggleCustomDays() {
            const repeatType = document.getElementById('schedule-repeat').value;
            const customDays = document.getElementById('custom-days-selector');
            if (repeatType === 'custom') {
                customDays.classList.remove('hidden');
            } else {
                customDays.classList.add('hidden');
            }
        }

        // Add new schedule
        function addSchedule() {
            const device = document.getElementById('schedule-device').value;
            const mode = document.getElementById('schedule-mode').value;
            const repeat = document.getElementById('schedule-repeat').value;

            let days = [];
            if (repeat === 'custom') {
                const checkboxes = document.querySelectorAll('.schedule-day:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one day');
                    return;
                }
                days = Array.from(checkboxes).map(cb => parseInt(cb.value));
            } else if (repeat === 'weekdays') {
                days = [1, 2, 3, 4, 5]; // Mon-Fri
            } else if (repeat === 'weekends') {
                days = [0, 6]; // Sun, Sat
            } else if (repeat === 'daily') {
                days = [0, 1, 2, 3, 4, 5, 6]; // All days
            } else if (repeat === 'once') {
                days = []; // Will run once
            }

            if (mode === 'duration') {
                // Start & Stop time mode
                const startTime = document.getElementById('schedule-start-time').value;
                const stopTime = document.getElementById('schedule-stop-time').value;

                if (!startTime || !stopTime) {
                    alert('Please select both start and stop times');
                    return;
                }

                // Create two schedules: one for ON, one for OFF
                const startSchedule = {
                    id: Date.now(),
                    device: device,
                    deviceName: deviceNames[device],
                    action: 'on',
                    time: startTime,
                    repeat: repeat,
                    days: days,
                    enabled: true,
                    lastRun: null,
                    pairedWith: Date.now() + 1 // Link to stop schedule
                };

                const stopSchedule = {
                    id: Date.now() + 1,
                    device: device,
                    deviceName: deviceNames[device],
                    action: 'off',
                    time: stopTime,
                    repeat: repeat,
                    days: days,
                    enabled: true,
                    lastRun: null,
                    pairedWith: Date.now() // Link to start schedule
                };

                deviceSchedules.push(startSchedule);
                deviceSchedules.push(stopSchedule);
                saveSchedules();

                // Reset form
                document.getElementById('schedule-start-time').value = '';
                document.getElementById('schedule-stop-time').value = '';

                alert(`Duration schedule added: ${startSchedule.deviceName} will turn ON at ${startTime} and OFF at ${stopTime}`);
            } else {
                // Single action mode
                const action = document.getElementById('schedule-action').value;
                const time = document.getElementById('schedule-time').value;

                if (!time) {
                    alert('Please select a time for the schedule');
                    return;
                }

                const schedule = {
                    id: Date.now(),
                    device: device,
                    deviceName: deviceNames[device],
                    action: action,
                    time: time,
                    repeat: repeat,
                    days: days,
                    enabled: true,
                    lastRun: null
                };

                deviceSchedules.push(schedule);
                saveSchedules();

                // Reset form
                document.getElementById('schedule-time').value = '';

                alert(`Schedule added: ${schedule.deviceName} will turn ${action.toUpperCase()} at ${time}`);
            }
            
            document.getElementById('schedule-repeat').value = 'once';
            document.querySelectorAll('.schedule-day').forEach(cb => cb.checked = false);
            document.getElementById('custom-days-selector').classList.add('hidden');
            lucide.createIcons();
        }

        // Display schedules
        function displaySchedules() {
            const container = document.getElementById('schedules-list');
            const counter = document.getElementById('schedule-count');

            counter.textContent = deviceSchedules.length;

            if (deviceSchedules.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No schedules created yet</p>';
                return;
            }

            // Group paired schedules
            const displayed = new Set();
            const html = [];

            deviceSchedules.forEach(schedule => {
                if (displayed.has(schedule.id)) return;

                const repeatText = schedule.repeat === 'once' ? 'Once' :
                                 schedule.repeat === 'daily' ? 'Daily' :
                                 schedule.repeat === 'weekdays' ? 'Weekdays' :
                                 schedule.repeat === 'weekends' ? 'Weekends' :
                                 'Custom';

                // Check if this is part of a paired schedule
                if (schedule.pairedWith) {
                    const paired = deviceSchedules.find(s => s.id === schedule.pairedWith);
                    if (paired && schedule.action === 'on') {
                        // Display as a duration schedule (start-stop)
                        displayed.add(schedule.id);
                        displayed.add(paired.id);
                        
                        html.push(`
                            <div class="bg-gray-700/50 p-3 rounded-lg flex items-center justify-between border-l-4 border-purple-500">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="timer" class="w-4 h-4 text-purple-400"></i>
                                        <span class="text-white font-medium">${schedule.deviceName}</span>
                                        <span class="text-xs px-2 py-0.5 rounded bg-purple-900/30 text-purple-400">DURATION</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        <i data-lucide="play" class="w-3 h-3 inline text-green-400"></i> ON: ${schedule.time} → 
                                        <i data-lucide="square" class="w-3 h-3 inline text-red-400"></i> OFF: ${paired.time} • 
                                        <i data-lucide="repeat" class="w-3 h-3 inline"></i> ${repeatText}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${schedule.enabled ? 'checked' : ''} 
                                               onchange="togglePairedSchedule(${schedule.id})" 
                                               class="sr-only peer">
                                        <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                                    </label>
                                    <button onclick="deletePairedSchedule(${schedule.id})" class="text-red-400 hover:text-red-300 p-1">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `);
                        return;
                    }
                }

                // Display as single action schedule
                if (!schedule.pairedWith || schedule.action === 'off') {
                    displayed.add(schedule.id);
                    
                    html.push(`
                        <div class="bg-gray-700/50 p-3 rounded-lg flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="${schedule.action === 'on' ? 'power' : 'power-off'}" class="w-4 h-4 ${schedule.action === 'on' ? 'text-green-400' : 'text-red-400'}"></i>
                                    <span class="text-white font-medium">${schedule.deviceName}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${schedule.action === 'on' ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}">${schedule.action.toUpperCase()}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    <i data-lucide="clock" class="w-3 h-3 inline"></i> ${schedule.time} • 
                                    <i data-lucide="repeat" class="w-3 h-3 inline"></i> ${repeatText}
                                    ${schedule.lastRun ? ` • Last: ${new Date(schedule.lastRun).toLocaleString()}` : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${schedule.enabled ? 'checked' : ''} 
                                       onchange="toggleSchedule(${schedule.id})" 
                                       class="sr-only peer">
                                    <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                <button onclick="deleteSchedule(${schedule.id})" class="text-red-400 hover:text-red-300 p-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `);
                }
            });

            container.innerHTML = html.join('');
            lucide.createIcons();
        }

        // Toggle paired schedule enabled/disabled
        function togglePairedSchedule(scheduleId) {
            const schedule = deviceSchedules.find(s => s.id === scheduleId);
            if (schedule && schedule.pairedWith) {
                const paired = deviceSchedules.find(s => s.id === schedule.pairedWith);
                const newState = !schedule.enabled;
                schedule.enabled = newState;
                if (paired) paired.enabled = newState;
                saveSchedules();
            }
        }

        // Delete paired schedule
        function deletePairedSchedule(scheduleId) {
            if (confirm('Delete this duration schedule?')) {
                const schedule = deviceSchedules.find(s => s.id === scheduleId);
                if (schedule && schedule.pairedWith) {
                    deviceSchedules = deviceSchedules.filter(s => s.id !== scheduleId && s.id !== schedule.pairedWith);
                    saveSchedules();
                }
            }
        }

        // Toggle schedule enabled/disabled
        function toggleSchedule(scheduleId) {
            const schedule = deviceSchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.enabled = !schedule.enabled;
                saveSchedules();
            }
        }

        // Delete schedule
        function deleteSchedule(scheduleId) {
            if (confirm('Delete this schedule?')) {
                deviceSchedules = deviceSchedules.filter(s => s.id !== scheduleId);
                saveSchedules();
            }
        }

        // Check and execute schedules
        function checkSchedules() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const currentDay = now.getDay();

            deviceSchedules.forEach(schedule => {
                if (!schedule.enabled) return;

                // Check if time matches
                if (schedule.time !== currentTime) return;

                // Check if already ran in this minute
                const lastRun = schedule.lastRun ? new Date(schedule.lastRun) : null;
                if (lastRun && lastRun.getHours() === now.getHours() && lastRun.getMinutes() === now.getMinutes()) {
                    return; // Already ran this minute
                }

                // Check if day matches
                let shouldRun = false;
                if (schedule.repeat === 'once') {
                    shouldRun = !schedule.lastRun; // Only if never run before
                } else if (schedule.repeat === 'daily') {
                    shouldRun = true;
                } else if (schedule.days.includes(currentDay)) {
                    shouldRun = true;
                }

                if (shouldRun) {
                    // Execute the schedule
                    console.log(`Executing schedule: ${schedule.deviceName} ${schedule.action} at ${currentTime}`);
                    
                    // Control the device
                    const state = schedule.action === 'on';
                    controlDevice(schedule.device, state);

                    // Update last run time
                    schedule.lastRun = now.getTime();
                    
                    // If it's a "once" schedule, disable it
                    if (schedule.repeat === 'once') {
                        schedule.enabled = false;
                    }
                    
                    saveSchedules();

                    // Show notification
                    if (Notification.permission === 'granted') {
                        new Notification('Schedule Executed', {
                            body: `${schedule.deviceName} turned ${schedule.action.toUpperCase()}`,
                            icon: '⏰'
                        });
                    }
                }
            });
        }

        // Smart Scenes
        function activateScene(sceneName) {
            console.log(`Activating scene: ${sceneName}`);
            
            switch(sceneName) {
                case 'morning':
                    // All lights ON, fans OFF
                    controlDevice('light1', true);
                    controlDevice('light2', true);
                    controlDevice('light3', true);
                    setFanSpeed('fan1', 0);
                    setFanSpeed('fan2', 0);
                    break;
                    
                case 'work':
                    // Office lights ON, fan at 50%
                    controlDevice('light1', true);
                    controlDevice('light2', false);
                    controlDevice('light3', true);
                    setFanSpeed('fan1', 50);
                    setFanSpeed('fan2', 0);
                    break;
                    
                case 'evening':
                    // Living room lights ON
                    controlDevice('light1', true);
                    controlDevice('light2', false);
                    controlDevice('light3', false);
                    setFanSpeed('fan1', 30);
                    break;
                    
                case 'sleep':
                    // All lights OFF, fans at 30%
                    controlDevice('light1', false);
                    controlDevice('light2', false);
                    controlDevice('light3', false);
                    setFanSpeed('fan1', 30);
                    setFanSpeed('fan2', 30);
                    controlDevice('motor1', false);
                    controlDevice('motor2', false);
                    break;
                    
                case 'away':
                    // All devices OFF
                    controlDevice('light1', false);
                    controlDevice('light2', false);
                    controlDevice('light3', false);
                    setFanSpeed('fan1', 0);
                    setFanSpeed('fan2', 0);
                    controlDevice('motor1', false);
                    controlDevice('motor2', false);
                    controlDevice('outlet1', false);
                    controlDevice('outlet2', false);
                    break;
                    
                case 'party':
                    // All lights ON, fans at 70%
                    controlDevice('light1', true);
                    controlDevice('light2', true);
                    controlDevice('light3', true);
                    setFanSpeed('fan1', 70);
                    setFanSpeed('fan2', 70);
                    break;
            }
            
            alert(`${sceneName.charAt(0).toUpperCase() + sceneName.slice(1)} mode activated!`);
            lucide.createIcons();
        }

        // Check schedules every minute
        setInterval(checkSchedules, 60000); // Check every 60 seconds

        // Load schedules on startup
        loadSchedules();

        // ==================== AI PREDICTIONS & ANALYTICS ====================

        const ENERGY_RATE_BDT = 8; // BDT per kWh
        let forecastChart = null;

        // Calculate moving average for predictions
        function calculateMovingAverage(data, windowSize = 7) {
            if (data.length < windowSize) return data;
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < windowSize - 1) {
                    result.push(data[i]);
                } else {
                    const sum = data.slice(i - windowSize + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / windowSize);
                }
            }
            return result;
        }

        // Predict future usage using linear regression
        function predictUsage(historicalData, daysAhead = 1) {
            if (historicalData.length < 3) {
                return historicalData[historicalData.length - 1] || 0;
            }

            // Simple linear regression
            const n = historicalData.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

            historicalData.forEach((value, index) => {
                sumX += index;
                sumY += value;
                sumXY += index * value;
                sumX2 += index * index;
            });

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // Predict future value
            const prediction = slope * (n + daysAhead - 1) + intercept;
            return Math.max(0, prediction); // Ensure non-negative
        }

        // Detect anomalies in consumption
        function detectAnomalies(currentValue, historicalData) {
            if (historicalData.length < 5) return { isAnomaly: false };

            const mean = historicalData.reduce((a, b) => a + b, 0) / historicalData.length;
            const variance = historicalData.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / historicalData.length;
            const stdDev = Math.sqrt(variance);

            const threshold = 2; // 2 standard deviations
            const isHigh = currentValue > mean + (threshold * stdDev);
            const isLow = currentValue < mean - (threshold * stdDev);

            return {
                isAnomaly: isHigh || isLow,
                type: isHigh ? 'high' : (isLow ? 'low' : 'normal'),
                deviation: ((currentValue - mean) / mean * 100).toFixed(1),
                mean: mean,
                current: currentValue
            };
        }

        // Generate smart energy tips
        function generateSmartTips(data) {
            const tips = [];
            
            if (!data || data.length === 0) {
                return [{
                    icon: 'info',
                    color: 'blue',
                    title: 'Start Collecting Data',
                    description: 'Keep monitoring your energy usage to get personalized recommendations.'
                }];
            }

            const avgDaily = data.reduce((a, b) => a + b.energy, 0) / data.length;
            const latestPower = data[data.length - 1]?.power || 0;

            // Tip 1: High consumption warning
            if (latestPower > 2000) {
                tips.push({
                    icon: 'alert-triangle',
                    color: 'orange',
                    title: 'High Power Consumption Detected',
                    description: `Current usage: ${latestPower.toFixed(0)}W. Consider turning off unused devices to save energy.`
                });
            }

            // Tip 2: Voltage efficiency
            const avgVoltage = data.reduce((a, b) => a + b.voltage, 0) / data.length;
            if (avgVoltage < 210) {
                tips.push({
                    icon: 'zap-off',
                    color: 'yellow',
                    title: 'Low Voltage Detected',
                    description: `Average voltage: ${avgVoltage.toFixed(1)}V. Low voltage reduces appliance efficiency and increases power consumption.`
                });
            }

            // Tip 3: Energy savings suggestion
            if (avgDaily > 10) {
                const savingsPotential = (avgDaily * 0.2 * ENERGY_RATE_BDT * 30).toFixed(0);
                tips.push({
                    icon: 'piggy-bank',
                    color: 'green',
                    title: 'Energy Saving Opportunity',
                    description: `By reducing usage by 20%, you could save approximately ৳${savingsPotential} per month.`
                });
            }

            // Tip 4: Peak hour recommendation
            const peakHours = data.filter(d => {
                const hour = new Date(d.timestamp).getHours();
                return hour >= 18 && hour <= 22;
            });
            if (peakHours.length > 0) {
                const peakAvg = peakHours.reduce((a, b) => a + b.power, 0) / peakHours.length;
                if (peakAvg > latestPower * 1.3) {
                    tips.push({
                        icon: 'clock',
                        color: 'purple',
                        title: 'Shift Peak Usage',
                        description: 'Your consumption is higher during 6-10 PM. Try running heavy appliances during off-peak hours to balance load.'
                    });
                }
            }

            // Tip 5: Schedule automation
            if (deviceSchedules.length === 0) {
                tips.push({
                    icon: 'calendar-clock',
                    color: 'cyan',
                    title: 'Try Device Scheduling',
                    description: 'Automate your devices with schedules to optimize energy usage and never forget to turn off lights again!'
                });
            }

            // Tip 6: Power factor
            const avgCurrent = data.reduce((a, b) => a + b.current, 0) / data.length;
            const avgPower = data.reduce((a, b) => a + b.power, 0) / data.length;
            const apparentPower = avgVoltage * avgCurrent;
            const powerFactor = apparentPower > 0 ? avgPower / apparentPower : 1;
            
            if (powerFactor < 0.85) {
                tips.push({
                    icon: 'trending-down',
                    color: 'red',
                    title: 'Improve Power Factor',
                    description: `Power factor: ${(powerFactor * 100).toFixed(0)}%. Poor power factor wastes energy. Consider adding capacitor banks or replacing old appliances.`
                });
            }

            return tips.slice(0, 6); // Return max 6 tips
        }

        // Update AI predictions
        function updateAIPredictions() {
            const stored = localStorage.getItem('solarData');
            if (!stored) {
                console.log('No historical data for predictions');
                return;
            }

            const allData = JSON.parse(stored);
            if (allData.length < 2) {
                console.log('Insufficient data for predictions');
                return;
            }

            // Group data by day
            const dailyEnergy = {};
            allData.forEach(d => {
                const date = new Date(d.timestamp).toLocaleDateString();
                if (!dailyEnergy[date]) {
                    dailyEnergy[date] = 0;
                }
                dailyEnergy[date] = Math.max(dailyEnergy[date], d.energy || 0);
            });

            const days = Object.keys(dailyEnergy).sort();
            const energyValues = days.map(day => dailyEnergy[day]);

            // Usage Forecasts
            const tomorrowPrediction = predictUsage(energyValues, 1);
            const weekPrediction = predictUsage(energyValues, 7);
            const monthPrediction = predictUsage(energyValues, 30);

            document.getElementById('forecast-tomorrow').textContent = `${tomorrowPrediction.toFixed(2)} kWh`;
            document.getElementById('forecast-week').textContent = `${weekPrediction.toFixed(2)} kWh/day`;
            document.getElementById('forecast-month').textContent = `${(monthPrediction * 30).toFixed(1)} kWh`;

            // Calculate change from average
            const avgEnergy = energyValues.reduce((a, b) => a + b, 0) / energyValues.length;
            const tomorrowChange = ((tomorrowPrediction - avgEnergy) / avgEnergy * 100).toFixed(1);
            const weekChange = ((weekPrediction - avgEnergy) / avgEnergy * 100).toFixed(1);
            const monthChange = ((monthPrediction - avgEnergy) / avgEnergy * 100).toFixed(1);

            document.getElementById('forecast-tomorrow-change').innerHTML = 
                `${tomorrowChange > 0 ? '↑' : '↓'} ${Math.abs(tomorrowChange)}% vs average`;
            document.getElementById('forecast-week-change').innerHTML = 
                `${weekChange > 0 ? '↑' : '↓'} ${Math.abs(weekChange)}% vs average`;
            document.getElementById('forecast-month-change').innerHTML = 
                `${monthChange > 0 ? '↑' : '↓'} ${Math.abs(monthChange)}% vs average`;

            // Cost Predictions
            document.getElementById('cost-tomorrow').textContent = 
                `৳${(tomorrowPrediction * ENERGY_RATE_BDT).toFixed(2)}`;
            document.getElementById('cost-week').textContent = 
                `৳${(weekPrediction * 7 * ENERGY_RATE_BDT).toFixed(2)}`;
            document.getElementById('cost-month').textContent = 
                `৳${(monthPrediction * 30 * ENERGY_RATE_BDT).toFixed(2)}`;

            // Forecast Chart
            const ctx = document.getElementById('forecast-chart');
            if (ctx) {
                const last7Days = energyValues.slice(-7);
                const predictions = [
                    predictUsage(energyValues, 1),
                    predictUsage(energyValues, 2),
                    predictUsage(energyValues, 3)
                ];

                if (forecastChart) {
                    forecastChart.destroy();
                }

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Day -6', 'Day -5', 'Day -4', 'Day -3', 'Day -2', 'Day -1', 'Today', 'Tomorrow', 'Day +2', 'Day +3'],
                        datasets: [{
                            label: 'Historical',
                            data: [...last7Days, ...Array(3).fill(null)],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Predicted',
                            data: [...Array(7).fill(null), ...predictions],
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(156, 163, 175, 0.1)' },
                                title: { display: true, text: 'Energy (kWh)', color: '#9ca3af' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(156, 163, 175, 0.1)' }
                            }
                        }
                    }
                });
            }

            // Anomaly Detection
            const currentEnergy = allData[allData.length - 1]?.energy || 0;
            const anomaly = detectAnomalies(currentEnergy, energyValues.slice(-30));

            let anomalyHTML = '';
            if (anomaly.isAnomaly) {
                anomalyHTML = `
                    <div class="bg-${anomaly.type === 'high' ? 'red' : 'yellow'}-900/20 border border-${anomaly.type === 'high' ? 'red' : 'yellow'}-600 p-4 rounded-lg">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="w-6 h-6 mr-3 text-${anomaly.type === 'high' ? 'red' : 'yellow'}-400 flex-shrink-0"></i>
                            <div class="flex-1">
                                <h4 class="text-white font-semibold mb-1">
                                    ${anomaly.type === 'high' ? 'Unusual High Consumption' : 'Unusual Low Consumption'}
                                </h4>
                                <p class="text-gray-300 text-sm">
                                    Current: ${anomaly.current.toFixed(2)} kWh (${anomaly.deviation}% ${anomaly.type === 'high' ? 'above' : 'below'} normal)
                                </p>
                                <p class="text-gray-400 text-xs mt-1">
                                    Average: ${anomaly.mean.toFixed(2)} kWh
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                anomalyHTML = `
                    <div class="bg-green-900/20 border border-green-600 p-4 rounded-lg">
                        <div class="flex items-start">
                            <i data-lucide="check-circle" class="w-6 h-6 mr-3 text-green-400 flex-shrink-0"></i>
                            <div class="flex-1">
                                <h4 class="text-white font-semibold mb-1">Normal Consumption Pattern</h4>
                                <p class="text-gray-300 text-sm">
                                    Your energy usage is within expected range (${anomaly.current.toFixed(2)} kWh)
                                </p>
                                <p class="text-gray-400 text-xs mt-1">
                                    Average: ${anomaly.mean.toFixed(2)} kWh
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('anomaly-container').innerHTML = anomalyHTML;

            // Smart Tips
            const tips = generateSmartTips(allData.slice(-100)); // Last 100 readings
            const tipsHTML = tips.map(tip => `
                <div class="bg-gradient-to-br from-${tip.color}-600/20 to-${tip.color}-700/20 border border-${tip.color}-600/50 p-4 rounded-lg">
                    <div class="flex items-start">
                        <i data-lucide="${tip.icon}" class="w-5 h-5 mr-3 text-${tip.color}-400 flex-shrink-0 mt-0.5"></i>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold text-sm mb-1">${tip.title}</h4>
                            <p class="text-gray-300 text-xs">${tip.description}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('smart-tips-container').innerHTML = tipsHTML;

            lucide.createIcons();
        }

        // Update predictions every 5 minutes
        setInterval(updateAIPredictions, 300000);

        // Initial prediction update (after a short delay to let data load)
        setTimeout(updateAIPredictions, 2000);

        // ==================== CLOUD DATABASE (FIREBASE) ====================

        let db = null;
        let firebaseApp = null;
        let cloudSyncEnabled = false;
        let syncInProgress = false;

        // Load Firebase config from localStorage
        function loadFirebaseConfig() {
            const config = localStorage.getItem('firebaseConfig');
            if (config) {
                const parsed = JSON.parse(config);
                document.getElementById('firebase-api-key').value = parsed.apiKey || '';
                document.getElementById('firebase-auth-domain').value = parsed.authDomain || '';
                document.getElementById('firebase-project-id').value = parsed.projectId || '';
                document.getElementById('firebase-storage-bucket').value = parsed.storageBucket || '';
                document.getElementById('firebase-app-id').value = parsed.appId || '';
                
                const syncEnabled = localStorage.getItem('cloudSyncEnabled') === 'true';
                document.getElementById('cloud-sync-toggle').checked = syncEnabled;
                
                if (syncEnabled) {
                    console.log('Auto-connecting to Firebase on page load...');
                    updateCloudStatus('syncing');
                    initializeFirebase(parsed);
                } else {
                    // Show Connect button if config exists but not connected
                    document.getElementById('firebase-connect-button').classList.remove('hidden');
                }
            }
        }

        // Save Firebase configuration
        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('firebase-api-key').value,
                authDomain: document.getElementById('firebase-auth-domain').value,
                projectId: document.getElementById('firebase-project-id').value,
                storageBucket: document.getElementById('firebase-storage-bucket').value,
                appId: document.getElementById('firebase-app-id').value
            };

            if (!config.apiKey || !config.projectId || !config.appId) {
                alert('Please fill in at least API Key, Project ID, and App ID');
                return;
            }

            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            alert('Firebase configuration saved! Click "Test Connection" to verify.');
            lucide.createIcons();
        }

        // Initialize Firebase
        function initializeFirebase(config) {
            try {
                if (firebaseApp) {
                    console.log('Firebase already initialized');
                    return;
                }

                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                
                // Enable offline persistence
                db.enablePersistence({ synchronizeTabs: true })
                    .catch((err) => {
                        console.warn('Persistence error:', err.code);
                    });

                cloudSyncEnabled = true;
                updateCloudStatus('connected');
                console.log('Firebase initialized successfully');
                
                // Start real-time listeners
                setupRealtimeListeners();
                
                // Initial sync
                syncToCloud();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateCloudStatus('error');
                alert('Firebase initialization failed: ' + error.message);
            }
        }

        // Toggle cloud sync
        function toggleCloudSync() {
            const enabled = document.getElementById('cloud-sync-toggle').checked;
            localStorage.setItem('cloudSyncEnabled', enabled);

            if (enabled) {
                const config = localStorage.getItem('firebaseConfig');
                if (config) {
                    initializeFirebase(JSON.parse(config));
                } else {
                    alert('Please configure Firebase settings first');
                    document.getElementById('cloud-sync-toggle').checked = false;
                    return;
                }
            } else {
                cloudSyncEnabled = false;
                updateCloudStatus('offline');
            }
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebase-connection-status');
            statusDiv.classList.remove('hidden', 'bg-green-900/20', 'bg-red-900/20', 'border-green-600', 'border-red-600');
            statusDiv.classList.add('bg-blue-900/20', 'border', 'border-blue-600');
            statusDiv.querySelector('p').textContent = 'Testing connection...';
            statusDiv.querySelector('p').className = 'text-sm text-blue-400';

            try {
                const config = {
                    apiKey: document.getElementById('firebase-api-key').value,
                    authDomain: document.getElementById('firebase-auth-domain').value,
                    projectId: document.getElementById('firebase-project-id').value,
                    storageBucket: document.getElementById('firebase-storage-bucket').value,
                    appId: document.getElementById('firebase-app-id').value
                };

                // Try to initialize
                const testApp = firebase.initializeApp(config, 'test-app');
                const testDb = testApp.firestore();
                
                // Try a simple operation
                await testDb.collection('_test').doc('connection').set({ test: true });
                await testDb.collection('_test').doc('connection').delete();
                
                statusDiv.classList.remove('bg-blue-900/20', 'border-blue-600');
                statusDiv.classList.add('bg-green-900/20', 'border-green-600');
                statusDiv.querySelector('p').textContent = '✓ Connection successful! Click "Connect to Cloud" below.';
                statusDiv.querySelector('p').className = 'text-sm text-green-400';
                
                // Save config for later use
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // Show Connect button
                document.getElementById('firebase-connect-button').classList.remove('hidden');
                
                // Clean up test app
                await testApp.delete();
                
            } catch (error) {
                statusDiv.classList.remove('bg-blue-900/20', 'border-blue-600');
                statusDiv.classList.add('bg-red-900/20', 'border-red-600');
                statusDiv.querySelector('p').textContent = '✗ Connection failed: ' + error.message;
                statusDiv.querySelector('p').className = 'text-sm text-red-400';
                
                // Hide Connect button on error
                document.getElementById('firebase-connect-button').classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        // Connect to Firebase (called after successful test)
        function connectToFirebase() {
            const config = localStorage.getItem('firebaseConfig');
            if (!config) {
                alert('Please test connection first');
                return;
            }

            try {
                // Enable cloud sync
                localStorage.setItem('cloudSyncEnabled', 'true');
                document.getElementById('cloud-sync-toggle').checked = true;
                
                // Initialize Firebase
                initializeFirebase(JSON.parse(config));
                
                // Show success message
                showNotification('Cloud Connected', 'Your dashboard is now syncing with Firebase!');
                
                // Close modal
                toggleCloudSettings();
                
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        // Update cloud status indicator
        function updateCloudStatus(status) {
            const badge = document.getElementById('cloud-status-badge');
            const text = document.getElementById('cloud-status-text');
            
            if (!badge || !text) {
                console.warn('Cloud status elements not found');
                return;
            }
            
            const icon = badge.querySelector('i');
            
            if (!icon) {
                console.warn('Cloud status icon not found');
                return;
            }

            badge.classList.remove('bg-gray-700', 'bg-green-600/20', 'bg-blue-600/20', 'bg-red-600/20', 'text-gray-400', 'text-green-400', 'text-blue-400', 'text-red-400');
            
            switch(status) {
                case 'connected':
                    badge.classList.add('bg-green-600/20', 'text-green-400');
                    icon.setAttribute('data-lucide', 'cloud-check');
                    text.textContent = 'Cloud: On';
                    break;
                case 'syncing':
                    badge.classList.add('bg-blue-600/20', 'text-blue-400');
                    icon.setAttribute('data-lucide', 'cloud-upload');
                    text.textContent = 'Cloud: Syncing...';
                    break;
                case 'error':
                    badge.classList.add('bg-red-600/20', 'text-red-400');
                    icon.setAttribute('data-lucide', 'cloud-off');
                    text.textContent = 'Cloud: Error';
                    break;
                default:
                    badge.classList.add('bg-red-600/20', 'text-red-400');
                    icon.setAttribute('data-lucide', 'cloud-off');
                    text.textContent = 'Cloud: Off';
            }
            
            lucide.createIcons();
        }

        // Toggle cloud settings modal
        function toggleCloudSettings() {
            const modal = document.getElementById('cloud-settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                loadFirebaseConfig();
            }
            lucide.createIcons();
        }

        // Sync data to cloud
        async function syncToCloud() {
            if (!cloudSyncEnabled || !db || syncInProgress) return;

            syncInProgress = true;
            updateCloudStatus('syncing');

            try {
                const deviceId = getDeviceId();
                
                // Sync historical data
                const solarData = localStorage.getItem('solarData');
                if (solarData) {
                    await db.collection('devices').doc(deviceId).collection('solarData').doc('latest').set({
                        data: solarData,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Sync schedules
                if (deviceSchedules.length > 0) {
                    await db.collection('devices').doc(deviceId).collection('schedules').doc('active').set({
                        schedules: deviceSchedules,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Sync alert settings
                await db.collection('devices').doc(deviceId).collection('settings').doc('alerts').set({
                    settings: alertSettings,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                updateCloudStatus('connected');
                console.log('Data synced to cloud successfully');
                
            } catch (error) {
                console.error('Cloud sync error:', error);
                updateCloudStatus('error');
            } finally {
                syncInProgress = false;
            }
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            if (!db) return;

            const deviceId = getDeviceId();

            // Listen for schedule changes
            db.collection('devices').doc(deviceId).collection('schedules').doc('active')
                .onSnapshot((doc) => {
                    if (doc.exists && !syncInProgress) {
                        const data = doc.data();
                        if (data.schedules) {
                            deviceSchedules = data.schedules;
                            displaySchedules();
                            console.log('Schedules synced from cloud');
                        }
                    }
                });

            // Listen for settings changes
            db.collection('devices').doc(deviceId).collection('settings').doc('alerts')
                .onSnapshot((doc) => {
                    if (doc.exists && !syncInProgress) {
                        const data = doc.data();
                        if (data.settings) {
                            alertSettings = data.settings;
                            console.log('Settings synced from cloud');
                        }
                    }
                });
        }

        // Get unique device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Auto-sync every 5 minutes
        setInterval(() => {
            if (cloudSyncEnabled) {
                syncToCloud();
            }
        }, 300000);

        // Sync on important data changes
        const originalSaveSchedules = saveSchedules;
        saveSchedules = function() {
            originalSaveSchedules();
            if (cloudSyncEnabled) {
                syncToCloud();
            }
        };

        const originalSaveAlertSettings = saveAlertSettings;
        saveAlertSettings = function() {
            originalSaveAlertSettings();
            if (cloudSyncEnabled) {
                syncToCloud();
            }
        };

        // Load Firebase config on startup
        loadFirebaseConfig();

        // ============================================
        // AUTO CSV EXPORT FUNCTIONALITY
        // ============================================

        let autoCSVEnabled = false;
        let autoCSVInterval = null;
        let autoCSVSettings = {
            enabled: false,
            interval: 3600000, // 1 hour default
            lastExport: null,
            totalExports: 0
        };

        // Load auto-CSV settings
        function loadAutoCSVSettings() {
            const saved = localStorage.getItem('autoCSVSettings');
            if (saved) {
                autoCSVSettings = JSON.parse(saved);
                autoCSVEnabled = autoCSVSettings.enabled;
                
                // Update UI
                document.getElementById('autoCSVEnabled').checked = autoCSVSettings.enabled;
                document.getElementById('csvExportInterval').value = autoCSVSettings.interval;
                document.getElementById('totalCSVExports').textContent = autoCSVSettings.totalExports;
                document.getElementById('csvDataPoints').textContent = solarHistory.length;
                
                if (autoCSVSettings.lastExport) {
                    const lastDate = new Date(autoCSVSettings.lastExport);
                    document.getElementById('lastCSVExport').textContent = lastDate.toLocaleString();
                    updateNextExportTime();
                }
                
                document.getElementById('auto-csv-status').textContent = autoCSVSettings.enabled ? 'Enabled' : 'Disabled';
                
                // Start auto-export if enabled
                if (autoCSVSettings.enabled) {
                    startAutoCSVExport();
                }
            }
        }

        // Save auto-CSV settings
        function saveAutoCSVSettings() {
            autoCSVSettings.interval = parseInt(document.getElementById('csvExportInterval').value);
            localStorage.setItem('autoCSVSettings', JSON.stringify(autoCSVSettings));
            
            // Restart interval if enabled
            if (autoCSVEnabled) {
                stopAutoCSVExport();
                startAutoCSVExport();
            }
            
            updateNextExportTime();
        }

        // Toggle auto-CSV export
        function toggleAutoCSV(enabled) {
            autoCSVEnabled = enabled;
            autoCSVSettings.enabled = enabled;
            document.getElementById('auto-csv-status').textContent = enabled ? 'Enabled' : 'Disabled';
            
            if (enabled) {
                startAutoCSVExport();
                showNotification('Auto CSV Export Enabled', 'CSV files will be automatically downloaded at the set interval.');
            } else {
                stopAutoCSVExport();
                showNotification('Auto CSV Export Disabled', 'Automatic CSV downloads have been stopped.');
            }
            
            saveAutoCSVSettings();
        }

        // Start auto-CSV export
        function startAutoCSVExport() {
            if (autoCSVInterval) {
                clearInterval(autoCSVInterval);
            }
            
            autoCSVInterval = setInterval(() => {
                exportCSVNow();
            }, autoCSVSettings.interval);
            
            updateNextExportTime();
            console.log('Auto CSV export started with interval:', autoCSVSettings.interval);
        }

        // Stop auto-CSV export
        function stopAutoCSVExport() {
            if (autoCSVInterval) {
                clearInterval(autoCSVInterval);
                autoCSVInterval = null;
            }
            document.getElementById('nextCSVExport').textContent = 'Next: --';
        }

        // Update next export time display
        function updateNextExportTime() {
            if (!autoCSVEnabled || !autoCSVSettings.lastExport) {
                document.getElementById('nextCSVExport').textContent = 'Next: Soon';
                return;
            }
            
            const nextExport = new Date(autoCSVSettings.lastExport).getTime() + autoCSVSettings.interval;
            const nextDate = new Date(nextExport);
            const now = new Date();
            
            if (nextExport > now.getTime()) {
                const diff = nextExport - now.getTime();
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    document.getElementById('nextCSVExport').textContent = `Next: in ${hours}h ${minutes % 60}m`;
                } else {
                    document.getElementById('nextCSVExport').textContent = `Next: in ${minutes}m`;
                }
            } else {
                document.getElementById('nextCSVExport').textContent = 'Next: Soon';
            }
        }

        // Export CSV now (manual or automatic)
        function exportCSVNow() {
            if (solarHistory.length === 0) {
                showNotification('No Data', 'No data available to export. Please wait for data collection.');
                return;
            }
            
            // Generate CSV content
            const csvContent = generateCSVContent();
            
            // Create timestamp for filename
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `SolarGrid_Data_${timestamp}.csv`;
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update export stats
            autoCSVSettings.lastExport = now.toISOString();
            autoCSVSettings.totalExports++;
            saveAutoCSVSettings();
            
            // Update UI
            document.getElementById('lastCSVExport').textContent = now.toLocaleString();
            document.getElementById('totalCSVExports').textContent = autoCSVSettings.totalExports;
            updateNextExportTime();
            
            showNotification('CSV Exported', `${filename} has been downloaded successfully!`);
            console.log('CSV exported:', filename);
        }

        // Generate CSV content
        function generateCSVContent() {
            // CSV Header
            let csv = 'Timestamp,Date,Time,Solar Power (kW),Battery (V),Load Power (kW),Grid Power (kW),Energy Today (kWh),Cost Saved (৳),Temperature (°C),Humidity (%),Status\n';
            
            // Add data rows
            solarHistory.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();
                
                csv += `${entry.timestamp},`;
                csv += `${dateStr},`;
                csv += `${timeStr},`;
                csv += `${entry.power || 0},`;
                csv += `${entry.battery || 0},`;
                csv += `${entry.load || 0},`;
                csv += `${entry.grid || 0},`;
                csv += `${entry.energy || 0},`;
                csv += `${entry.costSaved || 0},`;
                csv += `${entry.temperature || 0},`;
                csv += `${entry.humidity || 0},`;
                csv += `${entry.status || 'Normal'}\n`;
            });
            
            return csv;
        }

        // Preview CSV content
        function previewCSV() {
            if (solarHistory.length === 0) {
                showNotification('No Data', 'No data available to preview.');
                return;
            }
            
            const csvContent = generateCSVContent();
            const lines = csvContent.split('\n');
            const previewLines = lines.slice(0, 11).join('\n'); // Header + 10 rows
            
            // Create modal for preview
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-card-bg rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden border border-gray-700">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-white flex items-center">
                            <i data-lucide="file-text" class="w-6 h-6 mr-3 text-primary"></i>
                            CSV Preview
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="p-6 overflow-auto max-h-[70vh]">
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre class="text-green-400 text-xs font-mono whitespace-pre">${previewLines}</pre>
                        </div>
                        <p class="text-gray-400 text-sm mt-4">
                            Showing first 10 rows of ${solarHistory.length} total data points.
                        </p>
                    </div>
                    <div class="p-6 border-t border-gray-700 flex gap-3">
                        <button onclick="exportCSVNow(); this.closest('.fixed').remove();" class="bg-primary hover:bg-primary/80 text-white px-6 py-2 rounded-lg transition-colors font-medium flex items-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Download Full CSV
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors font-medium">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // Load auto-CSV settings on startup
        loadAutoCSVSettings();

        // Update next export time every minute
        setInterval(updateNextExportTime, 60000);

        // Update CSV data points count periodically
        setInterval(() => {
            const stored = localStorage.getItem('solarData');
            const dataLength = stored ? JSON.parse(stored).length : 0;
            const csvDataPointsEl = document.getElementById('csvDataPoints');
            if (csvDataPointsEl) {
                csvDataPointsEl.textContent = dataLength;
            }
        }, 5000);

        // ============================================
        // REPORTS FUNCTIONALITY
        // ============================================

        let currentReportPeriod = 'today';

        // Generate report for specified period
        function generateReport(period) {
            currentReportPeriod = period;
            const stored = localStorage.getItem('solarData');
            
            if (!stored) {
                alert('No data available for report generation');
                return;
            }

            const allData = JSON.parse(stored);
            const now = new Date();
            let filteredData = [];
            let periodLabel = '';

            // Filter data based on period
            switch(period) {
                case 'today':
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filteredData = allData.filter(d => new Date(d.timestamp) >= startOfDay);
                    periodLabel = 'Today';
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredData = allData.filter(d => new Date(d.timestamp) >= weekAgo);
                    periodLabel = 'This Week';
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    filteredData = allData.filter(d => new Date(d.timestamp) >= monthAgo);
                    periodLabel = 'This Month';
                    break;
                case 'year':
                    const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    filteredData = allData.filter(d => new Date(d.timestamp) >= yearAgo);
                    periodLabel = 'This Year';
                    break;
            }

            if (filteredData.length === 0) {
                alert('No data available for ' + periodLabel);
                return;
            }

            // Calculate statistics
            const totalEnergy = filteredData.reduce((sum, d) => sum + (d.energy || 0), 0);
            const avgPower = filteredData.reduce((sum, d) => sum + (d.power || 0), 0) / filteredData.length;
            const peakPower = Math.max(...filteredData.map(d => d.power || 0));
            const peakEntry = filteredData.find(d => d.power === peakPower);
            const costSaved = totalEnergy * 8; // ৳8 per kWh
            const runtime = filteredData.length * 5 / 3600; // 5-second intervals to hours

            // Environmental calculations
            const co2Avoided = totalEnergy * 0.7; // kg CO2 per kWh
            const treesEquiv = Math.floor(co2Avoided / 21); // 21kg CO2 per tree per year
            const carsOffRoad = Math.floor(co2Avoided / 4.6); // 4.6kg CO2 per car per day

            // System health (based on consistency and peak performance)
            const healthScore = Math.min(100, Math.floor((avgPower / peakPower) * 100 + 20));

            // Update UI
            document.getElementById('report-total-energy').textContent = totalEnergy.toFixed(2);
            document.getElementById('report-energy-period').textContent = periodLabel;
            
            document.getElementById('report-peak-power').textContent = peakPower.toFixed(2);
            document.getElementById('report-peak-time').textContent = peakEntry ? 
                new Date(peakEntry.timestamp).toLocaleString() : 'N/A';
            
            document.getElementById('report-cost-saved').textContent = costSaved.toFixed(0);
            document.getElementById('report-savings-info').textContent = `@ ৳8/kWh for ${periodLabel}`;
            
            document.getElementById('report-health-score').textContent = healthScore;
            document.getElementById('report-health-status').textContent = 
                healthScore >= 80 ? 'Excellent' : healthScore >= 60 ? 'Good' : 'Needs Attention';

            // Performance analysis
            document.getElementById('report-avg-power').textContent = avgPower.toFixed(2);
            document.getElementById('report-peak-hours').textContent = '10 AM - 2 PM'; // Simplified
            document.getElementById('report-runtime').textContent = runtime.toFixed(1);
            document.getElementById('report-efficiency').textContent = healthScore;

            // Environmental impact
            document.getElementById('report-co2-avoided').textContent = co2Avoided.toFixed(1);
            document.getElementById('report-trees-equiv').textContent = treesEquiv;
            document.getElementById('report-cars-equiv').textContent = carsOffRoad;
            document.getElementById('report-green-percent').textContent = '100';

            showNotification('Report Generated', `${periodLabel} report is ready!`);
        }

        // Download report as PDF
        function downloadReportPDF() {
            alert('PDF export feature coming soon! This will generate a professional PDF report with charts and detailed analytics.');
        }

        // Download report as CSV
        function downloadReportCSV() {
            exportCSVNow(); // Reuse existing CSV export
        }

        // Email report
        function emailReport() {
            const email = prompt('Enter your email address:');
            if (email) {
                alert(`Report will be sent to ${email}. Email integration coming soon!`);
            }
        }

        // ============================================
        // THEME & CUSTOMIZATION
        // ============================================

        let currentTheme = 'dark';
        let currentAccent = 'cyan';
        let currentFontSize = 'medium';

        // Load saved theme settings
        function loadThemeSettings() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedAccent = localStorage.getItem('accentColor') || 'cyan';
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            const savedBgColor = localStorage.getItem('backgroundColor') || 'default';
            
            setTheme(savedTheme);
            setAccentColor(savedAccent);
            setFontSize(savedFontSize);
            setBackgroundColor(savedBgColor);
        }

        // Set theme (light/dark/auto)
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);

            // Remove active state from all theme buttons
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('border-primary');
                btn.classList.add('border-transparent');
            });

            // Apply theme
            const body = document.body;
            body.classList.remove('theme-light', 'theme-dark');

            if (theme === 'light') {
                body.classList.add('theme-light');
                document.getElementById('theme-light-btn').classList.remove('border-transparent');
                document.getElementById('theme-light-btn').classList.add('border-primary');
                applyLightTheme();
            } else if (theme === 'dark') {
                body.classList.add('theme-dark');
                document.getElementById('theme-dark-btn').classList.remove('border-transparent');
                document.getElementById('theme-dark-btn').classList.add('border-primary');
                applyDarkTheme();
                // Reapply saved background color for dark mode
                const savedBgColor = localStorage.getItem('backgroundColor') || 'default';
                setBackgroundColor(savedBgColor);
            } else {
                // Auto mode - detect system preference
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                body.classList.add(isDark ? 'theme-dark' : 'theme-light');
                document.getElementById('theme-auto-btn').classList.remove('border-transparent');
                document.getElementById('theme-auto-btn').classList.add('border-primary');
                if (isDark) {
                    applyDarkTheme();
                    const savedBgColor = localStorage.getItem('backgroundColor') || 'default';
                    setBackgroundColor(savedBgColor);
                } else {
                    applyLightTheme();
                }
            }

            lucide.createIcons();
        }

        // Apply light theme colors
        function applyLightTheme() {
            const root = document.documentElement;
            root.style.setProperty('--bg-primary', '#f0f4f8');
            root.style.setProperty('--bg-secondary', '#ffffff');
            root.style.setProperty('--bg-card', '#ffffff');
            root.style.setProperty('--text-primary', '#1a202c');
            root.style.setProperty('--text-secondary', '#4a5568');
            root.style.setProperty('--border-color', '#e2e8f0');
            
            // Apply to body with !important via inline style
            document.body.style.cssText = 'background-color: #f0f4f8 !important; color: #1a202c !important;';
        }

        // Apply dark theme colors
        function applyDarkTheme() {
            const root = document.documentElement;
            root.style.setProperty('--bg-primary', '#0f1419');
            root.style.setProperty('--bg-secondary', '#1a1f2e');
            root.style.setProperty('--bg-card', '#374151');
            root.style.setProperty('--text-primary', '#ffffff');
            root.style.setProperty('--text-secondary', '#a0aec0');
            root.style.setProperty('--border-color', '#2d3748');
            
            // Clear inline styles to allow CSS variables to work
            document.body.style.cssText = '';
        }

        // Set accent color
        function setAccentColor(color) {
            currentAccent = color;
            localStorage.setItem('accentColor', color);

            const colorMap = {
                'cyan': '#06b6d4',
                'blue': '#3b82f6',
                'purple': '#a855f7',
                'pink': '#ec4899',
                'green': '#10b981',
                'orange': '#f97316'
            };

            document.documentElement.style.setProperty('--accent-color', colorMap[color]);
            showNotification('Accent Color Changed', `Theme updated to ${color}`);
        }

        // Set background color
        function setBackgroundColor(color) {
            localStorage.setItem('backgroundColor', color);

            // Remove border from all bg buttons
            document.querySelectorAll('.bg-color-btn').forEach(btn => {
                btn.classList.remove('border-primary');
                btn.classList.add('border-transparent');
            });

            const colorMap = {
                'default': { primary: '#0f1419', secondary: '#1a1f2e', card: '#374151' },
                'blue': { primary: '#0c1222', secondary: '#1e293b', card: '#334155' },
                'purple': { primary: '#1a0b2e', secondary: '#2d1b4e', card: '#4c366a' },
                'green': { primary: '#0a1e0a', secondary: '#1c3d1c', card: '#2d5d2d' },
                'slate': { primary: '#0f172a', secondary: '#1e293b', card: '#334155' },
                'neutral': { primary: '#0a0a0a', secondary: '#1c1c1c', card: '#3f3f3f' }
            };

            const colors = colorMap[color] || colorMap['default'];
            
            // Only apply background colors in dark theme
            const isDarkMode = currentTheme === 'dark' || (currentTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDarkMode) {
                const root = document.documentElement;
                root.style.setProperty('--bg-primary', colors.primary);
                root.style.setProperty('--bg-secondary', colors.secondary);
                root.style.setProperty('--bg-card', colors.card);
                
                // Apply body background using cssText to ensure it overrides Tailwind
                document.body.style.cssText = `background-color: ${colors.primary} !important; color: #ffffff !important;`;
            }

            // Highlight selected button
            const btnIndex = ['default', 'blue', 'purple', 'green', 'slate', 'neutral'].indexOf(color);
            if (btnIndex >= 0) {
                const buttons = document.querySelectorAll('.bg-color-btn');
                if (buttons[btnIndex]) {
                    buttons[btnIndex].classList.remove('border-transparent');
                    buttons[btnIndex].classList.add('border-primary');
                }
            }

            if (isDarkMode) {
                showNotification('Background Changed', `Background updated to ${color}`);
            }
        }

        // Set font size
        function setFontSize(size) {
            currentFontSize = size;
            localStorage.setItem('fontSize', size);

            // Remove active state
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.classList.remove('border-primary');
                btn.classList.add('border-transparent');
            });

            // Apply font size
            const body = document.body;
            body.classList.remove('font-small', 'font-medium', 'font-large');
            body.classList.add('font-' + size);

            document.getElementById('font-' + size + '-btn').classList.remove('border-transparent');
            document.getElementById('font-' + size + '-btn').classList.add('border-primary');

            const sizeMap = {
                'small': '14px',
                'medium': '16px',
                'large': '18px'
            };

            document.documentElement.style.fontSize = sizeMap[size];
        }

        // Toggle animations
        function toggleAnimations(enabled) {
            localStorage.setItem('animations', enabled);
            document.body.style.transition = enabled ? 'all 0.3s ease' : 'none';
        }

        // Toggle compact mode
        function toggleCompactMode(enabled) {
            localStorage.setItem('compactMode', enabled);
            document.body.classList.toggle('compact-mode', enabled);
        }

        // Toggle 24-hour time
        function toggle24HourTime(enabled) {
            localStorage.setItem('time24Hour', enabled);
            // Time format will be applied on next update
        }

        // Clear local data
        function clearLocalData() {
            if (confirm('Are you sure you want to clear all local data? This cannot be undone.')) {
                localStorage.removeItem('solarData');
                localStorage.removeItem('alertHistory');
                showNotification('Data Cleared', 'All local data has been removed');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Reset all settings
        function resetSettings() {
            if (confirm('Reset all settings to default? This will clear themes, schedules, and preferences.')) {
                localStorage.clear();
                showNotification('Settings Reset', 'All settings restored to default');
                setTimeout(() => location.reload(), 1500);
            }
        }

        // Initialize theme on startup
        loadThemeSettings();

        // Generate initial report
        setTimeout(() => generateReport('today'), 2000);

        // ============================================
        // WIND SOLAR CHARTS
        // ============================================

        let windChart1 = null;
        let windChart2 = null;

        // Wind turbine data
        const windData = {
            windSpeeds: [2.5, 3.0, 3.5, 4.5, 5.5],
            power: {
                noLoad: [0, 0, 0, 0, 0],
                load: [0.006, 0.03, 0.07, 0.15, 0.38]
            },
            voltage: {
                noLoad: [7, 10.5, 13.5, 21.5, 22.6],
                load: [6.50, 7.70, 7.90, 8.16, 8.6]
            },
            current: {
                noLoad: [0, 0, 0, 0, 0],
                load: [1, 3, 9, 19, 44]
            },
            rpm: {
                noLoad: [35, 52.5, 68, 85.6, 109],
                load: [30, 46, 52.5, 55, 66]
            }
        };

        function getChartConfig(dataType) {
            const configs = {
                power: {
                    title: 'Power Output vs Wind Speed',
                    yLabel: 'Power (Watt)',
                    datasets: [
                        {
                            label: 'Power (Load)',
                            data: windData.power.load,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)'
                        }
                    ]
                },
                voltage: {
                    title: 'Voltage vs Wind Speed',
                    yLabel: 'Voltage (V)',
                    datasets: [
                        {
                            label: 'Voltage (No Load)',
                            data: windData.voltage.noLoad,
                            borderColor: 'rgb(251, 146, 60)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)'
                        },
                        {
                            label: 'Voltage (Load)',
                            data: windData.voltage.load,
                            borderColor: 'rgb(234, 88, 12)',
                            backgroundColor: 'rgba(234, 88, 12, 0.1)'
                        }
                    ]
                },
                current: {
                    title: 'Current vs Wind Speed',
                    yLabel: 'Current (mA)',
                    datasets: [
                        {
                            label: 'Current (Load)',
                            data: windData.current.load,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)'
                        }
                    ]
                },
                rpm: {
                    title: 'RPM vs Wind Speed',
                    yLabel: 'RPM',
                    datasets: [
                        {
                            label: 'RPM (No Load)',
                            data: windData.rpm.noLoad,
                            borderColor: 'rgb(168, 85, 247)',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)'
                        },
                        {
                            label: 'RPM (Load)',
                            data: windData.rpm.load,
                            borderColor: 'rgb(236, 72, 153)',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)'
                        }
                    ]
                }
            };
            return configs[dataType];
        }

        function createWindChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;

            const datasets = config.datasets.map(ds => ({
                ...ds,
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: ds.borderColor,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }));

            return new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: windData.windSpeeds,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#9ca3af' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.yLabel,
                                color: '#9ca3af'
                            },
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Wind Speed (m/s)',
                                color: '#9ca3af'
                            },
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function updateWindChart(chartNum) {
            const selector = document.getElementById(`chart${chartNum}-selector`);
            const title = document.getElementById(`chart${chartNum}-title`);
            const dataType = selector.value;
            const config = getChartConfig(dataType);
            
            title.textContent = config.title;
            
            if (chartNum === 1) {
                if (windChart1) windChart1.destroy();
                windChart1 = createWindChart('wind-chart-1', config);
            } else {
                if (windChart2) windChart2.destroy();
                windChart2 = createWindChart('wind-chart-2', config);
            }
        }

        function initWindSolarCharts() {
            // Initialize both charts with default selections
            updateWindChart(1);
            updateWindChart(2);
        }

        function initWindSolarCharts() {
            // Destroy existing charts if they exist
            if (windPowerChart) {
                windPowerChart.destroy();
            }
            if (windRpmChart) {
                windRpmChart.destroy();
            }

            // Wind turbine data
            const windSpeeds = [2.5, 3.0, 3.5, 4.5, 5.5];
            const powerLoad = [0.006, 0.03, 0.07, 0.15, 0.38];
            const rpmNoLoad = [35, 52.5, 68, 85.6, 109];
            const rpmLoad = [30, 46, 52.5, 55, 66];

            // Power Chart
            const powerCtx = document.getElementById('wind-power-chart');
            if (powerCtx) {
                windPowerChart = new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: windSpeeds,
                        datasets: [{
                            label: 'Power Output (Load)',
                            data: powerLoad,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: 'rgb(34, 197, 94)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#9ca3af' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function(context) {
                                        return 'Power: ' + context.parsed.y + ' W';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Power (Watt)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Wind Speed (m/s)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }

            // RPM Chart
            const rpmCtx = document.getElementById('wind-rpm-chart');
            if (rpmCtx) {
                windRpmChart = new Chart(rpmCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: windSpeeds,
                        datasets: [
                            {
                                label: 'RPM (No Load)',
                                data: rpmNoLoad,
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: 'rgb(168, 85, 247)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'RPM (Load)',
                                data: rpmLoad,
                                borderColor: 'rgb(236, 72, 153)',
                                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: 'rgb(236, 72, 153)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#9ca3af' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' RPM';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'RPM',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Wind Speed (m/s)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // SOLAR DATA CHARTS
        // ============================================

        let solarPowerChart = null;
        let solarTempChart = null;

        function initSolarDataCharts() {
            // Destroy existing charts if they exist
            if (solarPowerChart) {
                solarPowerChart.destroy();
            }
            if (solarTempChart) {
                solarTempChart.destroy();
            }

            // Solar data
            const times = ['1:53 PM', '3:05 PM', '3:55 PM'];
            const measuredIrradiance = [232, 182, 91];
            const power = [31.2, 22.1, 6.14];
            const temperature = [39.2, 35.6, 31.2];
            const humidity = [29, 34, 47];

            // Power vs Irradiance Chart
            const powerCtx = document.getElementById('solar-power-chart');
            if (powerCtx) {
                solarPowerChart = new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: measuredIrradiance,
                        datasets: [{
                            label: 'Power Output (W)',
                            data: power.map((p, i) => ({ x: measuredIrradiance[i], y: p })),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: 'rgb(34, 197, 94)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#9ca3af' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function(context) {
                                        return 'Power: ' + context.parsed.y + ' W at ' + context.parsed.x + ' W/m²';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Power Output (W)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Measured Irradiance (W/m²)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }

            // Temperature & Humidity Chart
            const tempCtx = document.getElementById('solar-temp-chart');
            if (tempCtx) {
                solarTempChart = new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [
                            {
                                label: 'Temperature (°C)',
                                data: temperature,
                                borderColor: 'rgb(249, 115, 22)',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                pointBackgroundColor: 'rgb(249, 115, 22)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Humidity (%)',
                                data: humidity,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#9ca3af' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Humidity (%)',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time',
                                    color: '#9ca3af'
                                },
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // WIND DATA DOWNLOAD FUNCTIONS
        // ============================================

        function downloadWindData(format) {
            const windTableData = [
                { speed: 5.5, rpmNoLoad: 109, rpmLoad: 66, voltNoLoad: 22.6, voltLoad: 8.6, currNoLoad: 0, currLoad: 44, powerNoLoad: 0, powerLoad: 0.38 },
                { speed: 4.5, rpmNoLoad: 85.6, rpmLoad: 55, voltNoLoad: 21.5, voltLoad: 8.16, currNoLoad: 0, currLoad: 19, powerNoLoad: 0, powerLoad: 0.15 },
                { speed: 3.5, rpmNoLoad: 68, rpmLoad: 52.5, voltNoLoad: 13.5, voltLoad: 7.90, currNoLoad: 0, currLoad: 9, powerNoLoad: 0, powerLoad: 0.07 },
                { speed: 3.0, rpmNoLoad: 52.5, rpmLoad: 46, voltNoLoad: 10.5, voltLoad: 7.70, currNoLoad: 0, currLoad: 3, powerNoLoad: 0, powerLoad: 0.03 },
                { speed: 2.5, rpmNoLoad: 35, rpmLoad: 30, voltNoLoad: 7, voltLoad: 6.50, currNoLoad: 0, currLoad: 1, powerNoLoad: 0, powerLoad: 0.006 }
            ];

            if (format === 'csv') {
                downloadWindCSV(windTableData);
            } else if (format === 'txt') {
                downloadWindTXT(windTableData);
            } else if (format === 'pdf') {
                downloadWindPDF(windTableData);
            }
        }

        function downloadWindCSV(data) {
            let csv = 'Wind Turbine Performance Data\n\n';
            csv += 'Wind Speed (m/s),RPM No Load,RPM Load,Voltage No Load (V),Voltage Load (V),Current No Load (mA),Current Load (mA),Power No Load (W),Power Load (W)\n';
            
            data.forEach(d => {
                csv += `${d.speed},${d.rpmNoLoad},${d.rpmLoad},${d.voltNoLoad},${d.voltLoad},${d.currNoLoad},${d.currLoad},${d.powerNoLoad},${d.powerLoad}\n`;
            });
            
            downloadFile(csv, 'wind-turbine-data.csv', 'text/csv');
        }

        function downloadWindTXT(data) {
            let txt = '═══════════════════════════════════════════════════════════════\n';
            txt += '           WIND TURBINE PERFORMANCE DATA REPORT\n';
            txt += '═══════════════════════════════════════════════════════════════\n\n';
            txt += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            txt += 'PERFORMANCE SUMMARY:\n';
            txt += '─'.repeat(65) + '\n';
            txt += `Max Wind Speed:        5.5 m/s\n`;
            txt += `Max RPM (No Load):     109 RPM\n`;
            txt += `Max Voltage (No Load): 22.6 V\n`;
            txt += `Max Power (Load):      0.38 W\n\n`;
            
            txt += 'DETAILED DATA:\n';
            txt += '─'.repeat(65) + '\n';
            txt += 'Speed | RPM(NL) | RPM(L) | V(NL) | V(L)  | I(NL) | I(L) | P(NL) | P(L)\n';
            txt += '(m/s) |         |        | (V)   | (V)   | (mA)  | (mA) | (W)   | (W)\n';
            txt += '─'.repeat(65) + '\n';
            
            data.forEach(d => {
                txt += `${d.speed.toString().padEnd(6)}| ${d.rpmNoLoad.toString().padEnd(8)}| ${d.rpmLoad.toString().padEnd(7)}| ${d.voltNoLoad.toString().padEnd(6)}| ${d.voltLoad.toString().padEnd(6)}| ${d.currNoLoad.toString().padEnd(6)}| ${d.currLoad.toString().padEnd(5)}| ${d.powerNoLoad.toString().padEnd(6)}| ${d.powerLoad}\n`;
            });
            
            txt += '\n' + '═'.repeat(65) + '\n';
            txt += 'Report generated by SolarGrid Monitoring Dashboard\n';
            
            downloadFile(txt, 'wind-turbine-report.txt', 'text/plain');
        }

        function downloadWindPDF(data) {
            // Generate text-based PDF content
            downloadWindTXT(data);
            alert('PDF-style report downloaded as TXT file.\n\nFor proper PDF, use your browser\'s Print → Save as PDF feature on this page.');
        }

        // ============================================
        // SOLAR DATA DOWNLOAD FUNCTIONS
        // ============================================

        function downloadSolarData(format) {
            const solarTableData = [
                { si: 1, time: '1:53 PM', forecastIrr: 545, measuredIrr: 232, voltage: 23.5, current: 2.4, power: 31.2, temp: 39.2, humidity: 29 },
                { si: 2, time: '3:05 PM', forecastIrr: 364, measuredIrr: 182, voltage: 23.0, current: 1.7, power: 22.1, temp: 35.6, humidity: 34 },
                { si: 3, time: '3:55 PM', forecastIrr: 152, measuredIrr: 91, voltage: 22.8, current: 0.5, power: 6.14, temp: 31.2, humidity: 47 }
            ];

            if (format === 'csv') {
                downloadSolarCSV(solarTableData);
            } else if (format === 'txt') {
                downloadSolarTXT(solarTableData);
            } else if (format === 'pdf') {
                downloadSolarPDF(solarTableData);
            }
        }

        function downloadSolarCSV(data) {
            let csv = 'Solar Panel Performance Data\n\n';
            csv += 'SI No,Time,Forecast Irradiance (W/m²),Measured Irradiance (W/m²),No Load Voltage (V),Load Current (A),Load Power (W),Temperature (°C),Humidity (%)\n';
            
            data.forEach(d => {
                csv += `${d.si},${d.time},${d.forecastIrr},${d.measuredIrr},${d.voltage},${d.current},${d.power},${d.temp},${d.humidity}\n`;
            });
            
            downloadFile(csv, 'solar-panel-data.csv', 'text/csv');
        }

        function downloadSolarTXT(data) {
            let txt = '═══════════════════════════════════════════════════════════════\n';
            txt += '           SOLAR PANEL PERFORMANCE DATA REPORT\n';
            txt += '═══════════════════════════════════════════════════════════════\n\n';
            txt += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            txt += 'PERFORMANCE SUMMARY:\n';
            txt += '─'.repeat(65) + '\n';
            txt += `Peak Power:            31.2 W\n`;
            txt += `Peak Irradiance:       232 W/m²\n`;
            txt += `Max Temperature:       39.2 °C\n`;
            txt += `Average Voltage:       23.1 V\n\n`;
            
            txt += 'DETAILED MEASUREMENTS:\n';
            txt += '─'.repeat(65) + '\n';
            txt += 'Time     | Irr(F) | Irr(M) | Volt | Curr | Power | Temp  | Hum\n';
            txt += '         | W/m²   | W/m²   | (V)  | (A)  | (W)   | (°C)  | (%)\n';
            txt += '─'.repeat(65) + '\n';
            
            data.forEach(d => {
                txt += `${d.time.padEnd(9)}| ${d.forecastIrr.toString().padEnd(7)}| ${d.measuredIrr.toString().padEnd(7)}| ${d.voltage.toString().padEnd(5)}| ${d.current.toString().padEnd(5)}| ${d.power.toString().padEnd(6)}| ${d.temp.toString().padEnd(6)}| ${d.humidity}\n`;
            });
            
            txt += '\n' + '═'.repeat(65) + '\n';
            txt += 'KEY INSIGHTS:\n';
            txt += '─'.repeat(65) + '\n';
            txt += '• Peak performance: 31.2W at 1:53 PM with 232 W/m² irradiance\n';
            txt += '• Power drops to 6.14W by 3:55 PM as irradiance decreases\n';
            txt += '• Higher temperatures (39.2°C) during peak irradiance\n';
            txt += '• Humidity increases from 29% to 47% as temperature drops\n\n';
            txt += '═'.repeat(65) + '\n';
            txt += 'Report generated by SolarGrid Monitoring Dashboard\n';
            
            downloadFile(txt, 'solar-panel-report.txt', 'text/plain');
        }

        function downloadSolarPDF(data) {
            // Generate text-based PDF content
            downloadSolarTXT(data);
            alert('PDF-style report downloaded as TXT file.\n\nFor proper PDF, use your browser\'s Print → Save as PDF feature on this page.');
        }

        // ==================== HISTORY TAB DOWNLOAD FUNCTIONS ====================
        
        function downloadHistoryCSV() {
            const data = getHistoricalData();
            if (!data || data.length === 0) {
                alert('No historical data available. Please select a time period first.');
                return;
            }
            
            let csv = 'Time,Power (kW),Voltage (V),Current (A),Frequency (Hz),Energy (kWh)\n';
            
            data.forEach(d => {
                csv += `${d.time},${d.power},${d.voltage},${d.current},${d.frequency || 50},${d.energy || 0}\n`;
            });
            
            // Add summary statistics
            const peak = document.getElementById('hist-peak')?.textContent || '--';
            const avg = document.getElementById('hist-avg')?.textContent || '--';
            const total = document.getElementById('hist-total')?.textContent || '--';
            const count = document.getElementById('hist-count')?.textContent || '--';
            
            csv += '\nSummary Statistics\n';
            csv += `Peak Power,${peak} kW\n`;
            csv += `Average Power,${avg} kW\n`;
            csv += `Total Energy,${total} kWh\n`;
            csv += `Data Points,${count}\n`;
            
            downloadFile(csv, 'power-history.csv', 'text/csv');
        }
        
        function downloadHistoryTXT() {
            const data = getHistoricalData();
            if (!data || data.length === 0) {
                alert('No historical data available. Please select a time period first.');
                return;
            }
            
            const peak = document.getElementById('hist-peak')?.textContent || '--';
            const avg = document.getElementById('hist-avg')?.textContent || '--';
            const total = document.getElementById('hist-total')?.textContent || '--';
            const count = document.getElementById('hist-count')?.textContent || '--';
            
            let txt = '╔' + '═'.repeat(78) + '╗\n';
            txt += '║' + ' SOLARGRID POWER GENERATION HISTORY REPORT'.padEnd(78) + '║\n';
            txt += '╚' + '═'.repeat(78) + '╝\n\n';
            
            txt += 'SUMMARY STATISTICS:\n';
            txt += '─'.repeat(80) + '\n';
            txt += `Peak Power:        ${peak} kW\n`;
            txt += `Average Power:     ${avg} kW\n`;
            txt += `Total Energy:      ${total} kWh\n`;
            txt += `Data Points:       ${count}\n\n`;
            
            txt += '═'.repeat(80) + '\n';
            txt += 'DETAILED POWER DATA:\n';
            txt += '═'.repeat(80) + '\n\n';
            txt += 'Time        | Power  | Voltage | Current | Frequency | Energy\n';
            txt += '            | (kW)   | (V)     | (A)     | (Hz)      | (kWh)\n';
            txt += '─'.repeat(80) + '\n';
            
            data.forEach(d => {
                const timeStr = d.time.padEnd(12);
                const powerStr = d.power.toString().padEnd(7);
                const voltageStr = d.voltage.toString().padEnd(8);
                const currentStr = d.current.toString().padEnd(8);
                const freqStr = (d.frequency || 50).toString().padEnd(10);
                const energyStr = (d.energy || 0).toString();
                txt += `${timeStr}| ${powerStr}| ${voltageStr}| ${currentStr}| ${freqStr}| ${energyStr}\n`;
            });
            
            txt += '\n' + '═'.repeat(80) + '\n';
            txt += 'Report generated by SolarGrid Monitoring Dashboard\n';
            txt += `Generated: ${new Date().toLocaleString()}\n`;
            
            downloadFile(txt, 'power-history.txt', 'text/plain');
        }
        
        function downloadHistoryPDF() {
            downloadHistoryTXT();
            alert('Historical data report downloaded as TXT file.\n\nFor PDF format, use your browser\'s Print → Save as PDF feature on the History tab.');
        }
        
        function getHistoricalData() {
            // Try to get data from the history table
            const table = document.getElementById('history-table');
            if (!table) return [];
            
            const rows = table.querySelectorAll('tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5 && cells[0].textContent !== 'Select a time period to view data') {
                    data.push({
                        time: cells[0].textContent.trim(),
                        power: parseFloat(cells[1].textContent) || 0,
                        voltage: parseFloat(cells[2].textContent) || 0,
                        current: parseFloat(cells[3].textContent) || 0,
                        frequency: parseFloat(cells[4].textContent) || 50,
                        energy: 0
                    });
                }
            });
            
            // If no table data, generate sample data from chart or localStorage
            if (data.length === 0 && window.powerChartData) {
                return window.powerChartData;
            }
            
            return data;
        }
        
        // ==================== REPORTS TAB DOWNLOAD FUNCTIONS ====================
        
        function downloadReportsCSV() {
            const period = window.currentReportPeriod || 'month';
            const data = generateReportData();
            
            let csv = `SolarGrid System Performance Report - ${period.toUpperCase()}\n`;
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Summary Statistics
            csv += 'Summary Statistics\n';
            csv += 'Metric,Value\n';
            csv += `Total Energy,${document.getElementById('report-total-energy')?.textContent || '--'} kWh\n`;
            csv += `Peak Power,${document.getElementById('report-peak-power')?.textContent || '--'} kW\n`;
            csv += `Cost Saved,৳${document.getElementById('report-cost-saved')?.textContent || '--'}\n`;
            csv += `System Health,${document.getElementById('report-health-score')?.textContent || '--'}%\n`;
            csv += `Average Power,${document.getElementById('report-avg-power')?.textContent || '--'} kW\n`;
            csv += `Efficiency Rating,${document.getElementById('report-efficiency')?.textContent || '--'}\n\n`;
            
            // Environmental Impact
            csv += 'Environmental Impact\n';
            csv += 'Metric,Value\n';
            csv += `CO2 Avoided,${document.getElementById('report-co2-avoided')?.textContent || '--'} kg\n`;
            csv += `Trees Equivalent,${document.getElementById('report-trees-equiv')?.textContent || '--'} trees\n`;
            csv += `Cars Off Road,${document.getElementById('report-cars-equiv')?.textContent || '--'} days\n`;
            csv += `Green Energy %,${document.getElementById('report-green-percent')?.textContent || '--'}\n`;
            
            downloadFile(csv, `solargrid-report-${period}.csv`, 'text/csv');
        }
        
        function downloadReportsTXT() {
            const period = window.currentReportPeriod || 'month';
            
            let txt = '╔' + '═'.repeat(78) + '╗\n';
            txt += '║' + ` SOLARGRID SYSTEM PERFORMANCE REPORT - ${period.toUpperCase()}`.padEnd(78) + '║\n';
            txt += '╚' + '═'.repeat(78) + '╝\n\n';
            txt += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Performance Summary
            txt += '═'.repeat(80) + '\n';
            txt += 'PERFORMANCE SUMMARY:\n';
            txt += '═'.repeat(80) + '\n';
            txt += `Total Energy Generated:  ${document.getElementById('report-total-energy')?.textContent || '--'} kWh\n`;
            txt += `Peak Power Output:       ${document.getElementById('report-peak-power')?.textContent || '--'} kW\n`;
            txt += `Average Power Output:    ${document.getElementById('report-avg-power')?.textContent || '--'} kW\n`;
            txt += `System Health Score:     ${document.getElementById('report-health-score')?.textContent || '--'}%\n`;
            txt += `Efficiency Rating:       ${document.getElementById('report-efficiency')?.textContent || '--'}\n`;
            txt += `Total Runtime:           ${document.getElementById('report-runtime')?.textContent || '--'}\n\n`;
            
            // Financial Savings
            txt += '═'.repeat(80) + '\n';
            txt += 'FINANCIAL SAVINGS:\n';
            txt += '═'.repeat(80) + '\n';
            txt += `Cost Saved:              ৳${document.getElementById('report-cost-saved')?.textContent || '--'}\n\n`;
            
            // Environmental Impact
            txt += '═'.repeat(80) + '\n';
            txt += 'ENVIRONMENTAL IMPACT:\n';
            txt += '═'.repeat(80) + '\n';
            txt += `CO2 Emissions Avoided:   ${document.getElementById('report-co2-avoided')?.textContent || '--'} kg\n`;
            txt += `Trees Equivalent:        ${document.getElementById('report-trees-equiv')?.textContent || '--'} trees\n`;
            txt += `Cars Off Road:           ${document.getElementById('report-cars-equiv')?.textContent || '--'} days\n`;
            txt += `Green Energy Percentage: ${document.getElementById('report-green-percent')?.textContent || '--'}\n\n`;
            
            txt += '═'.repeat(80) + '\n';
            txt += 'Report generated by SolarGrid Monitoring Dashboard\n';
            txt += 'For detailed analytics, visit the web dashboard\n';
            
            downloadFile(txt, `solargrid-report-${period}.txt`, 'text/plain');
        }
        
        function downloadReportsPDF() {
            downloadReportsTXT();
            alert('System report downloaded as TXT file.\n\nFor PDF format, use your browser\'s Print → Save as PDF feature on the Reports tab.');
        }
        
        function generateReportData() {
            // This function can be expanded to generate detailed report data
            return {
                period: window.currentReportPeriod || 'month',
                generated: new Date().toISOString()
            };
        }
        
        // ==================== ALERTS TAB DOWNLOAD FUNCTIONS ====================
        
        function downloadAlertsCSV() {
            const alerts = getAlertHistory();
            if (!alerts || alerts.length === 0) {
                alert('No alert history available to export.');
                return;
            }
            
            let csv = 'SolarGrid Alert History\n';
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            csv += 'Timestamp,Type,Severity,Message,Status\n';
            
            alerts.forEach(alert => {
                const timestamp = alert.timestamp || alert.time || new Date().toLocaleString();
                const type = alert.type || 'System';
                const severity = alert.severity || 'Info';
                const message = alert.message?.replace(/,/g, ';') || 'Alert';
                const status = alert.resolved ? 'Resolved' : 'Active';
                csv += `${timestamp},${type},${severity},${message},${status}\n`;
            });
            
            csv += `\nTotal Alerts: ${alerts.length}\n`;
            
            downloadFile(csv, 'alert-history.csv', 'text/csv');
        }
        
        function downloadAlertsTXT() {
            const alerts = getAlertHistory();
            if (!alerts || alerts.length === 0) {
                alert('No alert history available to export.');
                return;
            }
            
            let txt = '╔' + '═'.repeat(78) + '╗\n';
            txt += '║' + ' SOLARGRID ALERT HISTORY LOG'.padEnd(78) + '║\n';
            txt += '╚' + '═'.repeat(78) + '╝\n\n';
            txt += `Generated: ${new Date().toLocaleString()}\n`;
            txt += `Total Alerts: ${alerts.length}\n\n`;
            
            txt += '═'.repeat(80) + '\n';
            txt += 'ALERT LOG:\n';
            txt += '═'.repeat(80) + '\n\n';
            
            alerts.forEach((alert, index) => {
                const timestamp = alert.timestamp || alert.time || new Date().toLocaleString();
                const type = alert.type || 'System';
                const severity = alert.severity || 'Info';
                const message = alert.message || 'Alert';
                const status = alert.resolved ? 'RESOLVED' : 'ACTIVE';
                
                txt += `[${index + 1}] ${timestamp}\n`;
                txt += `    Type:     ${type}\n`;
                txt += `    Severity: ${severity}\n`;
                txt += `    Message:  ${message}\n`;
                txt += `    Status:   ${status}\n`;
                txt += '─'.repeat(80) + '\n\n';
            });
            
            // Alert Statistics
            const activeCount = alerts.filter(a => !a.resolved).length;
            const resolvedCount = alerts.filter(a => a.resolved).length;
            
            txt += '═'.repeat(80) + '\n';
            txt += 'ALERT STATISTICS:\n';
            txt += '═'.repeat(80) + '\n';
            txt += `Total Alerts:     ${alerts.length}\n`;
            txt += `Active Alerts:    ${activeCount}\n`;
            txt += `Resolved Alerts:  ${resolvedCount}\n\n`;
            
            txt += '═'.repeat(80) + '\n';
            txt += 'Report generated by SolarGrid Monitoring Dashboard\n';
            
            downloadFile(txt, 'alert-history.txt', 'text/plain');
        }
        
        function downloadAlertsPDF() {
            downloadAlertsTXT();
            alert('Alert history downloaded as TXT file.\n\nFor PDF format, use your browser\'s Print → Save as PDF feature on the Alerts tab.');
        }
        
        function getAlertHistory() {
            // Try to get alerts from localStorage
            const storedAlerts = localStorage.getItem('alertHistory');
            if (storedAlerts) {
                try {
                    return JSON.parse(storedAlerts);
                } catch (e) {
                    console.error('Error parsing alert history:', e);
                }
            }
            
            // Try to get from the alert history display
            const alertContainer = document.getElementById('alert-history');
            if (!alertContainer) return [];
            
            const alertElements = alertContainer.querySelectorAll('.bg-gray-700\\/30, .bg-red-900\\/30, .bg-yellow-900\\/30');
            const alerts = [];
            
            alertElements.forEach(elem => {
                const timeElem = elem.querySelector('.text-xs.text-gray-400');
                const messageElem = elem.querySelector('.text-white');
                const severityClass = elem.classList.contains('bg-red-900') ? 'Critical' : 
                                     elem.classList.contains('bg-yellow-900') ? 'Warning' : 'Info';
                
                if (messageElem) {
                    alerts.push({
                        timestamp: timeElem?.textContent || new Date().toLocaleString(),
                        message: messageElem.textContent,
                        severity: severityClass,
                        type: 'System',
                        resolved: false
                    });
                }
            });
            
            // If still no alerts, return sample data for demonstration
            if (alerts.length === 0) {
                return [];
            }
            
            return alerts;
        }

        // ==================== DATE RANGE FILTERING FUNCTIONS ====================
        
        // Load history by custom date range
        function loadHistoryByDateRange() {
            const startInput = document.getElementById('history-start-date');
            const endInput = document.getElementById('history-end-date');
            
            if (!startInput.value || !endInput.value) {
                alert('Please select both start and end dates.');
                return;
            }
            
            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);
            
            if (startDate >= endDate) {
                alert('End date must be after start date.');
                return;
            }
            
            const stored = localStorage.getItem('solarData');
            if (!stored) {
                alert('No historical data available yet. Data is being collected from your ESP32.');
                return;
            }
            
            const allData = JSON.parse(stored);
            
            // Filter data by date range
            const filteredData = allData.filter(d => {
                const dataDate = new Date(d.timestamp);
                return dataDate >= startDate && dataDate <= endDate;
            });
            
            if (filteredData.length === 0) {
                alert('No data available for the selected date range.');
                return;
            }
            
            // Update statistics
            const powers = filteredData.map(d => d.power);
            const peak = Math.max(...powers);
            const avg = powers.reduce((a, b) => a + b, 0) / powers.length;
            const totalEnergy = filteredData.length > 0 ? filteredData[filteredData.length - 1].energy : 0;
            
            document.getElementById('hist-peak').textContent = peak.toFixed(2);
            document.getElementById('hist-avg').textContent = avg.toFixed(2);
            document.getElementById('hist-total').textContent = totalEnergy.toFixed(2);
            document.getElementById('hist-count').textContent = filteredData.length;
            
            // Calculate period for chart display
            const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const period = daysDiff <= 1 ? '24h' : daysDiff <= 7 ? '7d' : daysDiff <= 30 ? '30d' : '365d';
            
            // Update chart
            displayChart(filteredData, period);
            
            // Update table (show last 20 entries)
            displayTable(filteredData.slice(-20).reverse());
            
            // Show success message
            const dateRange = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            console.log(`Loaded ${filteredData.length} data points for ${dateRange}`);
        }
        
        // Generate report by custom date range
        function generateReportByDateRange() {
            const startInput = document.getElementById('report-start-date');
            const endInput = document.getElementById('report-end-date');
            
            if (!startInput.value || !endInput.value) {
                alert('Please select both start and end dates.');
                return;
            }
            
            const startDate = new Date(startInput.value);
            const endDate = new Date(endInput.value);
            endDate.setHours(23, 59, 59, 999); // Include full end day
            
            if (startDate >= endDate) {
                alert('End date must be after start date.');
                return;
            }
            
            const stored = localStorage.getItem('solarData');
            if (!stored) {
                alert('No historical data available yet. Data is being collected from your ESP32.');
                return;
            }
            
            const allData = JSON.parse(stored);
            
            // Filter data by date range
            const filteredData = allData.filter(d => {
                const dataDate = new Date(d.timestamp);
                return dataDate >= startDate && dataDate <= endDate;
            });
            
            if (filteredData.length === 0) {
                alert('No data available for the selected date range.');
                return;
            }
            
            // Calculate statistics from filtered data
            const powers = filteredData.map(d => d.power);
            const voltages = filteredData.map(d => d.voltage);
            const currents = filteredData.map(d => d.current);
            
            const peakPower = Math.max(...powers);
            const avgPower = powers.reduce((a, b) => a + b, 0) / powers.length;
            const totalEnergy = filteredData.length > 0 ? filteredData[filteredData.length - 1].energy - filteredData[0].energy : 0;
            
            // Update UI with calculated values
            const dateRangeStr = `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
            
            document.getElementById('report-total-energy').textContent = totalEnergy.toFixed(2);
            document.getElementById('report-energy-period').textContent = dateRangeStr;
            
            document.getElementById('report-peak-power').textContent = peakPower.toFixed(2);
            const peakTime = filteredData[powers.indexOf(peakPower)]?.timestamp;
            if (peakTime) {
                document.getElementById('report-peak-time').textContent = new Date(peakTime).toLocaleString();
            }
            
            document.getElementById('report-avg-power').textContent = avgPower.toFixed(2);
            
            // Calculate cost savings (assuming ৳12 per kWh)
            const costSaved = (totalEnergy * 12).toFixed(0);
            document.getElementById('report-cost-saved').textContent = costSaved;
            document.getElementById('report-savings-info').textContent = `Based on ৳12/kWh rate`;
            
            // Calculate system health (based on data availability and consistency)
            const expectedPoints = (endDate - startDate) / (5000); // 5-second intervals
            const healthScore = Math.min(100, (filteredData.length / expectedPoints * 100)).toFixed(0);
            document.getElementById('report-health-score').textContent = healthScore;
            document.getElementById('report-health-status').textContent = healthScore > 80 ? 'Excellent' : healthScore > 60 ? 'Good' : 'Fair';
            
            // Calculate runtime hours
            const runtimeHours = (filteredData.length * 5 / 3600).toFixed(1); // 5-second intervals
            document.getElementById('report-runtime').textContent = `${runtimeHours} hours`;
            
            // Calculate efficiency (simplified)
            const efficiency = Math.min(100, avgPower / peakPower * 100).toFixed(0);
            document.getElementById('report-efficiency').textContent = `${efficiency}%`;
            
            // Environmental impact
            const co2Avoided = (totalEnergy * 0.82).toFixed(1); // 0.82 kg CO2 per kWh
            document.getElementById('report-co2-avoided').textContent = co2Avoided;
            
            const treesEquiv = (co2Avoided / 21.77).toFixed(1); // One tree absorbs ~21.77 kg CO2/year
            document.getElementById('report-trees-equiv').textContent = treesEquiv;
            
            const carsOffRoad = (co2Avoided / 4.6).toFixed(1); // Average car emits 4.6 kg CO2/day
            document.getElementById('report-cars-equiv').textContent = carsOffRoad;
            
            const greenPercent = 100; // Solar is 100% green
            document.getElementById('report-green-percent').textContent = `${greenPercent}%`;
            
            // Store period for download functions
            window.currentReportPeriod = `custom-${startDate.toISOString().split('T')[0]}-to-${endDate.toISOString().split('T')[0]}`;
            
            console.log(`Generated custom report for ${dateRangeStr} with ${filteredData.length} data points`);
        }
        
        // Reset chart zoom
        function resetChartZoom(chartId) {
            if (chartId === 'powerChart' && powerChart) {
                powerChart.resetZoom();
            }
        }
        
        // Initialize date inputs with default values
        function initializeDateInputs() {
            const now = new Date();
            const yesterday = new Date(now - 24 * 60 * 60 * 1000);
            
            // History tab - default to last 24 hours
            const historyStart = document.getElementById('history-start-date');
            const historyEnd = document.getElementById('history-end-date');
            if (historyStart && historyEnd) {
                historyStart.value = yesterday.toISOString().slice(0, 16);
                historyEnd.value = now.toISOString().slice(0, 16);
            }
            
            // Reports tab - default to this month
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const reportStart = document.getElementById('report-start-date');
            const reportEnd = document.getElementById('report-end-date');
            if (reportStart && reportEnd) {
                reportStart.value = firstDayOfMonth.toISOString().split('T')[0];
                reportEnd.value = now.toISOString().split('T')[0];
            }
        }
        
        // Call initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDateInputs);
        } else {
            initializeDateInputs();
        }

    </script>
</body>
</html>